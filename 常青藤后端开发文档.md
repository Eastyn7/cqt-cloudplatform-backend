# 常青藤志愿服务后端开发文档

> **当前版本**：v1.0（后端数据库与功能开发阶段）
>
> **编写日期**：2025-11-22
>
> **开发负责人**：Eastyn
>
> **数据库类型**：MySQL 8.0+
>
> **编码格式**：utf8mb4
>
> **运行环境**：Node.js **v20.19.5（推荐 LTS 20.x 及以上）**
>
> **技术栈**：Node.js + Express + TypeScript
>
> **文档用途**：记录后端的开发过程、数据库设计与接口实现细节，作为项目的开发文档与维护参考。

## 一、开发引言

### 1.1 开发背景

随着志愿服务在高校中的蓬勃发展，“小红帽”常青藤青年志愿者服务队（以下简称**青队**）逐渐成为学院内外各类公益活动的重要组织者。作为一个由热心青年学生组成的志愿队伍，青队成员在多个领域积极参与，展现了良好的精神风貌和社会责任感。为了提升内部管理效率与外部展示能力，青队决定建设一个**服务队云平台**，通过信息化手段强化组织凝聚力、提升沟通效率，并传播志愿精神。

常青藤校园后端系统主要负责用户认证、部门管理、成员管理及校园物品（如爱心雨伞）租借等业务逻辑的数据支撑。为保障系统的**扩展性、维护性**与**性能稳定性**，数据库设计遵循规范化设计原则，避免过度依赖外键约束，采用程序逻辑控制数据一致性。

### 1.2 技术目标

- 采用 RESTful API 设计；
- 使用 JWT 进行身份认证；
- 数据层解耦，无外键约束；
- 统一错误与日志处理；
- 兼容 ECharts、前端可视化展示；
- 可扩展的统计分析接口（供 Dashboard 使用）。

### 1.3 数据设计标准

- **符合第三范式（3NF）**，避免数据冗余；
- **禁止使用外键约束**，以逻辑层控制数据完整性；
- **统一命名规范与字段注释**；
- **时间字段标准化**（`created_at`, `updated_at`）；
- **索引合理设计**，优化查询性能。



## 二、数据库设计概览

| 序号                                          | 表名                                            | 功能说明         |
| ----------------------------------------------- | ---------------- | ---------------- |
| 1  | [`auth_login`](#3.1-auth_login-——-认证登录表)   | 用户认证登录信息 |
| 2 | [`auth_info`](#3.2-auth_info-——-用户基础资料表) | 用户基础资料     |
| 3 | [`departments`](#3.3-departments-——-部门信息表) | 部门信息表       |
| 4 | [`team_terms`](#3.4-team_terms-——-届次管理表) | 届次管理表 |
| 5 | [`backbone_members`](#3.5-backbone_members-——-骨干成员表) | 部门骨干成员信息|
| 6 | [`activities`](#3.6-activities-——-志愿活动记录表) | 志愿活动记录 |
| 7 | [`activity_participants`](#3.7-activity_participants-——-活动参与表) | 活动参与表  |
| 8 | [`honor_records`](#3.8-honor_records-——-荣誉与表彰记录表) | 荣誉与表彰记录 |
| 9 | [`announcements`](#3.9-announcements-——-公告与通知表) | 公告与通知 |
| 10 | [`gallery_photos`](#3.10-gallery_photos-——-团队相册/风采展示表) | 团队相册/风采展示表 |
| 11 | [`team_milestones`](#3.11-team_milestones-——-服务队发展历程表) | 服务队发展历程表 |
| 12 | [`operation_logs`](#3.12-operation_logs-——-系统操作日志表) | 系统操作日志表 |
| 13 | [`email_verification_codes`](#3.13-email_verification_codes-——-邮箱验证码记录表) | 邮箱验证码记录表 |



## 三、表结构与说明

### 3.1 `auth_login` —— 认证登录表

#### 功能说明

用于存储用户核心登录凭证信息，包括学号、邮箱、密码哈希与角色，用于认证和权限判断。

#### 表结构

```sql
CREATE TABLE `auth_login` (
  `auth_id` int NOT NULL AUTO_INCREMENT COMMENT '认证ID',
  `role` enum('user','admin','superadmin') NOT NULL DEFAULT 'user' COMMENT '用户角色',
    
  `student_id` varchar(20) NOT NULL COMMENT '学号/唯一账号',
  `email` varchar(100) NOT NULL COMMENT '邮箱（建议ctbu.edu.cn）',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希值',
    
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '账号创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    
  PRIMARY KEY (`auth_id`),
  UNIQUE KEY `unique_email` (`email`),
  UNIQUE KEY `unique_student_id` (`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='认证登录表';
```

#### 字段说明

| 字段名          | 数据类型                          | 是否必填           | 说明                         |
| --------------- | --------------------------------- | ------------------ | ---------------------------- |
| `auth_id`       | int                               | 是（PK，自增）     | 认证记录唯一标识             |
| `role`          | enum('user','admin','superadmin') | 是（默认：user）   | 用户角色                     |
| `student_id`    | varchar(20)                       | 是（唯一）         | 学号或唯一账号               |
| `email`         | varchar(100)                      | 是（唯一）         | 邮箱地址（使用 ctbu.edu.cn） |
| `password_hash` | varchar(255)                      | 是                 | 密码哈希值                   |
| `last_login_at` | datetime                          | 否                 | 最后登录时间                 |
| `created_at`    | datetime                          | 是（默认当前时间） | 账号创建时间                 |
| `updated_at`    | datetime                          | 是（自动更新）     | 记录最后更新时间             |

#### 开发说明

- 登录成功后应更新 `last_login_at`。
- 密码使用 bcrypt/argon2 加密存储。
- 推荐在注册成功后自动写入用户资料表（如 `auth_info`）。

### 3.2 `auth_info` —— 用户基础资料表

#### 功能说明

存储用户的基础档案信息，包括姓名、性别、学院、联系方式、头像等，用于系统中所有与“志愿者档案”相关的功能模块。

#### 表结构

```sql
CREATE TABLE `auth_info` (
  `info_id` int NOT NULL AUTO_INCREMENT COMMENT '用户资料ID',
  `student_id` varchar(20) NOT NULL COMMENT '学号，对应 auth_login.student_id',

  `name` varchar(20) NOT NULL COMMENT '姓名',
  `gender` enum('男','女','其他') DEFAULT NULL COMMENT '性别',
  `college` varchar(50) DEFAULT NULL COMMENT '学院',
  `major` varchar(50) DEFAULT NULL COMMENT '专业',
  `phone` varchar(20) DEFAULT NULL COMMENT '联系电话',

  `avatar_url` varchar(255) DEFAULT NULL COMMENT '头像URL（用于前端展示）',
  `avatar_key` varchar(255) DEFAULT NULL COMMENT '头像在OSS的Key（删除文件用）',

  `join_date` date DEFAULT NULL COMMENT '入队日期',
  `total_hours` decimal(6,1) DEFAULT 0 COMMENT '累计志愿时长（小时）',
  `skill_tags` varchar(255) DEFAULT NULL COMMENT '技能标签（JSON字符串）',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`info_id`),
  UNIQUE KEY `unique_student_id`(`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户基础资料表';
```

#### 字段说明

| 字段名        | 数据类型               | 是否必填           | 说明                               |
| ------------- | ---------------------- | ------------------ | ---------------------------------- |
| `info_id`     | int                    | 是（PK，自增）     | 用户资料唯一标识                   |
| `student_id`  | varchar(20)            | 是（唯一）         | 学号，对应 `auth_login.student_id` |
| `name`        | varchar(20)            | 是                 | 姓名                               |
| `gender`      | enum('男','女','其他') | 否                 | 性别                               |
| `college`     | varchar(50)            | 否                 | 学院                               |
| `major`       | varchar(50)            | 否                 | 专业                               |
| `phone`       | varchar(20)            | 否                 | 联系电话                           |
| `avatar_url`  | varchar(255)           | 否                 | 头像 URL（用于前端展示）           |
| `avatar_key`  | varchar(255)           | 否                 | 头像在 OSS 的 Key（用于删除文件）  |
| `join_date`   | date                   | 否                 | 入队日期                           |
| `total_hours` | decimal(6,1)           | 否（默认：0）      | 累计志愿时长（小时）               |
| `skill_tags`  | varchar(255)           | 否                 | 技能标签（JSON 字符串）            |
| `created_at`  | datetime               | 是（默认当前时间） | 创建时间                           |
| `updated_at`  | datetime               | 是（自动更新）     | 更新时间                           |

#### 开发说明

- 注册成功时系统自动创建对应资料记录；
- 若用户上传头像，需同时保存 `avatar_url` 和 `avatar_key`；
- `skill_tags` 建议存 JSON 字符串格式，如：`["摄影","讲解","协调"]`；
- 管理端可编辑学院、专业、联系方式等字段。

### 3.3 `departments` —— 部门信息表

#### 功能说明

存储服务队的部门组织结构（如宣传部、组织部、外联部、技术部等），用于成员分组、权限划分、活动组织管理以及前端部门列表的展示排序。

#### 表结构

~~~sql
CREATE TABLE `departments` (
  `dept_id` int NOT NULL AUTO_INCREMENT COMMENT '部门ID',
  `dept_name` varchar(50) NOT NULL COMMENT '部门名称',
  `description` varchar(255) DEFAULT NULL COMMENT '部门简介',
    
  `leader_id` varchar(20) DEFAULT NULL COMMENT '部门负责人学号，对应 auth_info.student_id',
  `manager_id` varchar(20) DEFAULT NULL COMMENT '队长负责人学号，对应 auth_info.student_id',
    
  `display_order` int DEFAULT '0' COMMENT '展示排序值（越大越靠前）',
    
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
  PRIMARY KEY (`dept_id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='部门信息表'
~~~

#### 字段说明

| 字段名        | 数据类型     | 是否必填           | 说明                                                         |
| ------------- | ------------ | ------------------ | ------------------------------------------------------------ |
| dept_id       | int          | 是（主键，自增）   | 部门唯一标识                                                 |
| dept_name     | varchar(50)  | 是                 | 部门名称，如“宣传部”“外联部”                                 |
| description   | varchar(255) | 否                 | 部门简介，用于前端展示或后台管理                             |
| leader_id     | varchar(20)  | 否                 | 当前部门的负责人（部门队长）学号，关联 auth_info.student_id  |
| manager_id    | varchar(20)  | 否                 | 该部门的上级负责人（通常为大队长、团支书或总负责人）学号，可管理多个部门 |
| display_order | int          | 否（默认0）        | 前端展示排序，值越大越靠前                                   |
| created_at    | datetime     | 是（默认当前时间） | 记录创建时间                                                 |
| updated_at    | datetime     | 是（自动更新）     | 记录最后更新时间                                             |

#### 开发说明

- 系统初始化时可预设固定部门；
- `leader_id` 建议在设置时检查是否存在于 `auth_info`；
- 后台可用于部门排序、负责人设置与数据统计。

### 3.4 `team_terms` —— 届次管理表

#### 功能说明

存储服务队各届的基本信息，包括届次名称、任期时间、当前届标识等，用于展示青队历届沿革与分届管理。

#### 表结构

```sql
CREATE TABLE `team_terms` (
  `term_id` int NOT NULL AUTO_INCREMENT COMMENT '届次ID',
  `term_name` varchar(20) NOT NULL COMMENT '届次名称，如“2024届”',

  `start_date` date DEFAULT NULL COMMENT '本届开始日期',
  `end_date` date DEFAULT NULL COMMENT '本届结束日期',
  `is_current` tinyint(1) DEFAULT 0 COMMENT '是否当前届（1=是）',

  `remark` varchar(255) DEFAULT NULL COMMENT '备注',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`term_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='届次管理表';
```

#### 字段说明

| 字段名       | 数据类型     | 是否必填           | 说明                 |
| ------------ | ------------ | ------------------ | -------------------- |
| `term_id`    | int          | 是（PK，自增）     | 届次唯一标识         |
| `term_name`  | varchar(20)  | 是                 | 届次名称，如“2024届” |
| `start_date` | date         | 否                 | 本届开始日期         |
| `end_date`   | date         | 否                 | 本届结束日期         |
| `is_current` | tinyint(1)   | 否（默认：0）      | 是否为当前届次：1=是 |
| `remark`     | varchar(255) | 否                 | 备注                 |
| `created_at` | datetime     | 是（默认当前时间） | 创建时间             |
| `updated_at` | datetime     | 是（自动更新）     | 更新时间             |

#### 开发说明

- 每次换届时新增一条记录；
- `is_current=1` 表示该届为当前届（可用于快速筛选）；
- 建议保持“历届信息不可删除”的策略；
- 常用于前端的历届队伍展示、组织发展时间轴等模块。

### 3.5 `backbone_members` —— 骨干成员表

#### 表功能

用于记录青队骨干成员（队长、部长、副部长、部员等）的任职信息，包括所属部门、届次、职务及任期，用于组织架构展示与历届管理。

#### 表结构

~~~sql
CREATE TABLE `backbone_members` (
  `member_id` int NOT NULL AUTO_INCREMENT COMMENT '骨干成员ID',
  `student_id` varchar(20) NOT NULL COMMENT '学号，对应 auth_info.student_id',
  `dept_id` int NOT NULL COMMENT '所属部门ID',
  `term_id` int NOT NULL COMMENT '所属届次ID',
  `position` enum('队长','部长','副部长','部员') DEFAULT '部员' COMMENT '职务',
    
  `photo_url` varchar(255) DEFAULT NULL COMMENT '成员展示照 URL',
  `photo_key` varchar(255) DEFAULT NULL COMMENT '展示照在 OSS 的 key（删除用）',
    
  `term_start` date DEFAULT NULL COMMENT '任期开始日期',
  `term_end` date DEFAULT NULL COMMENT '任期结束日期',
    
  `remark` varchar(255) DEFAULT NULL COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
  PRIMARY KEY (`member_id`),
  KEY `idx_term_id` (`term_id`),
  KEY `idx_dept_id` (`dept_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='骨干成员表';
~~~

#### 字段说明

| 字段名       | 数据类型                            | 是否必填           | 说明                              |
| ------------ | ----------------------------------- | ------------------ | --------------------------------- |
| `member_id`  | int                                 | 是（PK，自增）     | 骨干成员唯一标识                  |
| `student_id` | varchar(20)                         | 是                 | 学号，对应 `auth_info.student_id` |
| `dept_id`    | int                                 | 是                 | 所属部门 ID                       |
| `term_id`    | int                                 | 是                 | 所属届次 ID                       |
| `position`   | enum('队长','部长','副部长','部员') | 否（默认：部员）   | 成员职务                          |
| `photo_url`  | varchar(255)                        | 否                 | 成员展示照 URL                    |
| `photo_key`  | varchar(255)                        | 否                 | 展示照在 OSS 的 key（用于删除）   |
| `term_start` | date                                | 否                 | 任期开始日期                      |
| `term_end`   | date                                | 否                 | 任期结束日期                      |
| `remark`     | varchar(255)                        | 否                 | 备注                              |
| `created_at` | datetime                            | 是（默认当前时间） | 创建时间                          |
| `updated_at` | datetime                            | 是（自动更新）     | 更新时间                          |

#### 开发说明

- 成员信息按届次与部门管理，便于组织结构树展示；
- 历届数据均保留，用于组织沿革展示；
- 当前届成员可通过 `team_terms.is_current=1` 获取；
- 后端支持按部门、届次、多条件搜索；
- 不使用数据库外键，由应用层维护数据一致性。

### 3.6 `activities` —— 志愿活动记录表

#### 功能说明

用于记录服务队各类志愿活动的基础信息，包括活动名称、举办部门、时间、地点、内容简介及活动性质。为志愿者服务时长统计、活动展示、报名功能提供核心支撑。

#### 表结构

```sql
CREATE TABLE `activities` (
  `activity_id` int NOT NULL AUTO_INCREMENT COMMENT '活动ID',
  `activity_name` varchar(100) NOT NULL COMMENT '活动名称',
  `dept_id` int DEFAULT NULL COMMENT '主办部门ID',
  `term_id` int DEFAULT NULL COMMENT '所属届次ID',
  `category` varchar(50) DEFAULT NULL COMMENT '活动类型，如社会实践、支教、宣传等',

  `cover_url` varchar(255) DEFAULT NULL COMMENT '活动封面图 URL',
  `cover_key` varchar(255) DEFAULT NULL COMMENT '活动封面图 OSS key（删除用）',

  `recruitment_limit` int DEFAULT NULL COMMENT '招募人数上限',
  `service_hours` decimal(5,1) DEFAULT NULL COMMENT '志愿服务时长（小时）',
  `location` varchar(100) DEFAULT NULL COMMENT '活动地点',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `description` text COMMENT '活动简介',
  `status` enum('草稿','进行中','已结束') DEFAULT '草稿' COMMENT '活动状态',

  `created_by` varchar(10) DEFAULT NULL COMMENT '创建人学号',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`activity_id`),
  KEY `idx_dept_id` (`dept_id`),
  KEY `idx_term_id` (`term_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='志愿活动记录表';
```

#### 字段说明

| 字段名              | 数据类型                       | 是否必填           | 说明                                  |
| ------------------- | ------------------------------ | ------------------ | ------------------------------------- |
| `activity_id`       | int                            | 是（PK，自增）     | 活动唯一标识                          |
| `activity_name`     | varchar(100)                   | 是                 | 活动名称                              |
| `dept_id`           | int                            | 否                 | 主办部门 ID                           |
| `term_id`           | int                            | 否                 | 所属届次 ID                           |
| `category`          | varchar(50)                    | 否                 | 活动类型，如社会实践 / 支教 / 宣传等  |
| `cover_url`         | varchar(255)                   | 否                 | 活动封面图片 URL                      |
| `cover_key`         | varchar(255)                   | 否                 | 活动封面图在 OSS 的唯一 key，用于删除 |
| `recruitment_limit` | int                            | 否                 | 招募人数上限                          |
| `service_hours`     | decimal(5,1)                   | 否                 | 志愿服务时长（小时）                  |
| `location`          | varchar(100)                   | 否                 | 活动地点                              |
| `start_time`        | datetime                       | 否                 | 活动开始时间                          |
| `end_time`          | datetime                       | 否                 | 活动结束时间                          |
| `description`       | text                           | 否                 | 活动简介                              |
| `status`            | enum('草稿','进行中','已结束') | 否（默认：草稿）   | 活动状态                              |
| `created_by`        | varchar(10)                    | 否                 | 创建人学号                            |
| `created_at`        | datetime                       | 是（默认当前时间） | 创建时间                              |
| `updated_at`        | datetime                       | 是（自动更新）     | 更新时间                              |

#### 开发说明

- 活动发布后与报名表、服务时长表联动；
- 后端提供状态切换接口（如从“草稿”改为“进行中”）；
- 用于 Dashboard 活动统计与前端活动展示模块。

### 3.7 `activity_participants` —— 活动参与表

#### 功能说明

记录学生参与活动的明细信息，包括学号、活动ID、服务时长、角色、签到状态等。是志愿服务统计、个人档案时长累计的重要数据来源。

#### 表结构

```sql
CREATE TABLE `activity_participants` (
  `record_id` int NOT NULL AUTO_INCREMENT COMMENT '参与记录ID',
  `activity_id` int NOT NULL COMMENT '活动ID',
  `student_id` varchar(10) NOT NULL COMMENT '参与者学号',
  `role` varchar(50) DEFAULT '志愿者' COMMENT '活动角色（志愿者/负责人等）',
  `service_hours` decimal(5,1) DEFAULT 0 COMMENT '服务时长（小时）',
  `signed_in` tinyint(1) DEFAULT 0 COMMENT '是否签到（1=是，0=否）',
  `remark` varchar(255) DEFAULT NULL COMMENT '备注',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`record_id`),
  KEY `idx_activity_id`(`activity_id`),
  KEY `idx_student_id`(`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='活动参与表';
```

#### 字段说明

| 字段名          | 数据类型     | 是否必填           | 说明                                |
| --------------- | ------------ | ------------------ | ----------------------------------- |
| `record_id`     | int          | 是（PK，自增）     | 活动参与记录唯一标识                |
| `activity_id`   | int          | 是                 | 活动 ID                             |
| `student_id`    | varchar(10)  | 是                 | 参与者学号                          |
| `role`          | varchar(50)  | 否（默认：志愿者） | 在活动中的角色，如志愿者 / 负责人等 |
| `service_hours` | decimal(5,1) | 否（默认：0）      | 服务时长（小时，支持一位小数）      |
| `signed_in`     | tinyint(1)   | 否（默认：0）      | 是否签到：1=是，0=否                |
| `remark`        | varchar(255) | 否                 | 备注                                |
| `created_at`    | datetime     | 是（默认当前时间） | 记录创建时间                        |
| `updated_at`    | datetime     | 是（自动更新）     | 记录更新时间                        |

#### 开发说明

- 后端自动累计 `auth_info.total_hours`；
- 活动结束时系统计算服务时长；
- 可扩展导出为志愿服务证明材料。

### 3.8 `honor_records` —— 荣誉与表彰记录表

#### 功能说明

记录队伍或个人获得的荣誉、奖项、表彰信息，包括获奖时间、级别、颁发单位等。用于展示历届荣誉墙、个人荣誉档案。

#### 表结构

```sql
CREATE TABLE `honor_records` (
  `honor_id` int NOT NULL AUTO_INCREMENT COMMENT '荣誉ID',
  `student_id` varchar(10) DEFAULT NULL COMMENT '获奖者学号（可空）',
  `term_id` int DEFAULT NULL COMMENT '所属届次',
  `honor_title` varchar(100) NOT NULL COMMENT '荣誉名称',
  `honor_level` varchar(50) DEFAULT NULL COMMENT '荣誉级别，如校级/市级/国家级',
  `issue_date` date DEFAULT NULL COMMENT '颁发日期',
  `issuer` varchar(100) DEFAULT NULL COMMENT '颁发单位',
  `description` text DEFAULT NULL COMMENT '荣誉描述',

  `certificate_url` varchar(255) DEFAULT NULL COMMENT '荣誉证书照片 URL',
  `certificate_key` varchar(255) DEFAULT NULL COMMENT '证书照片 OSS key（删除用）',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`honor_id`),
  KEY `idx_student_id`(`student_id`),
  KEY `idx_term_id`(`term_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='荣誉与表彰记录表';
```

#### 字段说明

| 字段名            | 数据类型     | 是否必填           | 说明                             |
| ----------------- | ------------ | ------------------ | -------------------------------- |
| `honor_id`        | int          | 是（PK，自增）     | 荣誉记录唯一标识                 |
| `student_id`      | varchar(10)  | 否                 | 获奖者学号（可为空）             |
| `term_id`         | int          | 否                 | 所属届次 ID                      |
| `honor_title`     | varchar(100) | 是                 | 荣誉名称                         |
| `honor_level`     | varchar(50)  | 否                 | 荣誉级别，如校级 / 市级 / 国家级 |
| `issue_date`      | date         | 否                 | 颁发日期                         |
| `issuer`          | varchar(100) | 否                 | 颁发单位                         |
| `description`     | text         | 否                 | 荣誉描述                         |
| `certificate_url` | varchar(255) | 否                 | 荣誉证书照片 URL                 |
| `certificate_key` | varchar(255) | 否                 | 证书照片 OSS key（用于删除）     |
| `created_at`      | datetime     | 是（默认当前时间） | 创建时间                         |
| `updated_at`      | datetime     | 是（自动更新）     | 更新时间                         |

#### 开发说明

- 支持录入个人或集体荣誉；
- 前端展示“历届荣誉墙”；
- 可与届次表结合展示“历届成绩”；
- 无外键约束，逻辑层控制。

### 3.9 `announcements` —— 公告与通知表

#### 功能说明

存储服务队发布的通知、新闻、内部公告等信息，用于门户与后台通知管理。

#### 表结构

```sql
CREATE TABLE `announcements` (
  `announcement_id` int NOT NULL AUTO_INCREMENT COMMENT '公告ID',
  `title` varchar(100) NOT NULL COMMENT '标题',
  `content` text NOT NULL COMMENT '正文内容',
  `author_id` varchar(10) DEFAULT NULL COMMENT '发布人学号',
  `term_id` int DEFAULT NULL COMMENT '所属届次',
  `publish_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '发布时间',
  `status` enum('草稿','已发布','归档') DEFAULT '草稿' COMMENT '状态',

  `file_url` varchar(500) DEFAULT NULL COMMENT '公告文件访问URL',
  `file_key` varchar(500) DEFAULT NULL COMMENT 'OSS存储路径（objectKey）',
  `file_type` enum('none','pdf','word') DEFAULT 'none' COMMENT '附件类型',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`announcement_id`),
  KEY `idx_term_id`(`term_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='公告与通知表';
```

#### 字段说明

| 字段名            | 数据类型                     | 是否必填           | 说明                           |
| ----------------- | ---------------------------- | ------------------ | ------------------------------ |
| `announcement_id` | int                          | 是（PK，自增）     | 公告唯一标识                   |
| `title`           | varchar(100)                 | 是                 | 公告标题                       |
| `content`         | text                         | 是                 | 公告正文内容                   |
| `author_id`       | varchar(10)                  | 否                 | 发布人学号                     |
| `term_id`         | int                          | 否                 | 所属届次 ID                    |
| `publish_time`    | datetime                     | 否（默认当前时间） | 发布时间                       |
| `status`          | enum('草稿','已发布','归档') | 否（默认：草稿）   | 公告状态：草稿 / 已发布 / 归档 |
| `file_url`        | varchar(500)                 | 否                 | 公告附件访问 URL               |
| `file_key`        | varchar(500)                 | 否                 | 公告附件在 OSS 中的 objectKey  |
| `file_type`       | enum('none','pdf','word')    | 否（默认：none）   | 附件类型：none / pdf / word    |
| `created_at`      | datetime                     | 是（默认当前时间） | 创建时间                       |
| `updated_at`      | datetime                     | 是（自动更新）     | 更新时间                       |

#### 开发说明

- 可支持富文本编辑；
- 公告与届次绑定，可展示不同届的新闻；
- 归档状态用于历史记录保存。

### 3.10 `gallery_photos` —— 团队相册/风采展示表

#### 功能说明

用于存储团队活动、会议、日常风采展示等图片资料。可用于官网前端展示模块、后台风采管理、大屏端相册轮播等场景。支持按 **届次、活动、时间、上传人** 进行筛选。支持 **OSS 文件管理机制**（保留 `image_key` 以便同步删除 OSS 文件）。

#### 表结构

```sql
CREATE TABLE `gallery_photos` (
  `photo_id` int NOT NULL AUTO_INCREMENT COMMENT '照片ID',
  `term_id` int DEFAULT NULL COMMENT '所属届次ID',
  `activity_id` int DEFAULT NULL COMMENT '关联活动ID',
  `title` varchar(100) DEFAULT NULL COMMENT '照片标题',
  `image_url` varchar(255) NOT NULL COMMENT '图片访问URL（前端可直接访问）',
  `image_key` varchar(255) NOT NULL COMMENT '图片在 OSS 内的唯一 Key，用于删除',
  `description` varchar(255) DEFAULT NULL COMMENT '照片描述',
  `uploaded_by` varchar(20) DEFAULT NULL COMMENT '上传人（学号或工号）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `sort_order` int DEFAULT 0 COMMENT '排序值，用于前端展示顺序控制',

  PRIMARY KEY (`photo_id`),
  KEY `idx_term` (`term_id`),
  KEY `idx_activity` (`activity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='团队相册/风采展示表';
```

#### 字段说明

| 字段名        | 数据类型     | 是否必填           | 说明                              |
| ------------- | ------------ | ------------------ | --------------------------------- |
| `photo_id`    | int          | 是（PK，自增）     | 照片唯一标识                      |
| `term_id`     | int          | 否                 | 所属届次 ID                       |
| `activity_id` | int          | 否                 | 关联的活动 ID                     |
| `title`       | varchar(100) | 否                 | 照片标题                          |
| `image_url`   | varchar(255) | 是                 | 图片可直接访问的 URL              |
| `image_key`   | varchar(255) | 是                 | 图片在 OSS 上的唯一 Key，用于删除 |
| `description` | varchar(255) | 否                 | 照片描述                          |
| `uploaded_by` | varchar(20)  | 否                 | 上传人账号（学号或工号）          |
| `uploaded_at` | datetime     | 是（默认当前时间） | 上传时间                          |
| `sort_order`  | int          | 否（默认 0）       | 排序值，用于前端展示顺序控制      |

#### 开发说明

- 添加/删除图片时应同时维护 OSS 文件（使用 `image_key` 操作）。
- 可按届次、活动进行筛选查询。
- `sort_order` 可用于前端自定义展示顺序。

### 3.11 `team_milestones` —— 服务队发展历程表

#### 功能说明

记录服务队在不同届次发展中的重要节点与里程碑事件，如成立仪式、重要活动、荣誉表彰、制度建设等内容。该表为前端“发展历程时间轴（Timeline）”“历届成果展示”提供核心数据支撑。通过与届次表 `team_terms` 关联，可区分各届的事件归属，实现按届次或时间顺序展示团队成长轨迹。

#### 表结构

```sql
CREATE TABLE `team_milestones` (
  `milestone_id` int NOT NULL AUTO_INCREMENT COMMENT '里程碑事件ID',
  `term_id` int DEFAULT NULL COMMENT '关联届次ID，对应team_terms.term_id',
  `title` varchar(100) NOT NULL COMMENT '事件标题',
  `description` text DEFAULT NULL COMMENT '事件详细描述',
  `event_date` date NOT NULL COMMENT '事件日期',
  `event_type` varchar(50) DEFAULT NULL COMMENT '事件类型，如荣誉/组织/活动/制度建设等',
    
  `image_url` varchar(255) DEFAULT NULL COMMENT '事件展示图片URL',
  `image_key` varchar(255) DEFAULT NULL COMMENT 'OSS 图片唯一 Key，用于删除',

  `created_by` varchar(20) DEFAULT NULL COMMENT '创建人账号（学号/工号）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
  PRIMARY KEY (`milestone_id`),
  INDEX `idx_term_id`(`term_id`),
  INDEX `idx_event_date`(`event_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='服务队发展历程表';
```

#### 字段说明

| 字段名         | 数据类型     | 是否必填           | 说明                                          |
| -------------- | ------------ | ------------------ | --------------------------------------------- |
| `milestone_id` | int          | 是（PK，自增）     | 里程碑事件唯一标识                            |
| `term_id`      | int          | 否                 | 关联届次 ID，对应 `team_terms.term_id`        |
| `title`        | varchar(100) | 是                 | 事件标题                                      |
| `description`  | text         | 否                 | 事件详细描述                                  |
| `event_date`   | date         | 是                 | 事件发生日期                                  |
| `event_type`   | varchar(50)  | 否                 | 事件类型，如：荣誉 / 组织 / 活动 / 制度建设等 |
| `image_url`    | varchar(255) | 否                 | 事件展示图片的外链 URL                        |
| `image_key`    | varchar(255) | 否                 | OSS 图片存储 objectKey，用于删除              |
| `created_by`   | varchar(20)  | 否                 | 创建人账号（学号或工号）                      |
| `created_at`   | datetime     | 是（默认当前时间） | 创建时间                                      |
| `updated_at`   | datetime     | 是（自动更新）     | 更新时间                                      |

#### 开发说明

- **数据维护：**
  - 管理端可新增、编辑、删除里程碑事件。
  - 可按届次、事件类型、时间范围筛选展示。
  - 支持图片上传作为时间轴可视化节点展示封面。
- **前端展示：**
  - **模式① 时间轴模式（Timeline）**：按 `event_date` 升序排序展示发展历程。
  - **模式② 届次模式**：按 `term_id` 分组展示每一届的重要事件。
  - **模式③ 分类模式**：可过滤出特定类型（如“荣誉”或“活动”）事件，形成专题展示页。
- **逻辑关联：**
  - 若 `term_id` 为空，表示全局事件（例如“青队正式成立”）。
  - 若 `term_id` 有值，则表示该事件属于某一届。

#### 示例数据

| milestone_id | term_id | title                  | event_date | event_type | description                                      |
| ------------ | ------- | ---------------------- | ---------- | ---------- | ------------------------------------------------ |
| 1            | NULL    | 青队正式成立           | 2020-09-10 | 组织       | 常青藤青年志愿服务队正式成立，隶属于学院团委。   |
| 2            | 3       | 获评“优秀志愿服务团队” | 2023-12-20 | 荣誉       | 第三届青队在校级评选中获“优秀志愿服务团队”称号。 |
| 3            | 4       | 举办校外公益宣讲活动   | 2024-05-08 | 活动       | 与市文明办联合举办“青春向善”主题志愿宣讲活动。   |

### 3.12 `operation_logs` —— 系统操作日志表

#### 功能说明

用于记录系统中用户的关键操作行为，包括登录、数据增删改、审核、发布、导出等。该表为后期系统安全审计、问题追踪、行为统计提供数据依据。

#### 表结构

```sql
CREATE TABLE `operation_logs` (
  `log_id` int NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` varchar(10) NOT NULL COMMENT '操作者学号，对应auth_info.student_id',
    
  `action` varchar(100) NOT NULL COMMENT '操作动作，如login、create_activity、update_member等',
  `target_table` varchar(50) DEFAULT NULL COMMENT '被操作的表名',
  `target_id` varchar(50) DEFAULT NULL COMMENT '被操作数据的主键值',
  `description` varchar(255) DEFAULT NULL COMMENT '操作描述或备注',
  `ip_address` varchar(45) DEFAULT NULL COMMENT '操作者IP地址',
  `user_agent` varchar(255) DEFAULT NULL COMMENT '操作终端信息（浏览器、设备等）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
    
  PRIMARY KEY (`log_id`),
  INDEX `idx_user_id`(`user_id`),
  INDEX `idx_action`(`action`),
  INDEX `idx_created_at`(`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='系统操作日志表';
```

#### 字段说明

| 字段名         | 数据类型     | 是否必填           | 说明                                                     |
| -------------- | ------------ | ------------------ | -------------------------------------------------------- |
| `log_id`       | int          | 是（PK，自增）     | 日志唯一标识                                             |
| `user_id`      | varchar(10)  | 是                 | 操作者学号，对应 `auth_info.student_id`                  |
| `action`       | varchar(100) | 是                 | 操作动作，如：login / create_activity / update_member 等 |
| `target_table` | varchar(50)  | 否                 | 被操作的表名                                             |
| `target_id`    | varchar(50)  | 否                 | 被操作数据的主键值                                       |
| `description`  | varchar(255) | 否                 | 操作描述或备注                                           |
| `ip_address`   | varchar(45)  | 否                 | 操作者 IP 地址                                           |
| `user_agent`   | varchar(255) | 否                 | 操作终端信息（浏览器、设备等）                           |
| `created_at`   | datetime     | 是（默认当前时间） | 操作时间                                                 |

#### 开发说明

- 日志在关键操作（如登录、审批、删除、发布）时由系统自动写入；
- 可通过管理端按用户、日期、行为类型过滤查询；
- 后期可扩展导出功能，用于审计或统计分析；
- 不建立外键约束，以保持写入性能与独立性；
- 推荐在后端封装统一日志写入中间件（如 `log_action(user_id, action, target_table, target_id, desc)`）。

### 3.13 `email_verification_codes` —— 邮箱验证码记录表

#### 功能说明

用于存储用户注册、密码找回、邮箱绑定等操作时发送的验证码信息。系统通过此表验证验证码有效性、防止重复发送，并支持后期扩展多种验证码用途。该表主要承担短期数据存储功能，便于后端在用户验证环节中进行比对与过期判断。

#### 表结构

~~~sql
CREATE TABLE `email_verification_codes` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键ID（自增）',
    
  `email` varchar(100) NOT NULL COMMENT '收件人邮箱地址（唯一标识每个验证码发送对象）',
  `code` varchar(10) NOT NULL COMMENT '验证码内容（通常为6位数字或字母）',
  `type` varchar(20) DEFAULT 'register' COMMENT '验证码类型（register=注册，reset_password=重置密码等）',
  `expires_at` datetime NOT NULL COMMENT '验证码过期时间（一般为创建后5分钟）',
  `verified` tinyint(1) DEFAULT '0' COMMENT '是否已验证（0=未验证，1=已验证）',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间（记录发送时间）',
    
  PRIMARY KEY (`id`),
  KEY `idx_email` (`email`) COMMENT '邮箱索引，用于快速查询最近验证码记录'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='邮箱验证码记录表';
~~~

#### 字段说明

| 字段名       | 数据类型     | 是否必填             | 说明                                                 |
| ------------ | ------------ | -------------------- | ---------------------------------------------------- |
| `id`         | int          | 是（PK，自增）       | 主键ID（自增）                                       |
| `email`      | varchar(100) | 是                   | 收件人邮箱地址，用于标识验证码来源（支持唯一性查询） |
| `code`       | varchar(10)  | 是                   | 验证码内容（一般为 6 位数字或字母）                  |
| `type`       | varchar(20)  | 否（默认：register） | 验证码类型：register / reset_password 等             |
| `expires_at` | datetime     | 是                   | 验证码过期时间（通常为创建后 5 分钟）                |
| `verified`   | tinyint(1)   | 否（默认：0）        | 是否已验证：0=未验证，1=已验证                       |
| `created_at` | datetime     | 否（默认当前时间）   | 创建时间（即验证码发送时间）                         |

#### 开发说明

- **验证码发送逻辑：**

  每次发送时生成随机验证码，写入数据库，并设置过期时间（如2分钟）；

  同时检查该邮箱最近一次未过期验证码，防止频繁发送。

- **验证码验证逻辑：**

  用户提交邮箱与验证码后，系统从数据库查找最新记录：

  - 若验证码已过期 → 返回错误并删除或标记失效；
  - 若验证码匹配成功 → 更新 `verified=1`，验证通过。

- **清理策略：**

  可定期（如每日凌晨）清理已过期或已验证的记录，保持表轻量化。

- **设计原则：**

  - 不建立外键约束，提高写入性能；
  - 支持多类型验证码扩展；
  - 可迁移至 Redis 缓存方案以提升性能。



## 四、后端项目初始化

#### 4.1 项目初始化

4.1.1 初始化Node项目

在项目根目录下执行以下命令，初始化一个新的Node.js项目：

~~~bash
npm init -y
~~~

该命令会生成 `package.json` 文件，用于记录依赖包和脚本命令。

4.1.2 安装Express框架

安装后端核心框架Express：

~~~bash
npm install express
~~~

4.1.3 安装TypeScript及类型依赖

Express是基于Node.js的，因此我们需要为TypeScript项目安装类型支持包：

~~~bash
npm install typescript ts-node @types/node @types/express --save-dev
~~~

4.1.4 初始化TypeScript配置文件

执行命令生成`tsconfig.json`：

~~~bash
npx tsc --init
~~~

修改`tsconfig.json`，设置输入输出目录：

~~~json
{
  "compilerOptions": {
    "target": "es2016",
    "module": "commonjs",
    "rootDir": "./src",
    "outDir": "./dist",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
~~~

4.1.5 创建基础目录结构

项目文件夹加以结构如下：

~~~bash
backend/
├── src/
│   ├── controllers/     # 控制器：处理请求和响应
│   ├── db/              # 数据库连接与操作
│   ├── middlewares/     # 中间件：认证、日志、错误处理
│   ├── oss/             # OSS 文件存储服务：封装上传、删除、签名等逻辑
│   ├── routers/         # 路由定义：分模块管理
│   ├── services/        # 服务层：业务逻辑与数据库交互
│   ├── types/           # 类型定义文件（TS类型接口）
│   ├── utils/           # 工具函数：通用工具（格式化、响应封装、日志等）
│   ├── validators/      # 请求体路由校验中间件
│   └── app.ts           # 应用主入口文件（注册中间件、加载路由）
├── .env                 # 环境变量配置文件（数据库、OSS 等敏感信息）
├── .gitignore           # Git 忽略配置
├── package.json         # 项目依赖与脚本配置
├── tsconfig.json        # TypeScript 编译配置
└── README.md            # 项目说明文档
~~~

#### 4.2 环境于基础配置

4.2.1 配置`.env`文件

用于存放环境变量（如数据库连接信息、端口等）：

~~~bash
# ===============================
# 🗄️ 数据库配置 (MySQL)
# ===============================
DB_HOST=                          # 数据库主机地址
DB_PORT=                          # 数据库端口（默认 3306）
DB_USER=                          # 数据库用户名
DB_PASSWORD=                      # 数据库密码（⚠️生产环境务必修改）
DB_NAME=                          # 数据库名
DB_CONNECTION_LIMIT=              # 数据库连接池最大连接数

# ===============================
# 🌐 服务运行配置
# ===============================
PORT=                             # 后端服务端口
NODE_ENV=                         # 运行环境：development / production / test
BASE_URL=                         # 服务基础 URL（前端可用）

# ===============================
# 🌐 跨域白名单（多个域用逗号隔开）
# ===============================
CORS_ORIGINS=                     # 跨域允许的域名，多个用逗号分隔

# ===============================
# 🔒 JWT 鉴权配置
# ===============================
JWT_SECRET=                       # JWT 密钥（建议 32 位以上随机字符串）
JWT_EXPIRES_IN=                   # Token 过期时间，例如：7d / 12h

# ===============================
# ☁️ OSS 对象存储配置 (阿里云)
# ===============================
OSS_REGION=                       # OSS 地域（如 oss-cn-chengdu）
OSS_ACCESS_KEY_ID=                # 阿里云 AccessKey ID
OSS_ACCESS_KEY_SECRET=            # 阿里云 AccessKey Secret
OSS_BUCKET=                       # OSS 存储桶名称
OSS_BASE_URL=                     # OSS 访问基础 URL
OSS_UPLOAD_DIR=                   # 默认上传路径前缀（如 uploads/）

# ===============================
# 📦 日志与调试配置
# ===============================
LOG_LEVEL=                        # 日志级别：error / warn / info / debug
ENABLE_REQUEST_LOG=               # 是否打印每次请求日志（开发建议开启）
ENABLE_SQL_LOG=                   # 是否打印 SQL 执行语句（开发建议开启）
LOG_DIR=                          # 本地日志存储目录
LOG_MAX_SIZE=                     # 单个日志文件最大体积（如 5m）
LOG_MAX_FILES=                    # 保留日志文件时长（如 30d）
METRICS_FLUSH_INTERVAL_MS=        # 性能统计输出间隔，默认5分钟（300000ms）

# ===============================
# 📧 邮件服务配置 (用于验证码、通知)
# ===============================
SMTP_HOST=                        # SMTP 服务器地址（如 smtp.163.com）
SMTP_PORT=                        # SMTP 服务器端口（如 465）
SMTP_USER=                        # 邮箱账号
SMTP_PASS=                        # ⚠️ 邮箱授权码（非登录密码）
MAIL_FROM_NAME=                   # 邮件发送者名称
~~~

> ✅ **注意**：`.env`文件不要上传到 Git 仓库，以防泄露敏感信息。

4.2.2 配置`.gitignore`文件

在根目录创建`.gitignore`文件：

~~~bash
# ===============================
# 📦 Node.js & TypeScript 基础
# ===============================
node_modules/                    # 依赖文件夹
dist/                            # 编译输出目录
build/                           # 构建产物（如前端打包输出）
coverage/                        # 测试覆盖率报告
.cache/                          # 缓存文件（如 Babel、ts-loader）
*.tsbuildinfo                    # TypeScript 增量编译信息文件

# ===============================
# 🔐 环境与配置
# ===============================
.env                             # 本地环境变量文件（真实密钥）
.env.*                           # 各环境配置（如 .env.prod、.env.dev）
*.local                          # 本地配置文件（避免上传）

# ===============================
# 🧾 日志文件
# ===============================
*.log                            # 通用日志文件
logs/                            # 日志文件夹
npm-debug.log*                   # npm 调试日志
yarn-debug.log*                  # yarn 调试日志
yarn-error.log*                  # yarn 错误日志
pnpm-debug.log*                  # pnpm 调试日志

# ===============================
# 💻 IDE / 编辑器配置
# ===============================
.vscode/                         # VS Code 项目配置
.idea/                           # JetBrains 系列（WebStorm等）
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.DS_Store                        # macOS 系统文件
Thumbs.db                        # Windows 缩略图缓存
desktop.ini                      # Windows 桌面配置文件

# ===============================
# 🗄️ Git & 临时文件
# ===============================
.git/                            # Git 仓库文件（不要上传仓库内部文件）
.gitignore                       # 此文件自身（一般保留）
*.bak                            # 备份文件
*.tmp                            # 临时文件
~$*                              # 临时锁文件（如 Word、Excel）
*.pid                            # 进程标识文件
*.seed                           # 随机种子文件（测试数据）

# ===============================
# ☁️ OSS / 上传 / 资源缓存
# ===============================
uploads/                         # 上传临时目录（本地存储文件）
temp/                            # 临时缓存目录
.tmp/                            # OSS 临时缓存目录
public/uploads/                  # 若前端本地存储上传图片
*.oss-cache                      # OSS SDK 缓存（如多分片上传）

# ===============================
# 🧪 测试 / CI / 工具输出
# ===============================
jest-html-reporters-*.html       # Jest 报告
test-output/
reports/
coverage-final.json
.nyc_output/
.cypress/
.playwright/
.Dockerfile.swp                  # 临时 Docker 编辑文件
docker-compose.override.yml      # 本地调试 docker-compose

# ===============================
# 🔧 包管理器 / 锁文件（视团队策略）
# ===============================
package-lock.json                # npm 锁文件（若团队用 yarn/pnpm 可忽略）
yarn.lock                        # yarn 锁文件（若团队用 npm 可忽略）
pnpm-lock.yaml                   # pnpm 锁文件（根据实际选择是否忽略）
~~~

#### 4.3 项目启动文件

4.3.1 创建`src/app.ts`

项目主入口文件，注册中间件与路由。

```ts
import express from 'express'
import cors from 'cors'

const app = express()

// 中间件
app.use(cors())
app.use(express.json())
app.use(express.urlencoded({ extended: false }))

// 路由导入（稍后创建 routers/index.ts）
import router from './routers'
app.use('/api', router)

// 启动服务
app.listen(3007, () => {
  console.log('✅ API server running at http://127.0.0.1:3007')
})

export default app
```

#### 4.4 项目模块说明

4.4.1 `controllers/`

> 存放控制器文件，负责处理请求和响应逻辑。

示例：`controllers/userController.ts`

```ts
import { Request, Response } from 'express'
import * as userService from '../services/userService'

export const getAllUsers = async (req: Request, res: Response) => {
  const users = await userService.getUsers()
  res.json({ code: 200, data: users })
}
```

4.4.2 `services/`

> 负责业务逻辑和数据库交互。

示例：`services/userService.ts`

```ts
import db from '../db'

export const getUsers = async () => {
  const [rows] = await db.query('SELECT * FROM auth_info')
  return rows
}
```

4.4.3 `db/`

> 管理数据库连接。

创建 `db/index.ts`：

```ts
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

const pool = mysql.createPool({
  host: process.env.DB_HOST,
  port: Number(process.env.DB_PORT) || 3306,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  connectionLimit: Number(process.env.DB_CONNECTION_LIMIT) || 10,
  charset: 'utf8mb4',
  multipleStatements: false
});

// ✅ 测试连接
export const checkDatabaseConnection = async () => {
  try {
    const connection = await pool.getConnection();
    console.log('✅ 数据库连接成功');
    connection.release();
  } catch (err: any) {
    console.error('❌ 数据库连接失败:', err.message);
    process.exit(1);
  }
};

// ✅ 封装通用查询函数
export const query = async <T = any>(sql: string, values?: any): Promise<T> => {
  try {
    if (process.env.ENABLE_SQL_LOG === 'true') console.log('🧩 SQL:', sql);
    const [rows] = await pool.query(sql, values);
    return rows as T;
  } catch (error) {
    console.error('❌ SQL 执行错误:', error);
    throw error;
  }
};

export default pool;
```

4.4.4 `middlewares/`

> 公共中间件，如认证、错误处理、请求日志等。

示例：`middlewares/errorMiddleware.ts`

```ts
import { Request, Response, NextFunction } from 'express'

export const errorHandler = (
  err: any,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  console.error('❌ Error:', err.message)
  res.status(500).json({ code: 500, message: err.message })
}
```

4.4.5 `oss/`

> 封装对象存储服务（OSS）的连接与文件操作逻辑，用于图片、文件等资源的上传、下载、删除及签名访问。

示例：`src/oss/index.ts`

```ts
import OSS from 'ali-oss'
import dotenv from 'dotenv'

dotenv.config()

const client = new OSS({
  region: process.env.OSS_REGION!,
  accessKeyId: process.env.OSS_ACCESS_KEY_ID!,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET!,
  bucket: process.env.OSS_BUCKET_NAME!
})

export default client
```

4.4.6 `routers/`

> 路由模块，负责 URL 到控制器方法的映射。

`routers/index.ts`：

```ts
import express from 'express'
import userRouter from './userRouter'

const router = express.Router()
router.use('/users', userRouter)

export default router
```

`routers/userRouter.ts`：

```ts
import express from 'express'
import * as userController from '../controllers/userController'

const router = express.Router()
router.get('/', userController.getAllUsers)

export default router
```

4.4.7 `utils/`

> 工具函数，如统一响应格式、加密、日志等。

示例：`utils/responseHandler.ts`

```ts
export const success = (data: any, message = 'success') => ({
  code: 200,
  message,
  data
})

export const error = (message = 'error', code = 500) => ({
  code,
  message
})
```

4.4.7 `types/`

> TypeScript 类型定义。

示例：`types/user.d.ts`

```ts
export interface User {
  student_id: string
  name: string
  dept_id?: number
  role?: string
}
```

#### 4.5 运行项目

启动项目（开发模式）

~~~bash
ts-node src/app.ts
~~~

或使用 **`nodemon`** 自动重启（推荐）：

```bash
npm install nodemon --save-dev
```

在 `package.json` 添加脚本：

```json
"scripts": {
  "dev": "nodemon src/app.ts"
}
```

启动：

```bash
npm run dev
```



## 五、中间件与工具函数

#### 5.1 完善项目目录结构

~~~bash
backend/
├── src/                          # 源代码核心目录
│   ├── app.ts                    # 应用主入口文件：注册中间件、加载路由、启动服务
│
│   ├── db/                       # 数据库连接模块
│   │   └── index.ts              # MySQL 连接池初始化（加载 .env 配置，提供数据库查询入口）
│
│   ├── controllers/              # 控制器层：接收请求、参数校验、调用服务层、返回响应
│   │   ├── auth/                 # 认证相关控制器（登录/个人信息）
│   │   │   ├── authLoginController.ts  # 登录逻辑处理（账号验证、Token 生成）
│   │   │   └── authInfoController.ts   # 个人信息查询/修改逻辑处理
│   │   ├── activitiesController.ts     # 活动管理相关接口处理
│   │   ├── activityParticipantsController.ts  # 活动参与人员管理接口处理
│   │   ├── announcementsController.ts  # 公告管理接口处理
│   │   ├── backboneMembersController.ts  # 骨干成员管理接口处理
│   │   ├── departmentsController.ts     # 部门管理接口处理
│   │   ├── emailController.ts           # 邮件发送相关接口处理（验证码、通知）
│   │   ├── galleryPhotosController.ts   # 图库照片管理接口处理
│   │   ├── honorRecordsController.ts    # 荣誉记录管理接口处理
│   │   ├── operationLogsController.ts   # 操作日志查询接口处理
│   │   ├── ossSignatureController.ts    # OSS 签名相关接口处理（前端直传授权）
│   │   ├── teamMilestonesController.ts  # 团队里程碑管理接口处理
│   │   └── teamTermsController.ts       # 团队任期管理接口处理
│
│   ├── services/                 # 服务层：核心业务逻辑处理、数据库交互
│   │   ├── auth/                 # 认证相关服务
│   │   │   ├── authLoginService.ts  # 登录业务逻辑（账号密码校验、用户信息查询）
│   │   │   └── authInfoService.ts   # 个人信息业务逻辑（数据查询/更新）
│   │   ├── activitiesService.ts     # 活动管理业务逻辑（活动CRUD、关联数据处理）
│   │   ├── activityParticipantsService.ts  # 活动参与人员业务逻辑（报名/退报、名单管理）
│   │   ├── announcementsService.ts  # 公告管理业务逻辑（公告CRUD、状态控制）
│   │   ├── backboneMembersService.ts  # 骨干成员业务逻辑（成员CRUD、权限关联）
│   │   ├── departmentsService.ts     # 部门管理业务逻辑（部门CRUD、层级管理）
│   │   ├── emailService.ts           # 邮件发送业务逻辑（对接邮箱工具、模板处理）
│   │   ├── galleryPhotosService.ts   # 图库照片业务逻辑（照片CRUD、OSS关联）
│   │   ├── honorRecordsService.ts    # 荣誉记录业务逻辑（荣誉CRUD、分类管理）
│   │   ├── operationLogsService.ts   # 操作日志业务逻辑（日志查询、条件筛选）
│   │   ├── ossSignatureService.ts    # OSS 签名业务逻辑（生成临时授权签名）
│   │   ├── teamMilestonesService.ts  # 团队里程碑业务逻辑（里程碑CRUD、时间线管理）
│   │   └── teamTermsService.ts       # 团队任期业务逻辑（任期CRUD、人员关联）
│
│   ├── routers/                  # 路由层：定义接口路径、关联控制器
│   │   ├── index.ts              # 路由汇总入口：统一注册所有模块路由，供 app.ts 加载
│   │   ├── auth/                 # 认证相关路由
│   │   │   ├── authLoginRouter.ts  # 登录接口路由（POST /api/auth/login 等）
│   │   │   └── authInfoRouter.ts   # 个人信息接口路由（GET/PUT /api/auth/info 等）
│   │   ├── activitiesRouter.ts     # 活动管理接口路由（GET/POST/PUT/DELETE /api/activities 等）
│   │   ├── activityParticipantsRouter.ts  # 活动参与人员接口路由（POST /api/activity-participants 等）
│   │   ├── announcementsRouter.ts  # 公告管理接口路由（GET/POST /api/announcements 等）
│   │   ├── backboneMembersRouter.ts  # 骨干成员接口路由（GET/POST /api/backbone-members 等）
│   │   ├── departmentsRouter.ts     # 部门管理接口路由（GET/POST /api/departments 等）
│   │   ├── emailRouter.ts           # 邮件相关接口路由（POST /api/email/send 等）
│   │   ├── galleryPhotosRouter.ts   # 图库照片接口路由（GET/POST /api/gallery-photos 等）
│   │   ├── honorRecordsRouter.ts    # 荣誉记录接口路由（GET/POST /api/honor-records 等）
│   │   ├── operationLogsRouter.ts   # 操作日志接口路由（GET /api/operation-logs 等）
│   │   ├── ossRouter.ts             # OSS 相关接口路由（GET /api/oss/signature 等）
│   │   ├── publicRouter.ts          # 公开接口路由（无需鉴权的接口，如健康检查、公开公告）
│   │   ├── teamMilestonesRouter.ts  # 团队里程碑接口路由（GET/POST /api/team-milestones 等）
│   │   └── teamTermsRouter.ts       # 团队任期接口路由（GET/POST /api/team-terms 等）
│
│   ├── middlewares/              # 中间件层：全局请求处理、拦截器
│   │   ├── authMiddleware.ts      # 鉴权中间件：验证 JWT Token、角色权限控制
│   │   ├── errorHandler.ts        # 全局错误处理中间件：捕获异常、统一错误响应
│   │   └── logMiddleware.ts       # 日志中间件：记录请求日志、接口性能统计、写入数据库
│
│   ├── oss/                      # OSS 对象存储模块（阿里云）
│   │   ├── index.ts              # OSS 功能统一导出入口（对外提供上传/删除/下载等方法）
│   │   ├── ossClient.ts          # OSS 客户端初始化（加载配置、创建阿里云 OSS 实例）
│   │   ├── ossConfig.ts          # OSS 配置加载（读取 .env 中的 OSS 相关环境变量）
│   │   ├── ossUtils.ts           # OSS 工具函数（路径拼接、文件名生成、URL 处理等）
│   │   ├── uploadService.ts      # 基础上传服务（文件缓冲区上传、OSS 路径处理）
│   │   ├── autoUploadService.ts  # 自动分类上传服务（识别文件类型、自动分目录存储）
│   │   ├── deleteService.ts      # OSS 文件删除服务（单个/批量删除文件）
│   │   ├── downloadService.ts    # OSS 文件下载服务（获取文件流、下载链接生成）
│   │   └── signedUrlService.ts   # 签名 URL 服务（生成临时访问 URL，支持前端直传/下载）
│
│   ├── types/                    # TypeScript 类型定义模块
│   │   ├── dbTypes.ts            # 数据库相关类型定义（表结构映射、查询结果类型）
│   │   └── requestTypes.ts       # 请求相关类型定义（接口入参、请求体、响应体类型）
│
│   ├── utils/                    # 通用工具模块
│   │   ├── bcryptUtil.ts         # 密码加密工具（bcrypt 算法封装，加密/校验密码）
│   │   ├── dateUtil.ts           # 日期时间工具（格式转换、时间差计算、日期验证）
│   │   ├── docxToHtml.ts         # DOCX 转 HTML 工具（文档格式转换）
│   │   ├── emailUtil.ts          # 邮箱工具（对接 SMTP 服务、发送邮件模板）
│   │   ├── logger.ts             # 日志工具（本地文件日志、控制台输出，支持不同日志级别）
│   │   ├── response.ts           # 响应工具（统一接口响应格式、状态码封装）
│   │   ├── tokenUtil.ts          # JWT 工具（Token 生成、验证、解码用户信息）
│   │   └── validator.ts          # 数据校验工具（基础参数校验、格式验证）
│
│   └── validators/               # 请求参数校验模块
│       ├── validateFactory.ts    # 校验工厂（生成统一的校验函数，简化校验逻辑）
│       ├── validateRequest.ts    # 校验中间件（对接路由，实现请求参数前置校验）
│       └── validateSchemas.ts    # 校验规则 schema 定义（各接口入参校验规则）
│
├── .env                          # 环境变量配置文件（数据库、OSS、JWT 等配置，不上 Git）
├── .gitignore                    # Git 忽略文件配置（node_modules、.env、日志等）
├── package.json                  # 项目依赖配置、脚本命令（启动、打包、测试等）
├── tsconfig.json                 # TypeScript 编译配置（目标版本、模块解析、路径映射等）
└── README.md                     # 项目说明文档（环境搭建、启动步骤、目录说明、接口文档链接等）
~~~

#### 5.2 响应封装

📁`src/utils/response.ts`

~~~ts
// 封装统一接口响应格式，支持状态码、分页、调试信息等
import { Response } from 'express';

/** 统一接口响应结构 */
export interface ApiResponse<T = any> {
  code: number;        // HTTP状态码
  success: boolean;    // 是否成功
  message: string;     // 提示信息
  data?: T;            // 返回数据
  meta?: any;          // 元信息（分页、统计等）
  debug?: any;         // 调试信息（仅开发模式）
}

/** 成功响应（默认200状态码） */
export const successResponse = <T>(
  res: Response,
  data?: T,
  message = 'Success',
  code = 200,
  meta?: any
): Response<ApiResponse<T>> => {
  const response: ApiResponse<T> = {
    code,
    success: true,
    message,
    ...(data ? { data } : {}),
    ...(meta ? { meta } : {}),
  };
  return res.status(code).json(response);
};

/** 失败响应（默认500状态码，开发环境可显示调试信息） */
export const errorResponse = (
  res: Response,
  message = 'Internal Server Error',
  code = 500,
  debug?: any
): Response<ApiResponse> => {
  const response: ApiResponse = {
    code,
    success: false,
    message,
    ...(process.env.NODE_ENV === 'development' && debug ? { debug } : {}),
  };
  return res.status(code).json(response);
};

/** 通用响应（支持自定义状态码：400/401/403/404/201等） */
export const sendResponse = (
  res: Response,
  code: number,
  message: string,
  data?: any
): Response<ApiResponse> => {
  return res.status(code).json({
    code,
    success: code >= 200 && code < 300,
    message,
    ...(data ? { data } : {}),
  });
};

/** 常用HTTP状态码枚举（统一管理） */
export const HTTP_STATUS = {
  OK: 200,                  // 请求成功
  CREATED: 201,             // 创建成功
  ACCEPTED: 202,            // 已接受（异步处理中）
  NO_CONTENT: 204,          // 请求成功但无返回内容
  BAD_REQUEST: 400,         // 请求参数错误
  UNAUTHORIZED: 401,        // 未授权（Token无效）
  FORBIDDEN: 403,           // 无权限访问
  NOT_FOUND: 404,           // 资源不存在
  METHOD_NOT_ALLOWED: 405,  // 请求方法不允许
  CONFLICT: 409,            // 资源冲突
  INTERNAL_ERROR: 500,      // 服务器内部错误
  NOT_IMPLEMENTED: 501,     // 功能未实现
  SERVICE_UNAVAILABLE: 503, // 服务暂时不可用
};
~~~

📘 使用示例

- 1️⃣ 成功返回

  ~~~ts
  import { successResponse, HTTP_STATUS } from '../utils/response';
  
  app.get('/users', (req, res) => {
    const users = [{ id: 1, name: 'Alice' }];
    successResponse(res, users, '获取成功', HTTP_STATUS.OK);
  });
  ~~~

- 2️⃣ 创建成功（201）

  ~~~ts
  successResponse(res, newUser, '创建成功', HTTP_STATUS.CREATED);
  ~~~

- 3️⃣ 错误返回（例如 404）

  ~~~ts
  import { errorResponse, HTTP_STATUS } from '../utils/response';
  
  errorResponse(res, '用户不存在', HTTP_STATUS.NOT_FOUND);
  return；
  ~~~

- 4️⃣ 自定义返回（403 禁止访问）

  ~~~ts
  sendResponse(res, HTTP_STATUS.FORBIDDEN, '禁止访问此资源');
  ~~~

💡 设计思路说明

| 特性                 | 说明                                            |
| -------------------- | ----------------------------------------------- |
| ✅ **统一结构**       | 所有接口返回 `{ code, success, message, data }` |
| ✅ **多状态码支持**   | 使用 `HTTP_STATUS` 枚举集中管理                 |
| ✅ **支持分页 meta**  | 用于表格分页、统计接口                          |
| ✅ **调试信息 debug** | 仅开发模式下输出错误堆栈                        |
| ✅ **类型安全**       | 泛型支持自动推导数据结构                        |
| ✅ **可读性强**       | 语义化函数名、直观状态码                        |

#### 5.3 错误处理中间件

📁`src/middlewares/errorHandler.ts`

~~~ts
import { Request, Response, NextFunction } from 'express';
import { errorResponse, HTTP_STATUS } from '../utils/response';

/** 全局错误处理中间件：捕获所有未处理异常，返回统一格式响应（开发环境附带堆栈） */
export const errorHandler = (
  err: any,
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  console.error('🚨 [全局错误捕获]', {
    method: req.method,
    path: req.originalUrl,
    message: err.message,
  });

  const statusCode = err.statusCode || HTTP_STATUS.INTERNAL_ERROR;
  const message = err.message || '服务器内部错误，请稍后再试。';
  const debugInfo = process.env.NODE_ENV === 'development' ? err.stack : undefined;

  errorResponse(res, message, statusCode, debugInfo);
};

/** 404路由处理中间件：捕获未命中路由（需放在所有路由之后） */
export const notFoundHandler = (
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  console.warn(`⚠️ 路由未找到: ${req.method} ${req.originalUrl}`);
  errorResponse(res, `接口未找到：${req.originalUrl}`, HTTP_STATUS.NOT_FOUND);
};
~~~

#### 5.4 日志工具与中间件

安装依赖

~~~bash
# 日志库
npm install winston winston-daily-rotate-file chalk

# dev types
npm install -D @types/chalk @types/winston
~~~

📁`src/utils/logger.ts`

> 负责本地文件 + 控制台日志。使用 `winston` + `winston-daily-rotate-file` 做每日轮转，支持不同日志级别。

~~~ts
import { createLogger, format, transports } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import path from 'path';

const { combine, timestamp, printf, colorize } = format;

// 自定义日志格式
const logFormat = printf(({ level, message, timestamp }) => {
  return `${timestamp} [${level}] ${message}`;
});

// 日志目录（相对于项目根）
const logDir = path.join(process.cwd(), 'logs');

// 创建 logger
const logger = createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: combine(
    timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
    logFormat
  ),
  transports: [
    // 控制台彩色输出（开发环境）
    new transports.Console({
      format: combine(colorize(), timestamp({ format: 'HH:mm:ss' }), logFormat)
    }),
    // 每日轮转文件：info
    new DailyRotateFile({
      dirname: logDir,
      filename: 'app-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxFiles: '14d',
      level: 'info'
    }),
    // 每日轮转文件：error
    new DailyRotateFile({
      dirname: logDir,
      filename: 'error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxFiles: '30d',
      level: 'error'
    })
  ],
  exitOnError: false
});

export default logger;
~~~

📁`src/middlewares/logMiddleware.ts`

> 主要中间件：彩色控制台输出、写文件（通过 logger）、异步写 `operation_logs` 表、性能统计并周期性输出（默认 5 分钟）。

~~~ts
import { Request, Response, NextFunction } from 'express';
import chalk from 'chalk';
import logger from '../utils/logger';
import { query } from '../db';

/** 接口性能统计类型：请求次数+总耗时(ms) */
type MetricsStat = {
  count: number;
  totalTime: number;
};

const metrics: Map<string, MetricsStat> = new Map();
// 性能统计输出间隔（默认5分钟，支持环境变量配置）
const METRICS_FLUSH_INTERVAL = Number(process.env.METRICS_FLUSH_INTERVAL_MS) || 5 * 60 * 1000;

/** 定期输出API性能汇总（按接口分组，含请求数和平均耗时） */
const flushMetrics = () => {
  if (metrics.size === 0) return;
  const rows: string[] = [];
  metrics.forEach((stat, key) => {
    const avg = stat.totalTime / stat.count;
    rows.push(`${key} => count=${stat.count}, avg=${avg.toFixed(2)}ms`);
  });
  logger.info(`🧮 API性能统计:\n${rows.join('\n')}`);
};
setInterval(flushMetrics, METRICS_FLUSH_INTERVAL);

/** 日志中间件：彩色控制台输出+文件日志+数据库操作日志+接口性能统计 */
export const logMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  const { method, originalUrl } = req;

  res.on('finish', async () => {
    const duration = Date.now() - start;
    const status = res.statusCode;

    // 用户身份信息（优先student_id/user_id，默认guest）
    const user = (req as any).user || {};
    const studentId = user?.student_id || user?.user_id || 'guest';
    const role = user?.role || 'guest';

    // 网络信息（IP+User-Agent）
    const ip = (req.headers['x-forwarded-for'] as string)?.split(',')[0] || req.socket.remoteAddress || 'unknown';
    const userAgent = req.headers['user-agent'] || null;

    // 控制台彩色输出（按请求方法/状态码区分颜色）
    const timeStr = chalk.gray(`[${new Date().toLocaleTimeString()}]`);
    const methodColor = { GET: chalk.blueBright, POST: chalk.greenBright, PUT: chalk.yellowBright, DELETE: chalk.redBright, PATCH: chalk.magentaBright }[method] || chalk.white;
    const statusColorFn = status >= 500 ? chalk.red : status >= 400 ? chalk.yellow : status >= 300 ? chalk.cyan : status >= 200 ? chalk.green : chalk.white;

    const consoleMsg = `${timeStr} ${methodColor(method)} ${chalk.white(originalUrl)} ${statusColorFn(String(status))} ${chalk.gray(`${duration}ms`)} ${chalk.cyan(`IP:${ip}`)} ${chalk.white(`User:${studentId}`)} ${chalk.gray(`Role:${role}`)}`;
    console.log(consoleMsg);

    // 写入本地日志文件
    logger.info(`${method} ${originalUrl} ${status} ${duration}ms ip=${ip} user=${studentId} role=${role}`);

    // 异步写入operation_logs表（字段严格匹配表定义）
    try {
      const sql = `INSERT INTO operation_logs (user_id, action, target_table, target_id, description, ip_address, user_agent, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, NOW())`;
      const target_table = extractTableName(originalUrl);
      const description = `Status=${status}, Duration=${duration}ms, Path=${originalUrl}`;
      query(sql, [studentId, method, target_table, null, description, ip, userAgent]).catch(err => {
        logger.error('💥 写入 operation_logs 失败: ' + err.message);
      });
    } catch (err: any) {
      logger.error('logMiddleware DB insert error: ' + err.message);
    }

    // 性能指标统计（按method+url分组）
    const key = `${method} ${originalUrl}`;
    const stat = metrics.get(key);
    if (!stat) metrics.set(key, { count: 1, totalTime: duration });
    else { stat.count += 1; stat.totalTime += duration; }
  });

  next();
};

/** 从URL提取资源名（如/api/users/123提取users，/api/auth/login提取auth） */
function extractTableName(url: string): string | null {
  const parts = url.split('/').filter(Boolean);
  return parts.length >= 2 ? parts[1].replace(/[^a-zA-Z0-9_]/g, '') : null;
}
~~~

🧩 设计亮点说明

| 功能模块         | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| **用户身份记录** | 读取 `(req as any).user.student_id`，默认写入 `operation_logs.user_id` |
| **性能分析**     | 在内存聚合每个接口的调用次数与平均耗时；每 5 分钟自动输出    |
| **数据库写入**   | 使用 `query()` 异步执行 SQL（不阻塞响应）；字段完全匹配你的 `operation_logs` 表结构 |
| **日志输出**     | 控制台彩色输出 + 写入 `logs/app-%DATE%.log`（通过 `winston` 日志轮转） |
| **安全与性能**   | 不记录请求体、不阻塞主线程；数据库写入失败仅记录错误，不影响接口响应 |

#### 5.5 JWT工具与鉴权中间件

📁`src/utils/tokenUtil.ts`

~~~ts
import jwt, { JwtPayload, Secret } from 'jsonwebtoken';

const JWT_SECRET: Secret = process.env.JWT_SECRET || 'default_secret_key';
const JWT_EXPIRES_IN = (process.env.JWT_EXPIRES_IN || '2h') as any;

export interface TokenPayload extends JwtPayload {
  auth_id: number;
  student_id: string;
  email: string;
  role?: string;
}

/** 生成 JWT */
export const signToken = (payload: TokenPayload): string => {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });
};

/** 验证 JWT */
export const verifyToken = (token: string): TokenPayload | null => {
  try {
    return jwt.verify(token, JWT_SECRET) as TokenPayload;
  } catch {
    return null;
  }
};
~~~

📁`src/middlewares/authMiddleware.ts`

~~~ts
import { Request, Response, NextFunction } from 'express';
import { verifyToken } from '../utils/tokenUtil';
import { errorResponse, HTTP_STATUS } from '../utils/response';

/** 扩展Express Request类型，增加user字段存储用户信息 */
declare module 'express-serve-static-core' {
  interface Request {
    user?: any;
  }
}

// 无需JWT鉴权的路径（公开接口/静态资源等），匹配/api/public|docs|health
const UNPROTECTED_PATH_REGEX = /^\/api\/(public|docs|health)/i;

/** JWT鉴权中间件：提取Bearer Token验证有效性，通过后挂载用户信息到req.user */
export const authenticateToken = (
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  if (UNPROTECTED_PATH_REGEX.test(req.path)) {
    next();
    return;
  }

  const authHeader = req.headers['authorization'];
  const token = authHeader?.startsWith('Bearer ') ? authHeader.split(' ')[1] : undefined;

  if (!token) {
    errorResponse(res, '未提供Token，访问被拒绝', HTTP_STATUS.UNAUTHORIZED);
    return;
  }

  const user = verifyToken(token);
  if (!user) {
    errorResponse(res, '无效或过期的Token，请重新登录', HTTP_STATUS.UNAUTHORIZED);
    return;
  }

  req.user = user;
  next();
};

/** 角色权限控制中间件：仅允许指定角色访问（用法：authorizeRole('admin')） */
export const authorizeRole = (...allowedRoles: string[]) => {
  return (req: Request, res: Response, next: NextFunction): void => {
    const user = req.user;

    if (!user) {
      errorResponse(res, '未登录或身份信息丢失', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    if (!allowedRoles.includes(user.role)) {
      errorResponse(res, '权限不足，无法访问该资源', HTTP_STATUS.FORBIDDEN);
      return;
    }

    next();
  };
};

/** 业务层用户身份二次验证：校验ID与Token匹配性 */
export const authenticateUser = (id: number, token: string): boolean => {
  const user = verifyToken(token);
  if (!user) throw new Error('Token无效或已过期');
  if (user.id !== id) throw new Error('ID与Token不匹配');
  return true;
};
~~~

#### 5.6 基本输入校验工具和中间件

📁`src/utils/validator.ts`

~~~ts
/**
 * 常用校验工具（只返回 boolean，不负责响应）
 */

/** 学号：10位数字 */
export const isStudentId = (id: string): boolean => {
  return /^\d{10}$/.test(String(id));
};

/** 校内邮箱：以 @ctbu.edu.cn 结尾 */
export const isCtbuEmail = (email: string): boolean => {
  return /^[a-zA-Z0-9._%+-]+@ctbu\.edu\.cn$/.test(String(email));
};

/** 密码强度：至少6位，包含大写、小写、数字（根据你原来规则） */
export const isStrongPassword = (password: string): boolean => {
  return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/.test(String(password));
};

/** 性别（允许值：男 / 女 / 其他） */
export const isGender = (gender: string): boolean => {
  return ['男', '女', '其他'].includes(String(gender));
};

/** 通用邮箱（备用） */
export const isEmail = (email: string): boolean => {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email));
};

/** 手机号（中国手机号校验，备用） */
export const isPhone = (phone: string): boolean => {
  return /^1[3-9]\d{9}$/.test(String(phone));
};
~~~

📁`src/validators/validateFactory.ts`

作为校验中间件的创造使用函数

~~~ts
import { Request, Response, NextFunction } from "express";
import { errorResponse, HTTP_STATUS } from "../utils/response";
import { FieldRule } from "./validateSchemas";

/**
 * 创建数据校验器（支持Express中间件和同步对象校验）
 * @param schema 校验规则配置
 * @param mode 校验模式（create：必填校验；update：未传字段跳过）
 */
export const createValidator = (
  schema: Record<string, FieldRule>,
  mode: "create" | "update" = "create"
) => {

  /**
   * 同步校验任意对象
   * @param data 待校验数据
   * @returns 错误信息（null表示校验通过）
   */
  const syncValidate = (data: any): string | null => {
    const body = data || {};

    for (const field in schema) {
      const rule = schema[field];
      const value = body[field];

      // 1. 创建模式下必填校验
      if (
        mode === "create" &&
        rule.required &&
        (value === undefined || value === null || value === "")
      ) {
        return `${field}: ${rule.message}`;
      }

      // 2. 更新模式下未传字段跳过
      if (mode === "update" && value === undefined) continue;

      // 3. 类型校验
      if (rule.type === "number" && value !== undefined && isNaN(Number(value))) {
        return `${field}: 必须为数字`;
      }
      if (rule.type === "date" && value && isNaN(Date.parse(value))) {
        return `${field}: 日期格式错误`;
      }
      if (rule.type === "enum" && value && !rule.enumValues!.includes(value)) {
        return `${field}: ${rule.message}`;
      }

      // 4. 自定义校验规则
      if (rule.validator && value !== undefined && !rule.validator(value)) {
        return `${field}: ${rule.message}`;
      }
    }

    return null; // 校验通过
  };

  /**
   * Express中间件：校验请求体
   */
  const middleware = (req: Request, res: Response, next: NextFunction) => {
    const error = syncValidate(req.body);
    if (error) {
      errorResponse(res, error, HTTP_STATUS.BAD_REQUEST);
      return;
    }
    next();
  };

  // 挂载同步校验方法到中间件上，支持灵活使用
  return Object.assign(middleware, { syncValidate });
};

/**
 * 创建批量数据校验器（校验数组类型请求体）
 * @param schema 单条数据校验规则
 * @param mode 校验模式（create/update）
 * @returns Express中间件（返回具体错误数据索引）
 */
export const createBatchValidator = (
  schema: Record<string, FieldRule>,
  mode: "create" | "update" = "create"
) => {
  const validator = createValidator(schema, mode);

  return (req: Request, res: Response, next: NextFunction) => {
    const arr = req.body;

    // 先校验是否为非空数组
    if (!Array.isArray(arr) || arr.length === 0) {
      errorResponse(res, "请求体必须为非空数组", HTTP_STATUS.BAD_REQUEST);
      return;
    }

    // 逐条校验，返回具体错误索引
    for (let i = 0; i < arr.length; i++) {
      const errorMsg = validator.syncValidate(arr[i]);
      if (errorMsg) {
        errorResponse(
          res,
          `第 ${i + 1} 条数据错误：${errorMsg}`,
          HTTP_STATUS.BAD_REQUEST
        );
        return;
      }
    }

    next();
  };
};
~~~

📁`src/validators/validateSchemas.ts`

~~~ts
import {
  isStudentId,
  isCtbuEmail,
  isEmail,
  isPhone,
  isStrongPassword
} from "../utils/validator";

export type FieldRule = {
  required?: boolean;
  type?: "string" | "number" | "enum" | "date";
  enumValues?: string[];
  validator?: (value: unknown) => boolean;
  message: string;
};
~~~

📁`src/validators/validateRequest.ts`

```ts
import { Request, Response, NextFunction } from 'express';
import { errorResponse, HTTP_STATUS } from '../utils/response';
import { createValidator, createBatchValidator } from "./validateFactory";
import {
  AuthLoginSchema,
  RegistrationSchema,
  LoginSchema,
  BatchRegistrationSchema,
  BatchDeleteAuthSchema,
  ChangePasswordSchema,
  AuthInfoSchema,
  DepartmentSchema,
  TeamTermSchema,
  BackboneMemberSchema,
  ActivitySchema,
  ActivityParticipantSchema,
  HonorSchema,
  AnnouncementSchema,
  GalleryPhotoSchema,
  TeamMilestoneSchema,
  OperationLogSchema,
  EmailVerificationCodeSchema,
  SendEmailCodeSchema,
  VerifyEmailCodeSchema,
} from "./validateSchemas";
```

#### 5.7 加密工具

📁`src/utils/bcryptUtil.ts`

~~~ts
import bcrypt from 'bcrypt';

/**
 * 生成密码哈希（bcrypt加密，带自动加盐）
 * @param password 明文密码
 * @param saltRounds 加盐强度（默认10，值越高加密越慢但越安全）
 * @returns 加密后的哈希字符串
 */
export const hashPassword = async (password: string, saltRounds = 10): Promise<string> => {
  const salt = await bcrypt.genSalt(saltRounds);
  return bcrypt.hash(password, salt);
};

/**
 * 比对密码（登录验证用，明文密码与哈希密码匹配校验）
 * @param password 用户输入的明文密码
 * @param hashedPassword 数据库存储的加密密码
 * @returns 是否匹配的布尔值
 */
export const comparePassword = async (password: string, hashedPassword: string): Promise<boolean> => {
  return bcrypt.compare(password, hashedPassword);
};

/**
 * 同步生成密码哈希（适用于测试环境，避免异步等待）
 * @param password 明文密码
 * @param saltRounds 加盐强度（默认10）
 * @returns 加密后的哈希字符串
 */
export const hashPasswordSync = (password: string, saltRounds = 10): string => {
  const salt = bcrypt.genSaltSync(saltRounds);
  return bcrypt.hashSync(password, salt);
};

/**
 * 同步比对密码（适用于测试环境）
 * @param password 明文密码
 * @param hashedPassword 加密密码
 * @returns 是否匹配的布尔值
 */
export const comparePasswordSync = (password: string, hashedPassword: string): boolean => {
  return bcrypt.compareSync(password, hashedPassword);
};
~~~

#### 5.8 邮箱工具

📁`src/utils/emailUtil.ts`

~~~ts
import nodemailer from 'nodemailer';
import SMTPTransport from 'nodemailer/lib/smtp-transport';
import dotenv from 'dotenv';
import { Response } from 'express';
import { HTTP_STATUS, successResponse, errorResponse } from './response';

dotenv.config();

/** 创建邮件传输实例（从环境变量加载SMTP配置） */
const transporter = nodemailer.createTransport(
  {
    host: process.env.SMTP_HOST || 'smtp.163.com',
    port: Number(process.env.SMTP_PORT) || 465,
    secure: true,
    auth: {
      type: 'login',
      user: process.env.SMTP_USER,
      pass: process.env.SMTP_PASS,
    },
  } as SMTPTransport.Options
);

/** 获取邮件发送方配置（名称+邮箱） */
const getMailFrom = () => {
  const fromName = process.env.MAIL_FROM_NAME || 'CTBU常青藤';
  const fromEmail = process.env.SMTP_USER;
  return `"${fromName}" <${fromEmail}>`;
};

/** 发送纯文本邮件 */
export const sendEmail = async (to: string, subject: string, text: string): Promise<void> => {
  const mailOptions = { from: getMailFrom(), to, subject, text };

  try {
    const info = await transporter.sendMail(mailOptions);
    if (process.env.NODE_ENV === 'development') {
      console.log('📤 邮件发送成功:', info.response);
    }
  } catch (error: any) {
    console.error('❌ 邮件发送失败:', error.message);
    throw new Error('邮件发送失败，请稍后再试');
  }
};

/** 发送HTML模板邮件 */
export const sendHtmlEmail = async (to: string, subject: string, html: string): Promise<void> => {
  const mailOptions = { from: getMailFrom(), to, subject, html };

  try {
    const info = await transporter.sendMail(mailOptions);
    if (process.env.NODE_ENV === 'development') {
      console.log('📧 邮件发送成功:', info.response);
    }
  } catch (error: any) {
    console.error('❌ 邮件发送失败:', error.message);
    throw new Error('邮件发送失败，请稍后再试');
  }
};

/** 发送邮箱验证码（5分钟有效） */
export const sendVerificationCode = async (to: string, code: string): Promise<void> => {
  const subject = '【CTBU常青藤】邮箱验证码';
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;max-width:600px;margin:auto;padding:20px;background-color:#f9f9f9;border-radius:10px;">
      <h2 style="color:#4caf50;">CTBU 常青藤志愿服务平台</h2>
      <p>您好，您的验证码为：</p>
      <p style="font-size:24px;font-weight:bold;color:#4caf50;">${code}</p>
      <p>验证码 5 分钟内有效，请勿泄露给他人。</p>
      <p style="margin-top:30px;color:#999;">此邮件为系统自动发送，请勿回复。</p>
    </div>
  `;
  await sendHtmlEmail(to, subject, html);
};

/** 发送注册欢迎邮件 */
export const sendWelcomeEmail = async (to: string, username: string): Promise<void> => {
  const subject = '🎉 欢迎加入 CTBU 常青藤';
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;max-width:600px;margin:auto;padding:20px;background-color:#fefefe;border-radius:10px;">
      <h2 style="color:#4caf50;">欢迎加入 CTBU 常青藤志愿服务平台</h2>
      <p>亲爱的 ${username}：</p>
      <p>欢迎成为我们的一员！感谢您的信任与支持。</p>
      <p>您现在可以登录平台，参与志愿活动、管理任务并查看学业成长记录。</p>
      <p style="margin-top:30px;color:#999;">此邮件为系统自动发送，请勿回复。</p>
    </div>
  `;
  await sendHtmlEmail(to, subject, html);
};

/** 发送密码重置邮件（30分钟有效链接） */
export const sendPasswordResetEmail = async (to: string, resetLink: string): Promise<void> => {
  const subject = '🔑 重置您的 CTBU 常青藤 账户密码';
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;max-width:600px;margin:auto;padding:20px;background-color:#fafafa;border-radius:10px;">
      <h2 style="color:#4caf50;">CTBU 常青藤密码重置</h2>
      <p>请点击以下链接重置密码：</p>
      <a href="${resetLink}" style="color:#2196f3;">${resetLink}</a>
      <p>链接 30 分钟内有效，如非本人操作请忽略此邮件。</p>
    </div>
  `;
  await sendHtmlEmail(to, subject, html);
};

/** 发送密码修改成功通知邮件 */
export const sendPasswordChangedEmail = async (to: string, username: string): Promise<void> => {
  const subject = '🔒 您的 CTBU 常青藤账号密码已修改';
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;max-width:600px;margin:auto;padding:20px;background:#fafafa;border-radius:10px;">
      <h2 style="color:#4caf50;">CTBU 常青藤安全中心</h2>
      <p>尊敬的学号为 ${username} 的志愿者，您好：</p>
      <p>您的账户密码已于 <b>${new Date().toLocaleString()}</b> 修改成功。</p>
      <p>如果这不是您本人操作，请立即前往平台重置密码或联系管理员处理。</p>
      <p style="margin-top:30px;color:#999;">此邮件为系统自动发送，请勿回复。</p>
    </div>
  `;
  await sendHtmlEmail(to, subject, html);
};

/** 控制器级封装：发送邮件并返回统一响应 */
export const sendEmailWithResponse = async (
  res: Response,
  to: string,
  subject: string,
  html: string
) => {
  try {
    await sendHtmlEmail(to, subject, html);
    return successResponse(res, null, '邮件发送成功', HTTP_STATUS.OK);
  } catch (error: any) {
    return errorResponse(
      res,
      '邮件发送失败，请稍后再试',
      HTTP_STATUS.INTERNAL_ERROR,
      error?.message
    );
  }
};
~~~

#### 5.9 OSS工具

5.9.1 `ossConfig.ts`（集中管理配置）

~~~ts
// 集中管理配置
import dotenv from 'dotenv';
dotenv.config();

export const OSSConfig = {
  region: process.env.OSS_REGION || 'oss-cn-chengdu',
  accessKeyId: process.env.OSS_ACCESS_KEY_ID!,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET!,
  bucket: process.env.OSS_BUCKET!,
  baseUrl: process.env.OSS_BASE_URL || `https://${process.env.OSS_BUCKET}.oss-${process.env.OSS_REGION}.aliyuncs.com/`,
  uploadDir: process.env.OSS_UPLOAD_DIR || 'uploads/',
};
~~~

5.9.2 `ossClient.ts`（OSS 客户端初始化）

~~~ts
// 客户端初始化
import OSS from 'ali-oss';
import { OSSConfig } from './ossConfig';

export const ossClient = new OSS({
  region: OSSConfig.region,
  accessKeyId: OSSConfig.accessKeyId,
  accessKeySecret: OSSConfig.accessKeySecret,
  bucket: OSSConfig.bucket,
});
~~~

5.9.3 `ossUtils.ts`（工具函数）

~~~ts
import path from 'path';
import { OSSConfig } from './ossConfig';

/**
 * 生成 OSS 文件路径
 * @param category 文件类型目录，如 'avatars' | 'files' | 'temp'
 * @param fileName 文件名
 */
export const generateOSSPath = (category: string, fileName: string) => {
  const timeStamp = Date.now();
  return path.posix.join(OSSConfig.uploadDir, category, `${timeStamp}_${fileName}`);
};

/**
 * 拼接完整 URL
 */
export const getOSSUrl = (objectKey: string) => `${OSSConfig.baseUrl}${objectKey}`;
~~~

5.9.4 `uploadService.ts`（上传服务）

~~~ts
import { ossClient } from './ossClient';
import { generateOSSPath, getOSSUrl } from './ossUtils';

/**
 * 上传文件到 OSS
 * @param file 文件 Buffer
 * @param fileName 文件名（例如 xxx.png）
 * @param category 文件类别目录（如 avatars / files）
 */
export const uploadFileToOSS = async (
  file: Buffer,
  fileName: string,
  category = 'default'
): Promise<{ url: string;  objectKey: string }> => {
  const objectKey = generateOSSPath(category, fileName);

  try {
    // 上传文件到 OSS，不再设置 ACL
    const result = await ossClient.put(objectKey, file, {
      headers: {
        'Cache-Control': 'max-age=31536000', // 设置缓存有效期为一年
      },
    });

    // 生成可访问 URL（根据 bucket + region）
    const fullUrl = getOSSUrl(result.name);

    return {
      url: fullUrl,
      objectKey: result.name
    };
  } catch (err) {
    console.error('上传到 OSS 失败:', err);
    throw new Error('上传失败，请稍后再试');
  }
};
~~~

5.9.5 `deleteService.ts`（删除逻辑）

~~~ts
import { ossClient } from './ossClient';

/** 删除单个OSS文件（路径不含域名） */
export const deleteFileFromOSS = async (objectKey: string): Promise<void> => {
  try {
    await ossClient.delete(objectKey);
    console.log(`✅ 删除成功: ${objectKey}`);
  } catch (err) {
    console.error('❌ 删除失败:', err);
    throw new Error('删除失败');
  }
};

/** 批量删除OSS文件（路径不含域名） */
export const deleteFilesFromOSS = async (objectKeys: string[]): Promise<void> => {
  if (objectKeys.length === 0) return;
  try {
    await ossClient.deleteMulti(objectKeys, { quiet: true });
    console.log(`✅ 批量删除成功: ${objectKeys.length} 个文件`);
  } catch (err) {
    console.error('❌ 批量删除失败:', err);
    throw new Error('批量删除失败');
  }
};
~~~

5.9.6 `signedUrlService.ts`（临时访问链接）【前端直传替换了】

~~~ts
import { ossClient } from './ossClient';

/**
 * 生成带签名的临时访问 URL
 * @param objectKey 文件路径
 * @param expires 有效期（秒），默认 600 秒
 */
export const generateSignedUrl = (objectKey: string, expires = 600): string => {
  try {
    return ossClient.signatureUrl(objectKey, { expires });
  } catch (err) {
    console.error('❌ 生成签名 URL 失败:', err);
    throw new Error('生成签名 URL 失败');
  }
};
~~~

5.9.7 `downloadService.ts`（下载文件）

~~~ts
import { ossClient } from './ossClient';
import fs from 'fs';
import path from 'path';

export const downloadFileFromOSS = async (objectKey: string): Promise<string> => {
  const tempPath = path.join('/CQTtmp', `${Date.now()}_${path.basename(objectKey)}`);

  const result = await ossClient.get(objectKey);
  fs.writeFileSync(tempPath, result.content);

  return tempPath;
};
~~~

#### 5.10 文档Docx转Html

📁`src/utils/docxToHtml.ts`

~~~ts
import mammoth from 'mammoth';
import fs from 'fs';
import { uploadFileToOSS } from '../oss/uploadService';
import { deleteFilesFromOSS } from '../oss/deleteService';

export const convertDocxToHtml = async (filePath: string): Promise<string> => {
  const buffer = fs.readFileSync(filePath);
  const uploadedObjectKeys: string[] = [];

  try {
    const result = await mammoth.convertToHtml(
      { buffer },
      {
        convertImage: mammoth.images.imgElement(async (image) => {
          try {
            const imageBuffer = await image.read();
            const ext = image.contentType.includes('png') ? '.png' : '.jpg';
            const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}${ext}`;

            const { url, objectKey } = await uploadFileToOSS(imageBuffer, fileName, 'announcement/images');

            uploadedObjectKeys.push(objectKey);

            return {
              src: url,
              style: 'max-width: 100%; height: auto;',
            };
          } catch (uploadErr) {
            // 一张失败，立即清理前面所有
            if (uploadedObjectKeys.length > 0) {
              await deleteFilesFromOSS(uploadedObjectKeys).catch(() => { });
            }
            throw new Error(`图片上传失败，已回滚: ${uploadErr instanceof Error ? uploadErr.message : '未知错误'}`);
          }
        }),
      }
    );

    return result.value;
  } catch (error) {
    // 最终兜底：任何异常都删掉已上传的图片
    if (uploadedObjectKeys.length > 0) {
      console.warn(`Word 转换失败，正在清理 ${uploadedObjectKeys.length} 张已上传图片...`);
      await deleteFilesFromOSS(uploadedObjectKeys).catch((e) => {
        console.error('清理垃圾图片失败（非致命）:', e);
      });
    }
    throw error;
  }
};
~~~

#### 5.11 类型定义

5.11.1 📁`src/types/dbTypes.ts`

~~~ts
/**
 * 数据库表类型定义
 * 对应 MySQL 表结构
 */

// AuthLogin（用户登录凭证表）
export interface AuthLoginRecord {
  auth_id: number;
  role: 'user' | 'admin' | 'superadmin';
  student_id: string;
  email: string;
  password_hash: string;
  created_at: string;
  updated_at: string;
}

export type AuthLoginWritable = Omit<
  AuthLoginRecord,
  'auth_id' | 'created_at' | 'updated_at'
>;

export const AuthLoginWritableFields: (keyof AuthLoginWritable)[] = [
  'role',
  'student_id',
  'email',
  'password_hash',
];


// AuthInfo（用户基础资料）
export interface AuthInfoRecord {
  info_id: number;
  student_id: string;
  name: string;
  gender: '男' | '女' | '其他' | null;
  college: string | null;
  major: string | null;
  phone: string | null;
  avatar_url: string | null;
  avatar_key: string | null;
  join_date: string | null;
  total_hours: number;
  skill_tags: string | null;
  created_at: string;
  updated_at: string;
}

export type AuthInfoWritable = Omit<
  AuthInfoRecord,
  'info_id' | 'created_at' | 'updated_at'
>;

export const AuthInfoWritableFields: (keyof AuthInfoWritable)[] = [
  'student_id',
  'name',
  'gender',
  'college',
  'major',
  'phone',
  'avatar_url',
  'avatar_key',
  'join_date',
  'total_hours',
  'skill_tags',
];


// Department（部门信息）
export interface DepartmentRecord {
  dept_id: number;
  dept_name: string;
  description: string | null;
  leader_id: string | null;
  display_order: number;
  created_at: string;
  updated_at: string;
}

export type DepartmentWritable = Omit<
  DepartmentRecord,
  'dept_id' | 'created_at' | 'updated_at'
>;

export const DepartmentWritableFields: (keyof DepartmentWritable)[] = [
  'dept_name',
  'description',
  'leader_id',
  'display_order',
];


// TeamTerm（届次管理）
export interface TeamTermRecord {
  term_id: number;
  term_name: string;
  start_date: string | null;
  end_date: string | null;
  is_current: number;
  remark: string | null;
  created_at: string;
  updated_at: string;
}

export type TeamTermWritable = Omit<
  TeamTermRecord,
  'term_id' | 'created_at' | 'updated_at'
>;

export const TeamTermWritableFields: (keyof TeamTermWritable)[] = [
  'term_name',
  'start_date',
  'end_date',
  'is_current',
  'remark',
];


// BackboneMember（骨干成员）
export interface BackboneMemberRecord {
  member_id: number;
  student_id: string;
  dept_id: number;
  term_id: number;
  position: '队长' | '部长' | '副部长' | '部员';
  photo_url: string | null;
  photo_key: string | null;
  term_start: string | null;
  term_end: string | null;
  remark: string | null;
  created_at: string;
  updated_at: string;
}

export type BackboneMemberWritable = Omit<
  BackboneMemberRecord,
  'member_id' | 'created_at' | 'updated_at'
>;

export const BackboneMemberWritableFields: (keyof BackboneMemberWritable)[] = [
  'student_id',
  'dept_id',
  'term_id',
  'position',
  'photo_url',
  'photo_key',
  'term_start',
  'term_end',
  'remark',
];


// Activity（活动记录）
export interface ActivityRecord {
  activity_id: number;
  activity_name: string;
  dept_id: number | null;
  term_id: number | null;
  category: string | null;
  cover_url: string | null;
  cover_key: string | null;
  recruitment_limit: number;
  service_hours: number;
  location: string | null;
  start_time: string | null;
  end_time: string | null;
  description: string | null;
  status: '草稿' | '进行中' | '已结束';
  created_by: string | null;
  created_at: string;
  updated_at: string;
}

export type ActivityWritable = Omit<
  ActivityRecord,
  'activity_id' | 'created_at' | 'updated_at'
>;

export const ActivityWritableFields: (keyof ActivityWritable)[] = [
  'activity_name',
  'dept_id',
  'term_id',
  'category',
  'cover_url',
  'cover_key',
  'recruitment_limit',
  'service_hours',
  'location',
  'start_time',
  'end_time',
  'description',
  'status',
  'created_by',
];


// ActivityParticipant（活动参与记录）
export interface ActivityParticipantRecord {
  record_id: number;
  activity_id: number;
  student_id: string;
  role: string | null;
  service_hours: number;
  signed_in: number;
  remark: string | null;
  created_at: string;
  updated_at: string;
}

export type ActivityParticipantWritable = Omit<
  ActivityParticipantRecord,
  'record_id' | 'created_at' | 'updated_at'
>;

export const ActivityParticipantWritableFields: (keyof ActivityParticipantWritable)[] = [
  'activity_id',
  'student_id',
  'role',
  'service_hours',
  'signed_in',
  'remark',
];


// Honor（荣誉表彰记录）
export interface HonorRecord {
  honor_id: number;
  student_id: string | null;
  term_id: number | null;
  honor_title: string;
  honor_level: string | null;
  issue_date: string | null;
  issuer: string | null;
  description: string | null;
  certificate_url: string | null;
  certificate_key: string | null;
  created_at: string;
  updated_at: string;
}

export type HonorWritable = Omit<
  HonorRecord,
  'honor_id' | 'created_at' | 'updated_at'
>;

export const HonorWritableFields: (keyof HonorWritable)[] = [
  'student_id',
  'term_id',
  'honor_title',
  'honor_level',
  'issue_date',
  'issuer',
  'description',
  'certificate_url',
  'certificate_key',
];


// Announcement（公告）
export interface AnnouncementRecord {
  announcement_id: number;
  title: string;
  content: string;
  image_keys: string | null;
  author_id: string | null;
  term_id: number | null;
  publish_time: string | null;
  status: '草稿' | '已发布' | '归档';
  file_url: string | null;
  file_key: string | null;
  file_type: 'none' | 'pdf' | 'word';
  created_at: string;
  updated_at: string;
}

export type AnnouncementWritable = Omit<
  AnnouncementRecord,
  'announcement_id' | 'created_at' | 'updated_at'
>;

export const AnnouncementWritableFields: (keyof AnnouncementWritable)[] = [
  'title',
  'content',
  'image_keys',
  'author_id',
  'term_id',
  'publish_time',
  'status',
  'file_url',
  'file_key',
  'file_type',
];


// GalleryPhoto（团队相册/风采展示）
export interface GalleryPhotoRecord {
  photo_id: number;
  term_id: number | null;
  activity_id: number | null;
  title: string | null;
  image_url: string;
  image_key: string;
  description: string | null;
  uploaded_by: string | null;
  uploaded_at: string;
  sort_order: number | null;
}

export type GalleryPhotoWritable = Omit<
  GalleryPhotoRecord,
  'photo_id' | 'uploaded_at'
>;

export const GalleryPhotoWritableFields: (keyof GalleryPhotoWritable)[] = [
  'term_id',
  'activity_id',
  'title',
  'image_url',
  'image_key',
  'description',
  'uploaded_by',
  'sort_order',
];


// TeamMilestone（发展历程）
export interface TeamMilestoneRecord {
  milestone_id: number;
  term_id: number | null;
  title: string;
  description: string | null;
  event_date: string;
  event_type: string | null;
  image_url: string | null;
  image_key: string | null;
  created_by: string | null;
  created_at: string;
  updated_at: string;
}

export type TeamMilestoneWritable = Omit<
  TeamMilestoneRecord,
  'milestone_id' | 'created_at' | 'updated_at'
>;

export const TeamMilestoneWritableFields: (keyof TeamMilestoneWritable)[] = [
  'term_id',
  'title',
  'description',
  'event_date',
  'event_type',
  'image_url',
  'image_key',
  'created_by',
];


// OperationLog（操作日志）
export interface OperationLogRecord {
  log_id: number;
  user_id: string;
  action: string;
  target_table: string | null;
  target_id: string | null;
  description: string | null;
  ip_address: string | null;
  user_agent: string | null;
  created_at: string;
}

export type OperationLogWritable = Omit<
  OperationLogRecord,
  'log_id' | 'created_at'
>;

export const OperationLogWritableFields: (keyof OperationLogWritable)[] = [
  'user_id',
  'action',
  'target_table',
  'target_id',
  'description',
  'ip_address',
  'user_agent',
];

// EmailVerificationCode（邮箱验证码）
export interface EmailVerificationCodeRecord {
  id: number;
  email: string;
  code: string;
  type: string | null;
  expires_at: string;
  verified: number | null;
  created_at: string;
}

export type EmailVerificationCodeWritable = Omit<
  EmailVerificationCodeRecord,
  'id' | 'created_at'
>;

export const EmailVerificationCodeWritableFields: (keyof EmailVerificationCodeWritable)[] = [
  'email',
  'code',
  'type',
  'expires_at',
  'verified',
];
~~~

5.11.2 📁`src/types/requestTypes.ts`

~~~ts
// 注册请求体
export interface RegisterRequestBody {
  student_id: string;
  email: string;
  password: string;
  name: string;
  code: string;
}

// 登录请求体（loginInput 支持学号/邮箱）
export interface LoginRequestBody {
  loginInput: string;
  password: string;
}

// 重置密码请求体
export interface ResetPasswordRequestBody {
  email: string;
  oldPassword: string;
  newPassword: string;
  code: string;
}
~~~

#### 5.12 其他工具函数

5.12.1 📁`src/utils/dateUtil.ts`

当前没用上

```ts
/** 格式化时间为 "yyyy-MM-dd HH:mm:ss" 格式 */
export const formatDateTime = (date: Date | string | number): string => {
  const d = new Date(date);
  const pad = (n: number) => (n < 10 ? '0' + n : n); // 数字补零（确保单 digit 转为双 digit）

  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
};

/** 获取当前秒级时间戳（向下取整） */
export const nowTimestamp = (): number => Math.floor(Date.now() / 1000);
```



## 六、路由规划

📁`src/routers/index.ts`

~~~ts
import { Router } from 'express';

// 子模块路由引入
import publicRouter from './publicRouter';
import ossRouter from './ossRouter';
import emailRouter from './emailRouter';
import authLoginRouter from './auth/authLoginRouter';
import authInfoRouter from './auth/authInfoRouter';
import departmentsRouter from './departmentsRouter';
import teamTermsRouter from './teamTermsRouter';
import backboneMembersRouter from './backboneMembersRouter';
import activitiesRouter from './activitiesRouter';
import activityParticipantsRouter from './activityParticipantsRouter';
import honorRecordsRouter from './honorRecordsRouter';
import announcementsRouter from './announcementsRouter';
import galleryPhotosRouter from './galleryPhotosRouter';
import teamMilestonesRouter from './teamMilestonesRouter';
import operationLogsRouter from './operationLogsRouter';

// 创建主路由
const router = Router();

// 挂载子路由（统一添加路径前缀）
router.use('/public', publicRouter);
router.use('/oss', ossRouter);
router.use('/email', emailRouter);
router.use('/auth/login', authLoginRouter);
router.use('/auth/info', authInfoRouter);
router.use('/departments', departmentsRouter);
router.use('/team-terms', teamTermsRouter);
router.use('/backbone-members', backboneMembersRouter);
router.use('/activities', activitiesRouter);
router.use('/activity-participants', activityParticipantsRouter);
router.use('/honor-records', honorRecordsRouter);
router.use('/announcements', announcementsRouter);
router.use('/gallery-photos', galleryPhotosRouter);
router.use('/team-milestones', teamMilestonesRouter);
router.use('/operation-logs', operationLogsRouter);

export default router;
~~~



## 七、完善项目入口

📁`src/app.ts`

~~~ts
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import pool, { checkDatabaseConnection } from './db';
import { logMiddleware } from './middlewares/logMiddleware';
import { authenticateToken } from './middlewares/authMiddleware';
import { notFoundHandler, errorHandler } from './middlewares/errorHandler';
import router from './routers/index';

// 加载环境变量配置
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3302;
const NODE_ENV = process.env.NODE_ENV || 'development';
const allowedOrigins = process.env.CORS_ORIGINS?.split(',').map(origin => origin.trim()) || ['*'];

// 通用中间件配置
// CORS跨域：支持多域名白名单，开发环境允许所有来源
app.use(cors({
  origin: (origin, callback) => {
    if (!origin) return callback(null, true); // 无Origin请求（如Postman）直接放行
    if (NODE_ENV === 'development' || allowedOrigins.includes('*')) return callback(null, true);
    if (allowedOrigins.includes(origin)) return callback(null, true);

    console.warn(`🚫 拒绝跨域请求来源：${origin}`);
    return callback(new Error(`不允许的跨域来源：${origin}`));
  },
  credentials: true // 允许携带Cookie、Token
}));
app.use(express.json()); // 解析JSON请求体
app.use(express.urlencoded({ extended: false })); // 解析表单请求体

// 日志中间件：记录请求耗时、IP、用户信息等
app.use(logMiddleware);

// 路由配置
app.use(authenticateToken); // 所有接口统一经过Token验证（白名单逻辑内部处理）
app.use('/api', router); // 注册所有业务路由

// 错误处理中间件
app.use(notFoundHandler); // 捕获未命中路由（404）
app.use(errorHandler); // 全局错误统一处理

/** 启动服务器 */
const startServer = async () => {
  try {
    await checkDatabaseConnection(); // 检查数据库连接

    app.listen(PORT, () => {
      console.log(`🚀 API 服务器运行在 http://127.0.0.1:${PORT}`);
      console.log(`📅 启动时间: ${new Date().toLocaleString()}`);
      console.log(`📡 环境: ${NODE_ENV}`);
      console.log(`🗄️ 数据库: ${process.env.DB_NAME}@${process.env.DB_HOST}`);
    });
  } catch (err: any) {
    console.error('❌ 服务器启动失败:', err.message);
    process.exit(1);
  }
};

// 启动服务
startServer();

// 优雅关闭：处理Ctrl+C信号，关闭数据库连接池
process.on('SIGINT', async () => {
  console.log('\n🛑 正在关闭服务器...');
  await pool.end();
  console.log('✅ 数据库连接池已关闭');
  process.exit(0);
});
~~~



## 八、接口开发

### 8.1 获取OSS直传签名接口

#### 8.1.1 服务层

📁`ossSignatureService`

~~~TS
import crypto from 'crypto';
import { OSSConfig } from '../oss/ossConfig';

/**
 * 生成前端直传 OSS 的签名信息
 * @param dir 上传目录（如 "avatars/" "photos/"，默认 "uploads/"）
 * @param expireTime 签名过期时间（秒，默认 120 秒）
 * @returns OSS 直传所需签名配置
 */
export const generateOSSPolicy = (dir = 'uploads/', expireTime = 120) => {
  const now = Math.floor(Date.now() / 1000);
  const expireEnd = now + expireTime; // 签名过期时间戳
  const expiration = new Date(expireEnd * 1000).toISOString(); // OSS 要求的过期时间格式

  // 限制最大上传文件大小为 10MB
  const maxSize = 10 * 1024 * 1024;

  // 构建 OSS 上传策略（限制上传目录、文件大小）
  const policyText = {
    expiration,
    conditions: [
      ['content-length-range', 0, maxSize], // 文件大小范围
      ['starts-with', '$key', dir], // 上传文件路径前缀（限制目录）
      ['starts-with', '$Content-Disposition', ''], // 允许任意 Content-Disposition（包括 inline）
      ["eq", "$success_action_status", "200"], // 成功状态码必须为 200
    ]
  };

  // 策略 Base64 编码（OSS 要求格式）
  const policyBase64 = Buffer.from(JSON.stringify(policyText)).toString('base64');
  // HMAC-SHA1 签名（使用 OSS 访问密钥Secret）
  const signature = crypto
    .createHmac('sha1', OSSConfig.accessKeySecret)
    .update(policyBase64)
    .digest('base64');

  // 返回前端直传所需配置
  return {
    host: OSSConfig.baseUrl, // OSS 存储桶基础地址
    accessid: OSSConfig.accessKeyId, // 访问密钥ID
    signature, // 签名信息
    policy: policyBase64, // Base64 编码的策略
    expire: expireEnd, // 签名过期时间戳
    dir // 允许上传的目录
  };
};
~~~

#### 8.1.2 控制层

📁`ossSignatureController`

~~~TS
import { Request, Response } from 'express';
import { generateOSSPolicy } from '../services/ossSignatureService';
import { successResponse, errorResponse } from '../utils/response';

export const getOSSSignature = async (req: Request, res: Response) => {
  try {
    const { dir } = req.body;
    const result = generateOSSPolicy(dir as string || 'uploads/');
    successResponse(res, result, 'success');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.1.3 路由层

📁`ossSignatureRouter`

~~~ts
import express from 'express';
import { getOSSSignature } from '../controllers/ossSignatureController';

const router = express.Router();

/** 获取OSS直传签名 */
router.post('/signature', getOSSSignature);

export default router;
~~~

### 8.1 获取OSS直传签名（STS）

8.1.1 服务层

📁`stsService`

~~~ts
import PopCore = require('@alicloud/pop-core');
import { OSSConfig } from '../oss/ossConfig';

/**
 * 获取 OSS 上传用的 STS 临时凭证
 */
export const getSTSForOSS = async () => {
  // 强制断言为 any，干掉所有 TS 报错
  const client: any = new (PopCore as any).RPCClient({
    accessKeyId: OSSConfig.accessKeyId,
    accessKeySecret: OSSConfig.accessKeySecret,
    endpoint: 'https://sts.aliyuncs.com',
    apiVersion: '2015-04-01',
  });

  const params = {
    RegionId: 'cn-chengdu',
    RoleArn: OSSConfig.roleArn,
    RoleSessionName: `web-upload-${Date.now()}`,
    DurationSeconds: 3600,
    Policy: JSON.stringify({
      Version: '1',
      Statement: [
        {
          Effect: 'Allow',
          Action: ['oss:PutObject', 'oss:GetObject'],
          Resource: [`acs:oss:*:*:${OSSConfig.bucket}/uploads/*`],
        },
      ],
    }),
  };

  try {
    const result = await client.request('AssumeRole', params, { method: 'POST' });

    return {
      AccessKeyId: result.Credentials.AccessKeyId,
      AccessKeySecret: result.Credentials.AccessKeySecret,
      SecurityToken: result.Credentials.SecurityToken,
      Expiration: result.Credentials.Expiration,
      region: `oss-${OSSConfig.region}`,
      bucket: OSSConfig.bucket,
    };
  } catch (error: any) {
    console.error('STS 获取失败:', error);
    throw new Error(`获取 STS 凭证失败: ${error.message || error}`);
  }
};
~~~

#### 8.1.2 服务层

📁`stsController`

~~~ts
import { Request, Response } from 'express';
import { getSTSForOSS } from '../services/stsService';
import { successResponse, errorResponse } from '../utils/response';

export const getSTS = async (req: Request, res: Response) => {
  try {
    const sts = await getSTSForOSS();
    successResponse(res, sts, 'STS 获取成功');
  } catch (error: any) {
    console.error('STS 获取失败:', error);
    errorResponse(res, 'STS 获取失败', 500);
  }
};
~~~

#### 8.1.3 路由层

📁`stsRouter`

~~~ts
import express from 'express';
import { getSTS } from '../controllers/stsController';

const router = express.Router();

/** 获取 OSS 上传用的 STS 临时凭证 */
router.get('/sts', getSTS);

export default router;
~~~

### 8.2 邮箱接口

#### 8.2.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// EmailVerificationCode 校验
// ---------------------------
export const EmailVerificationCodeSchema: Record<string, FieldRule> = {
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isEmail(v),
    message: "邮箱格式错误"
  },
  code: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "验证码不能为空"
  },
  type: {
    type: "string",
    message: "type 必须为字符串或 null"
  },
  expires_at: {
    required: true,
    type: "date",
    message: "expires_at 必须为有效日期"
  },
  verified: {
    type: "number",
    validator: (v: unknown) => v === 0 || v === 1,
    message: "verified 必须为 0 或 1"
  }
};

// ---------------------------
// 发送验证码校验
// ---------------------------
export const SendEmailCodeSchema: Record<string, FieldRule> = {
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isCtbuEmail(v),
    message: "邮箱格式错误"
  },
  type: {
    type: "string",
    message: "type 必须为字符串或 null"
  }
};

// ---------------------------
// 验证验证码校验
// ---------------------------
export const VerifyEmailCodeSchema: Record<string, FieldRule> = {
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isCtbuEmail(v),
    message: "邮箱格式错误"
  },
  code: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "验证码不能为空"
  },
  type: {
    type: "string",
    message: "type 必须为字符串或 null"
  }
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * EmailVerificationCode
 * --------------------------- */
export const validateEmailVerificationCodeCreate = createValidator(EmailVerificationCodeSchema, "create");
export const validateEmailVerificationCodeUpdate = createValidator(EmailVerificationCodeSchema, "update");

/* ---------------------------
 * 发送验证码 | 验证验证码
 * --------------------------- */
export const validateSendEmailCode = createValidator(SendEmailCodeSchema, "create");
export const validateVerifyEmailCode = createValidator(VerifyEmailCodeSchema, "create");
```

#### 8.2.2 服务层

📁`emailService`

~~~ts
import { query } from '../db';
import dayjs from 'dayjs';
import {
  EmailVerificationCodeRecord,
  EmailVerificationCodeWritable,
  EmailVerificationCodeWritableFields
} from '../types/dbTypes';
import { sendVerificationCode as sendCodeEmail } from '../utils/emailUtil';

/** 生成6位随机数字验证码 */
const generateCode = (): string => {
  return Math.floor(100000 + Math.random() * 900000).toString();
};

/** 验证码有效期（5分钟） */
const CODE_EXPIRE_MINUTES = 5;

/** 检查邮箱同类型验证码是否过1分钟冷却时间 */
export const canSendCode = async (
  email: string,
  type: string
): Promise<boolean> => {
  const sql = `
    SELECT created_at
    FROM email_verification_codes
    WHERE email = ? AND type = ?
    ORDER BY created_at DESC
    LIMIT 1
  `;
  const rows: EmailVerificationCodeRecord[] = await query(sql, [email, type]);

  if (rows.length === 0) return true;

  const lastSendTime = dayjs(rows[0].created_at);
  return dayjs().diff(lastSendTime, 'second') > 60;
};

/** 发送邮箱验证码（含1分钟限流、存储验证码、发送邮件） */
export const sendVerificationCodeService = async (
  email: string,
  type = 'register'
) => {
  // 限流校验
  const canSend = await canSendCode(email, type);
  if (!canSend) throw new Error('发送过于频繁，请稍后再试');

  // 生成验证码与过期时间
  const code = generateCode();
  const expiresAt = dayjs()
    .add(CODE_EXPIRE_MINUTES, 'minute')
    .format('YYYY-MM-DD HH:mm:ss');

  // 构造入库数据
  const body: EmailVerificationCodeWritable = {
    email,
    code,
    type,
    expires_at: expiresAt,
    verified: 0
  };

  // 自动映射字段插入数据库
  const fields = EmailVerificationCodeWritableFields;
  const values = fields.map((f) => body[f] ?? null);

  const sql = `
    INSERT INTO email_verification_codes (${fields.join(', ')})
    VALUES (${fields.map(() => '?').join(', ')})
  `;

  await query(sql, values);

  // 发送邮件
  await sendCodeEmail(email, code);

  return { message: '验证码已发送' };
};

/** 验证邮箱验证码（校验有效性、过期时间，验证通过更新状态） */
export const verifyCodeService = async (
  email: string,
  code: string,
  type = 'register'
): Promise<boolean> => {
  const sql = `
    SELECT *
    FROM email_verification_codes
    WHERE email = ? AND type = ?
    ORDER BY created_at DESC
    LIMIT 1
  `;
  const rows: EmailVerificationCodeRecord[] = await query(sql, [email, type]);

  if (rows.length === 0) return false;

  const latestCode = rows[0];

  // 过期检查
  if (dayjs().isAfter(dayjs(latestCode.expires_at))) return false;

  // 验证码匹配检查
  if (latestCode.code !== code) return false;

  // 更新为已验证状态
  await query(
    `UPDATE email_verification_codes SET verified = 1 WHERE id = ?`,
    [latestCode.id]
  );

  return true;
};

/** 清理过期或已验证的验证码记录（支持按天数清理或默认清理过期/已验证记录） */
export const cleanupVerificationCodesService = async (
  daysBefore?: number
): Promise<number> => {
  let sql: string;
  let params: any[] = [];

  if (daysBefore) {
    sql = `
      DELETE FROM email_verification_codes
      WHERE created_at < DATE_SUB(NOW(), INTERVAL ? DAY)
    `;
    params = [daysBefore];
  } else {
    sql = `
      DELETE FROM email_verification_codes
      WHERE expires_at < NOW() OR verified = 1
    `;
  }

  const result: any = await query(sql, params);

  // 兼容不同数据库客户端的影响行数返回格式
  return result?.affectedRows ?? result?.changes ?? 0;
};
~~~

#### 8.2.3 控制层

📁`emailController`

~~~ts
import { Request, Response } from 'express';
import {
  sendVerificationCodeService,
  verifyCodeService,
  cleanupVerificationCodesService,
} from '../services/emailService';
import { successResponse, errorResponse, HTTP_STATUS } from '../utils/response';

/** 发送邮箱验证码 */
export const sendVerificationCodeController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { email, type = 'register' } = req.body;

    if (!email) {
      errorResponse(res, '邮箱不能为空', HTTP_STATUS.BAD_REQUEST);
      return;
    }

    await sendVerificationCodeService(email, type);
    successResponse(res, null, '验证码已发送，请查收邮箱');
  } catch (error: any) {
    console.error('❌ 发送验证码失败:', error.message);
    errorResponse(res, error.message || '发送验证码失败', HTTP_STATUS.INTERNAL_ERROR);
  }
};

/** 验证邮箱验证码 */
export const verifyEmailCodeController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { email, code, type = 'register' } = req.body;

    if (!email || !code) {
      errorResponse(res, '邮箱和验证码不能为空', HTTP_STATUS.BAD_REQUEST);
      return;
    }

    const isValid = await verifyCodeService(email, code, type);
    if (!isValid) {
      errorResponse(res, '验证码无效或已过期', HTTP_STATUS.BAD_REQUEST);
      return;
    }

    successResponse(res, null, '邮箱验证成功');
  } catch (error: any) {
    console.error('❌ 验证邮箱验证码失败:', error.message);
    errorResponse(res, '验证失败，请稍后再试', HTTP_STATUS.INTERNAL_ERROR);
  }
};

/** 清理验证码记录 */
export const cleanupVerificationCodesController = async (req: Request, res: Response): Promise<void> => {
  try {
    const daysBefore = req.query.daysBefore ? Number(req.query.daysBefore) : undefined;
    const deletedCount = await cleanupVerificationCodesService(daysBefore);

    successResponse(res, { deleted: deletedCount }, `清理完成，共删除 ${deletedCount} 条记录`);
  } catch (error: any) {
    console.error('❌ 清理验证码记录失败:', error.message);
    errorResponse(res, '清理失败，请稍后再试', HTTP_STATUS.INTERNAL_ERROR);
  }
};
~~~

#### 8.2.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { sendVerificationCodeController, verifyEmailCodeController } from '../controllers/emailController';

import {
  validateSendEmailCode,
  validateVerifyEmailCode,
} from '../validators/validateRequest';

const router = express.Router();

/** 发送验证码 */
router.post('/email/send', validateSendEmailCode, sendVerificationCodeController);

/** 校验验证码 */
router.post('/email/verify', validateVerifyEmailCode, verifyEmailCodeController);

export default router;
~~~

📁`emailRouter`

~~~ts
import express from 'express';
import { cleanupVerificationCodesController } from '../controllers/emailController';
import { authorizeRole } from '../middlewares/authMiddleware';

const router = express.Router();

// 清理验证码记录
router.delete('/cleanup', authorizeRole('admin', 'superadmin'), cleanupVerificationCodesController);

export default router;
~~~

### 8.3 注册/登录接口

#### 8.3.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// AuthLogin 校验
// ---------------------------
export const AuthLoginSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号必须为10位数字",
  },
  email: {
    required: true,
    validator: (v: unknown) =>
      typeof v === "string" && (isCtbuEmail(v) || isEmail(v)),
    message: "邮箱格式错误（必须为有效邮箱）",
  },
  password_hash: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "密码不能为空",
  },
  role: {
    required: true,
    type: "enum",
    enumValues: ["user", "admin", "superadmin"],
    message: "角色必须为 user、admin 或 superadmin",
  },
};

// ---------------------------
// 注册校验
// ---------------------------
export const RegistrationSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号格式错误（必须为10位数字）",
  },
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isCtbuEmail(v),
    message: "邮箱格式错误（必须为 @ctbu.edu.cn）",
  },
  password: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStrongPassword(v),
    message: "密码强度不符合要求",
  },
  name: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "姓名不能为空",
  },
  code: {
    required: true,
    validator: (v) => typeof v === "string" && v.length > 0,
    message: "验证码不能为空",
  }
};

// ---------------------------
// 登录校验
// ---------------------------
export const LoginSchema: Record<string, FieldRule> = {
  loginInput: {
    required: true,
    validator: (v: unknown) =>
      typeof v === "string" &&
      (isStudentId(v) || isCtbuEmail(v) || isEmail(v)),
    message: "学号或邮箱格式错误",
  },
  password: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "密码不能为空",
  },
};

// ---------------------------
// 批量注册校验
// ---------------------------
export const BatchRegistrationSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号格式错误（必须为10位数字）",
  },
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isCtbuEmail(v),
    message: "邮箱格式错误（必须为 @ctbu.edu.cn）",
  },
  password: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStrongPassword(v),
    message: "密码强度不符合要求",
  },
  name: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "姓名不能为空",
  }
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * AuthLogin
 * --------------------------- */
export const validateAuthLoginCreate = createValidator(AuthLoginSchema, "create");
export const validateAuthLoginUpdate = createValidator(AuthLoginSchema, "update");

/* ---------------------------
 * 注册 | 批量注册
 * --------------------------- */
export const validateRegistration = createValidator(RegistrationSchema, "create");
export const validateBatchRegister = createBatchValidator(BatchRegistrationSchema, "create");

/* ---------------------------
 * 登录
 * --------------------------- */
export const validateLogin = createValidator(LoginSchema, "create");
```

#### 8.3.2 服务层

📁`authLoginService`

~~~ts
import { query } from '../../db';
import { hashPassword, comparePassword } from '../../utils/bcryptUtil';
import { signToken } from '../../utils/tokenUtil';
import { HTTP_STATUS } from '../../utils/response';
import { sendWelcomeEmail } from '../../utils/emailUtil';
import { AuthLoginRecord, AuthLoginWritable, AuthLoginWritableFields } from '../../types/dbTypes';
import { RegisterRequestBody, LoginRequestBody, ResetPasswordRequestBody } from '../../types/requestTypes';

/** 构建 auth_login 表 INSERT SQL */
const buildInsertSQL = (data: AuthLoginWritable) => {
  const fields = AuthLoginWritableFields;
  const placeholders = fields.map(() => "?").join(",");
  const values = fields.map((key) => data[key]);

  const sql = `INSERT INTO auth_login (${fields.join(",")}) VALUES (${placeholders})`;
  return { sql, values };
};

/** 用户注册（需邮箱验证码校验，仅支持 ctbu.edu.cn 邮箱） */
export const registerUser = async (body: RegisterRequestBody) => {
  const { student_id, email, password, name, code } = body;

  if (!email.endsWith('@ctbu.edu.cn')) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '邮箱必须以 @ctbu.edu.cn 结尾' };
  }

  const [existingUser] = await query<AuthLoginRecord[]>(
    'SELECT * FROM auth_login WHERE student_id = ? OR email = ?',
    [student_id, email]
  );

  if (existingUser) {
    throw { status: HTTP_STATUS.CONFLICT, message: '该学号或邮箱已注册' };
  }

  const [verifyRecord] = await query<any[]>(
    `SELECT * FROM email_verification_codes 
     WHERE email = ? AND code = ? AND type = 'register'
     ORDER BY id DESC LIMIT 1`,
    [email, code]
  );

  if (!verifyRecord) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码错误或未发送' };
  }

  if (new Date(verifyRecord.expires_at) < new Date()) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码已过期' };
  }

  if (verifyRecord.verified === 1) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码已被使用，请重新获取' };
  }

  await query(`UPDATE email_verification_codes SET verified = 1 WHERE id = ?`, [
    verifyRecord.id,
  ]);

  const password_hash = await hashPassword(password);

  const writable: AuthLoginWritable = {
    role: 'user',
    student_id,
    email,
    password_hash
  };
  const { sql, values } = buildInsertSQL(writable);
  await query(sql, values);

  await query(`INSERT INTO auth_info (student_id, name) VALUES (?, ?)`, [
    student_id,
    name,
  ]);

  sendWelcomeEmail(email, name);
  return { message: '注册成功' };
};

/** 用户登录（loginInput 支持学号/邮箱） */
export const loginUser = async (body: LoginRequestBody) => {
  const { loginInput, password } = body;

  const [user] = await query<AuthLoginRecord[]>(
    `SELECT * FROM auth_login WHERE email = ? OR student_id = ?`,
    [loginInput, loginInput]
  );

  if (!user) {
    throw { status: HTTP_STATUS.UNAUTHORIZED, message: '用户不存在' };
  }

  const isMatch = await comparePassword(password, user.password_hash);
  if (!isMatch) {
    throw { status: HTTP_STATUS.UNAUTHORIZED, message: '密码错误' };
  }

  const token = signToken({
    auth_id: user.auth_id,
    student_id: user.student_id,
    email: user.email,
    role: user.role,
  });

  return {
    token,
    student_id: user.student_id,
    email: user.email,
    role: user.role,
  };
};

/** 批量注册用户（管理员专用，无需验证码） */
export const batchRegisterUsers = async (users: RegisterRequestBody[]) => {
  if (!Array.isArray(users) || users.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '请求体必须为非空数组' };
  }

  const results: { student_id: string; email: string; status: string; reason?: string }[] = [];

  for (const user of users) {
    const { student_id, email, password, name } = user;

    try {
      const [existing] = await query<AuthLoginRecord[]>(
        `SELECT * FROM auth_login WHERE student_id = ? OR email = ?`,
        [student_id, email]
      );

      if (existing) {
        results.push({ student_id, email, status: 'failed', reason: '该学号或邮箱已注册' });
        continue;
      }

      const password_hash = await hashPassword(password);

      const writable: AuthLoginWritable = {
        role: 'user',
        student_id,
        email,
        password_hash,
      };

      const { sql, values } = buildInsertSQL(writable);
      await query(sql, values);

      await query(`INSERT INTO auth_info (student_id, name) VALUES (?, ?)`, [
        student_id,
        name,
      ]);

      results.push({ student_id, email, status: 'success' });
    } catch (err: any) {
      results.push({ student_id, email, status: 'failed', reason: err.message });
    }
  }

  return {
    message: '批量注册完成',
    total: users.length,
    success: results.filter(r => r.status === 'success').length,
    failed: results.filter(r => r.status === 'failed').length,
    details: results,
  };
};
~~~

#### 8.3.3 控制层

📁`authLoginController`

~~~ts
import { Request, Response } from 'express';
import { registerUser, loginUser, batchRegisterUsers } from '../../services/auth/authLoginService';
import { successResponse, errorResponse } from '../../utils/response';

/** 注册接口控制器 */
export const registerController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await registerUser(req.body);
    successResponse(res, result, '注册成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 登录接口控制器 */
export const loginController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await loginUser(req.body);
    successResponse(res, result, '登录成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量注册接口控制器（管理员专用） */
export const batchRegisterController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchRegisterUsers(req.body);
    successResponse(res, result, '批量注册成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.3.4 路由层

📁`publicRouter`

~~~ts
import { loginController, registerController } from '../controllers/auth/authLoginController';
import {
  validateRegistration,
  validateLogin,
} from '../validators/validateRequest';

/** 注册 */
router.post('/auth/register', validateRegistration, registerController);

/** 登录 */
router.post('/auth/login', validateLogin, loginController);
~~~

📁`authLoginRouter`

~~~ts
import express from 'express';
import { batchRegisterController } from '../../controllers/auth/authLoginController';
import { authorizeRole } from '../../middlewares/authMiddleware';
import { validateBatchRegister } from '../../validators/validateRequest';

const router = express.Router();

/** 批量注册 */
router.post('/batch-register', authorizeRole('admin', 'superadmin'), validateBatchRegister, batchRegisterController);
~~~

### 8.4 删除用户接口

#### 8.4.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// 批量删除用户校验
// ---------------------------
export const BatchDeleteAuthSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号格式错误",
  }
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * 批量删除用户
 * --------------------------- */
export const validateBatchDelete = (req: Request, res: Response, next: NextFunction) => {
  const { studentIds } = req.body;

  if (!Array.isArray(studentIds) || studentIds.length === 0) {
    errorResponse(res, "请求体必须为非空数组", HTTP_STATUS.BAD_REQUEST);
    return;
  }
  
  // 转换成规范格式 [{ student_id: "xxxxx" }]
  req.body = studentIds.map((id: string) => ({ student_id: id }));

  return createBatchValidator(BatchDeleteAuthSchema)(req, res, next);
};
```

#### 8.4.2 服务层

📁`authLoginService`

~~~ts
/** 按学号删除单个用户 */
export const deleteUserByStudentId = async (student_id: string) => {
  if (!student_id) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '学号不能为空' };
  }

  const [existing]: any = await query(`SELECT * FROM auth_login WHERE student_id = ?`, [
    student_id,
  ]);

  if (!existing || existing.length === 0) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '用户不存在' };
  }

  await query(`DELETE FROM auth_info WHERE student_id = ?`, [student_id]);
  await query(`DELETE FROM auth_login WHERE student_id = ?`, [student_id]);

  return { message: `用户 ${student_id} 删除成功` };
};

/** 批量删除用户（传入学号数组） */
export const batchDeleteUsers = async (studentIds: string[]) => {
  if (!Array.isArray(studentIds) || studentIds.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '请求体必须为非空学号数组' };
  }

  let successCount = 0;
  const results: { student_id: string; status: string; reason?: string }[] = [];

  for (const student_id of studentIds) {
    try {
      const [existing]: any = await query(
        `SELECT * FROM auth_login WHERE student_id = ?`,
        [student_id]
      );

      if (!existing || existing.length === 0) {
        results.push({ student_id, status: 'failed', reason: '用户不存在' });
        continue;
      }

      await query(`DELETE FROM auth_info WHERE student_id = ?`, [student_id]);
      await query(`DELETE FROM auth_login WHERE student_id = ?`, [student_id]);

      results.push({ student_id, status: 'success' });
      successCount++;
    } catch (err: any) {
      results.push({ student_id, status: 'failed', reason: err.message });
    }
  }

  return {
    message: '批量删除完成',
    total: studentIds.length,
    success: successCount,
    failed: results.length - successCount,
    details: results,
  };
};

~~~

#### 8.4.3 控制层

📁`authLoginController`

~~~ts
import { Request, Response } from 'express';
import { deleteUserByStudentId, batchDeleteUsers } from '../../services/auth/authLoginService';
import { successResponse, errorResponse } from '../../utils/response';

/** 单个用户删除控制器（按学号） */
export const deleteUserController = async (req: Request, res: Response) => {
  try {
    const { student_id } = req.params;
    const result = await deleteUserByStudentId(student_id);
    successResponse(res, result, '用户删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量删除用户控制器（传入学号数组） */
export const batchDeleteUsersController = async (req: Request, res: Response) => {
  try {
    const studentIds = req.body.studentIds;
    const result = await batchDeleteUsers(studentIds);
    successResponse(res, result, '批量删除完成');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

~~~

#### 8.4.4 路由层

📁`authLoginRouter`

~~~ts
import express from 'express';
import { deleteUserController, batchDeleteUsersController } from '../../controllers/auth/authLoginController';
import { authorizeRole } from '../../middlewares/authMiddleware'
import { validateBatchDelete } from '../../validators/validateRequest';

const router = express.Router();

/** 删除单个用户 */
router.delete('/delete/:student_id', authorizeRole('superadmin'), deleteUserController);

/** 批量删除 */
router.post('/delete/batch', authorizeRole('superadmin'), validateBatchDelete, batchDeleteUsersController);

export default router;
~~~

### 8.5 用户信息管理接口

#### 8.5.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// AuthInfo 校验
// ---------------------------
export const AuthInfoSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号格式错误",
  },
  name: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length > 0,
    message: "姓名不能为空",
  },
  gender: {
    type: "enum",
    enumValues: ["男", "女", "其他"],
    message: "性别不合法",
  },
  college: {
    type: "string",
    message: "学院必须为字符串",
  },
  major: {
    type: "string",
    message: "专业必须为字符串",
  },
  phone: {
    validator: (v: unknown) => typeof v === "string" ? isPhone(v) : true,
    message: "手机号格式不正确",
  },
  avatar_url: {
    type: "string",
    message: "头像 URL 必须为字符串"
  },
  avatar_key: {
    type: "string",
    message: "头像 key 必须为字符串"
  },
  join_date: {
    type: "date",
    message: "入队日期格式错误"
  },
  total_hours: {
    type: "number",
    message: "总服务时长必须为数字"
  },
  skill_tags: {
    type: "string",
    message: "技能标签必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * AuthInfo
 * --------------------------- */
export const validateAuthInfoCreate = createValidator(AuthInfoSchema, "create");
export const validateAuthInfoUpdate = createValidator(AuthInfoSchema, "update");
export const validateBatchAuthInfoCreate = createBatchValidator(AuthInfoSchema, "create");
```

#### 8.5.2 服务层

📁`authInfoService`

~~~ts
import { query } from '../../db';
import {
  AuthInfoRecord,
  AuthInfoWritable,
  AuthInfoWritableFields
} from '../../types/dbTypes';
import { HTTP_STATUS } from '../../utils/response';
import { OSSConfig } from '../../oss/ossConfig';
import { deleteFileFromOSS } from '../../oss/deleteService';

/** 更新用户信息（支持头像OSS旧文件自动删除，自动映射更新字段） */
export const updateUserInfo = async (
  student_id: string,
  body: Partial<AuthInfoWritable>
) => {
  if (!student_id) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '学号不能为空' };
  }

  const [existing]: any = await query(
    `SELECT * FROM auth_info WHERE student_id = ?`,
    [student_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '用户信息不存在' };
  }

  // 头像更新时删除OSS旧文件
  if (body.avatar_url && body.avatar_url !== existing.avatar_url) {
    if (existing.avatar_url && existing.avatar_url.startsWith(OSSConfig.baseUrl)) {
      const objectKey = existing.avatar_url.replace(OSSConfig.baseUrl, '');
      try {
        await deleteFileFromOSS(objectKey);
      } catch (err) {
        console.warn('⚠️ 删除旧头像失败（不影响整体更新）:', err);
      }
    }
  }

  // 自动构建更新SQL
  const updates: string[] = [];
  const values: any[] = [];

  for (const field of AuthInfoWritableFields) {
    const value = body[field];
    if (value !== undefined && value !== null) {
      updates.push(`${field} = ?`);
      values.push(value);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新的字段' };
  }

  const sql = `UPDATE auth_info SET ${updates.join(', ')} WHERE student_id = ?`;
  await query(sql, [...values, student_id]);

  return { message: `用户 ${student_id} 信息更新成功` };
};

/** 查询单个用户信息（关联账号表，返回邮箱、角色等完整信息） */
export const getUserInfo = async (student_id: string) => {
  if (!student_id) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '学号不能为空' };
  }

  const sql = `
    SELECT 
      i.student_id,
      i.name,
      i.gender,
      i.college,
      i.major,
      i.phone,
      i.avatar_url,
      i.join_date,
      i.total_hours,
      i.skill_tags,
      i.created_at AS info_created_at,
      i.updated_at AS info_updated_at,
      l.email,
      l.role,
      l.created_at AS account_created_at,
      l.updated_at AS account_updated_at
    FROM auth_info i
    JOIN auth_login l ON i.student_id = l.student_id
    WHERE i.student_id = ?;
  `;

  const [user]: any = await query(sql, [student_id]);

  if (!user) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '未找到该用户信息' };
  }

  return user;
};

/** 查询所有用户信息（管理员专用，关联账号表基础信息） */
export const getAllUsersInfo = async () => {
  const sql = `
    SELECT 
      i.student_id,
      i.name,
      i.gender,
      i.college,
      i.major,
      i.phone,
      i.avatar_url,
      i.join_date,
      i.total_hours,
      i.skill_tags,
      l.email,
      l.role,
      i.created_at AS info_created_at,
      l.created_at AS account_created_at
    FROM auth_info i
    JOIN auth_login l ON i.student_id = l.student_id
    ORDER BY i.student_id ASC;
  `;

  const rows: any[] = await query(sql);

  return {
    total: rows.length,
    data: rows
  };
};

/** 批量更新用户信息（管理员专用，仅更新已有用户，不新增） */
export const batchImportUsersInfo = async (
  users: Partial<AuthInfoWritable>[]
) => {
  if (!Array.isArray(users) || users.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请求体必须为非空用户信息数组'
    };
  }

  const results: {
    student_id: string;
    status: string;
    reason?: string;
  }[] = [];

  for (const user of users) {
    const student_id = user.student_id;

    if (!student_id) {
      results.push({
        student_id: '未知',
        status: 'failed',
        reason: '缺少学号'
      });
      continue;
    }

    try {
      const [existing]: any = await query(
        `SELECT * FROM auth_info WHERE student_id = ?`,
        [student_id]
      );

      if (!existing) {
        results.push({
          student_id,
          status: 'skipped',
          reason: '用户不存在，未更新'
        });
        continue;
      }

      const updates: string[] = [];
      const values: any[] = [];

      // 自动构建更新字段
      for (const field of AuthInfoWritableFields) {
        const val = user[field];
        if (val !== undefined && val !== null) {
          updates.push(`${field} = ?`);
          values.push(val);
        }
      }

      if (updates.length === 0) {
        results.push({
          student_id,
          status: 'skipped',
          reason: '无可更新字段'
        });
        continue;
      }

      const sql = `UPDATE auth_info SET ${updates.join(', ')} WHERE student_id = ?`;
      await query(sql, [...values, student_id]);

      results.push({ student_id, status: 'updated' });
    } catch (err: any) {
      results.push({
        student_id,
        status: 'failed',
        reason: err.message || '未知错误'
      });
    }
  }

  return {
    message: '批量信息更新完成',
    total: users.length,
    updated: results.filter(r => r.status === 'updated').length,
    skipped: results.filter(r => r.status === 'skipped').length,
    failed: results.filter(r => r.status === 'failed').length,
    details: results
  };
};
~~~

#### 8.5.3 控制层

📁`authInfoController`

~~~ts
import { Request, Response } from 'express';
import {
  updateUserInfo,
  getUserInfo,
  getAllUsersInfo,
  batchImportUsersInfo
} from '../../services/auth/authInfoService';
import { successResponse, errorResponse, HTTP_STATUS } from '../../utils/response';

/** 更新用户信息 */
export const updateUserInfoController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { student_id } = req.params;
    const user = (req as any).user;

    if (user.role !== 'admin' && user.role !== 'superadmin' && user.student_id !== student_id) {
      errorResponse(res, '权限不足，不能修改他人信息', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await updateUserInfo(student_id, req.body);
    successResponse(res, result, '用户信息更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 查询单个用户信息 */
export const getUserInfoController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { student_id } = req.params;
    const user = (req as any).user;

    if (user.role !== 'admin' && user.role !== 'superadmin' && user.student_id !== student_id) {
      errorResponse(res, '权限不足，不能查看他人信息', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await getUserInfo(student_id);
    successResponse(res, result, '查询用户信息成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 查询所有用户信息 */
export const getAllUsersInfoController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await getAllUsersInfo();
    successResponse(res, result, '查询所有用户信息成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量更新用户信息 */
export const batchImportUsersInfoController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchImportUsersInfo(req.body);
    successResponse(res, result, '批量更新用户信息成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.5.4 路由层

📁`authInfoRouter`

~~~ts
import express from 'express';
import {
  updateUserInfoController,
  getUserInfoController,
  getAllUsersInfoController,
  batchImportUsersInfoController
} from '../../controllers/auth/authInfoController';

import { authorizeRole } from '../../middlewares/authMiddleware';
import {
  validateAuthInfoUpdate,
  validateBatchAuthInfoCreate,
} from '../../validators/validateRequest';

const router = express.Router();

/** 更新单个用户信息 */
router.put('/update/:student_id', validateAuthInfoUpdate, updateUserInfoController);

/** 查询单个用户信息 */
router.get('/info/:student_id', getUserInfoController);

/** 查询所有用户信息 */
router.get('/all', authorizeRole('admin', 'superadmin'), getAllUsersInfoController);

/** 批量导入 / 更新用户信息 */
router.post('/batch-import', authorizeRole('admin', 'superadmin'), validateBatchAuthInfoCreate, batchImportUsersInfoController);

export default router;
~~~

### 8.6 修改密码接口

#### 8.6.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// 修改密码校验
// ---------------------------
export const ChangePasswordSchema: Record<string, FieldRule> = {
  email: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isCtbuEmail(v),
    message: "邮箱格式不正确",
  },
  oldPassword: {
    required: true,
    validator: (v) => typeof v === "string" && v.length > 0,
    message: "旧密码不能为空",
  },
  newPassword: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStrongPassword(v),
    message: "新密码强度不符合要求",
  },
  code: {
    required: true,
    validator: (v) => typeof v === "string" && v.length > 0,
    message: "验证码不能为空",
  }
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * 修改密码
 * --------------------------- */
export const validateChangePassword = (req: Request, res: Response, next: NextFunction) => {
  const validator = createValidator(ChangePasswordSchema);

  const error = validator.syncValidate(req.body);
  if (error) {
    errorResponse(res, error, HTTP_STATUS.BAD_REQUEST);
    return;
  }

  const { oldPassword, newPassword } = req.body;
  if (oldPassword === newPassword) {
    errorResponse(res, "新旧密码不能一致", HTTP_STATUS.BAD_REQUEST);
    return;
  }

  next();
};
```

#### 8.6.2 服务层

📁`authLoginService`

~~~ts
import { query } from '../../db';
import { hashPassword, comparePassword } from '../../utils/bcryptUtil';
import { ResetPasswordRequestBody } from '../../types/requestTypes';
import { HTTP_STATUS } from '../../utils/response';
import { sendPasswordChangedEmail } from '../../utils/emailUtil';

/** 修改密码（需验证旧密码+重置密码验证码） */
export const changePassword = async (body: ResetPasswordRequestBody) => {
  const { email, oldPassword, newPassword, code } = body;

  const [user] = await query<AuthLoginRecord[]>(
    `SELECT * FROM auth_login WHERE email = ?`,
    [email]
  );

  if (!user) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '用户不存在' };
  }

  const isMatch = await comparePassword(oldPassword, user.password_hash);
  if (!isMatch) {
    throw { status: HTTP_STATUS.UNAUTHORIZED, message: '旧密码错误' };
  }

  const [verifyRecord] = await query<any[]>(
    `SELECT * FROM email_verification_codes 
     WHERE email = ? AND code = ? AND type = 'reset_password'
     ORDER BY id DESC LIMIT 1`,
    [email, code]
  );

  if (!verifyRecord) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码错误或未发送' };
  }

  if (new Date(verifyRecord.expires_at) < new Date()) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码已过期' };
  }

  if (verifyRecord.verified === 1) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '验证码已被使用，请重新获取' };
  }

  await query(`UPDATE email_verification_codes SET verified = 1 WHERE id = ?`, [
    verifyRecord.id,
  ]);

  const newPasswordHash = await hashPassword(newPassword);
  await query(`UPDATE auth_login SET password_hash = ? WHERE email = ?`, [
    newPasswordHash,
    email,
  ]);

  sendPasswordChangedEmail(email, user.student_id);

  return { message: '密码修改成功' };
};
~~~

#### 8.6.3 控制层

📁`authLoginController`

~~~ts
import { Request, Response } from 'express';
import { changePassword } from '../../services/auth/authLoginService';
import { successResponse, errorResponse } from '../../utils/response';

/** 修改密码接口控制器 */
export const changePasswordController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await changePassword(req.body);
    successResponse(res, result, '密码修改成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.6.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { changePasswordController } from '../../controllers/auth/authLoginController';
import { validateChangePassword } from '../../validators/validateRequest';

const router = express.Router();

/** 修改密码 */
router.post('/change-password', validateChangePassword, changePasswordController);

export default router;
~~~

### 8.7 部门管理接口

#### 8.7.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// Department 校验
// ---------------------------
export const DepartmentSchema: Record<string, FieldRule> = {
  dept_name: {
    required: true,
    message: "部门名称不能为空"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  leader_id: {
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "部门负责人学号格式错误"
  },
  manager_id: {
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "上级负责人学号格式错误"
  },
  display_order: {
    type: "number",
    message: "排序必须为数字"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * Department
 * --------------------------- */
export const validateDepartmentCreate = createValidator(DepartmentSchema, "create");
export const validateDepartmentUpdate = createValidator(DepartmentSchema, "update");
export const validateBatchDepartmentCreate = createBatchValidator(DepartmentSchema, "create");
```

#### 8.7.2 服务层

📁`departmentsService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  DepartmentRecord,
  DepartmentWritable,
  DepartmentWritableFields
} from '../types/dbTypes';

/** 创建部门（自动映射字段，校验名称唯一性） */
export const createDepartment = async (body: Partial<DepartmentWritable>) => {
  if (!body.dept_name) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '部门名称不能为空' };
  }

  // 检查重名
  const [exists]: any = await query(
    `SELECT dept_id FROM departments WHERE dept_name = ?`,
    [body.dept_name]
  );
  if (exists) {
    throw { status: HTTP_STATUS.CONFLICT, message: '该部门名称已存在' };
  }

  // 自动构建字段
  const fields: string[] = [];
  const placeholders: string[] = [];
  const values: any[] = [];

  for (const field of DepartmentWritableFields) {
    const val = body[field];
    if (val !== undefined) {
      fields.push(field);
      placeholders.push('?');
      values.push(val === '' ? null : val);
    }
  }

  const sql = `
    INSERT INTO departments (${fields.join(', ')})
    VALUES (${placeholders.join(', ')})
  `;

  const result: any = await query(sql, values);

  return { dept_id: result.insertId, ...body };
};

/** 获取所有部门（同时关联出部门负责人和上级负责人的姓名） */
export const getAllDepartments = async () => {
  const sql = `
    SELECT 
      d.*,
      l.name AS leader_name,
      m.name AS manager_name
    FROM departments d
    LEFT JOIN auth_info l ON d.leader_id = l.student_id
    LEFT JOIN auth_info m ON d.manager_id = m.student_id
    ORDER BY d.display_order DESC, d.dept_id ASC
  `;

  const rows: DepartmentRecord[] = await query(sql);

  return {
    total: rows.length,
    data: rows
  };
};

/** 获取单个部门详情 */
export const getDepartmentById = async (dept_id: number) => {
  const sql = `
    SELECT 
      d.*,
      l.name AS leader_name,
      m.name AS manager_name
    FROM departments d
    LEFT JOIN auth_info l ON d.leader_id = l.student_id
    LEFT JOIN auth_info m ON d.manager_id = m.student_id
    WHERE d.dept_id = ?
  `;

  const [department]: DepartmentRecord[] = await query(sql, [dept_id]);

  if (!department) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '未找到该部门信息' };
  }

  return department;
};

/** 更新部门（支持更新 manager_id） */
export const updateDepartment = async (dept_id: number, body: Partial<DepartmentWritable>) => {
  const [exists]: any = await query(`SELECT 1 FROM departments WHERE dept_id = ?`, [dept_id]);
  if (!exists) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '部门不存在' };
  }

  // 如果更新了 dept_name 也要检查重名（排除自己）
  if (body.dept_name) {
    const [nameExists]: any = await query(
      `SELECT dept_id FROM departments WHERE dept_name = ? AND dept_id != ?`,
      [body.dept_name, dept_id]
    );
    if (nameExists) {
      throw { status: HTTP_STATUS.CONFLICT, message: '该部门名称已存在' };
    }
  }

  const updates: string[] = [];
  const values: any[] = [];

  for (const field of DepartmentWritableFields) {
    const val = body[field];
    if (val !== undefined) {
      updates.push(`${field} = ?`);
      values.push(val === '' ? null : val);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新的字段' };
  }

  const sql = `UPDATE departments SET ${updates.join(', ')} WHERE dept_id = ?`;
  await query(sql, [...values, dept_id]);

  return { message: '部门信息更新成功' };
};

/** 按ID删除部门 */
export const deleteDepartment = async (dept_id: number) => {
  const sql = `DELETE FROM departments WHERE dept_id = ?`;
  const result: any = await query(sql, [dept_id]);

  if (result.affectedRows === 0) {
    throw {
      status: HTTP_STATUS.NOT_FOUND,
      message: '部门不存在或已被删除'
    };
  }

  return { message: `部门 ${dept_id} 删除成功` };
};

/** 批量创建部门（自动映射字段，校验名称唯一性，返回创建/跳过详情） */
export const batchCreateDepartments = async (
  departments: Partial<DepartmentWritable>[]
) => {
  if (!Array.isArray(departments) || departments.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请求体必须为非空部门数组'
    };
  }

  const created: any[] = [];
  const skipped: any[] = [];

  for (const [index, body] of departments.entries()) {
    if (!body || !body.dept_name) {
      skipped.push({
        index: index + 1,
        reason: '部门名称不能为空'
      });
      continue;
    }

    // 检查重名
    const [exists]: any = await query(
      `SELECT dept_id FROM departments WHERE dept_name = ?`,
      [body.dept_name]
    );

    if (exists) {
      skipped.push({
        dept_name: body.dept_name,
        reason: '部门名称已存在'
      });
      continue;
    }

    // 自动构建字段
    const fields: string[] = [];
    const placeholders: string[] = [];
    const values: any[] = [];

    for (const field of DepartmentWritableFields) {
      const val = body[field];
      if (val !== undefined) {
        fields.push(field);
        placeholders.push('?');
        values.push(val);
      }
    }

    const sql = `
      INSERT INTO departments (${fields.join(', ')})
      VALUES (${placeholders.join(', ')})
    `;

    const result: any = await query(sql, values);

    created.push({
      dept_id: result.insertId,
      ...body
    });
  }

  return {
    message: '批量部门创建完成',
    total: departments.length,
    created: created.length,
    skipped: skipped.length,
    details: { created, skipped }
  };
};
~~~

#### 8.7.3 控制层

📁`departmentsController`

~~~ts
import { Request, Response } from 'express';
import {
  createDepartment,
  getAllDepartments,
  getDepartmentById,
  updateDepartment,
  deleteDepartment,
  batchCreateDepartments
} from '../services/departmentsService';
import { successResponse, errorResponse, HTTP_STATUS } from '../utils/response';

/** 创建部门 */
export const createDepartmentController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await createDepartment(req.body);
    successResponse(res, result, '部门创建成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有部门 */
export const getAllDepartmentsController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getAllDepartments();
    successResponse(res, result, '查询所有部门成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取单个部门信息 */
export const getDepartmentByIdController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { dept_id } = req.params;
    const result = await getDepartmentById(Number(dept_id));
    successResponse(res, result, '查询部门信息成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 更新部门信息 */
export const updateDepartmentController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { dept_id } = req.params;
    const result = await updateDepartment(Number(dept_id), req.body);
    successResponse(res, result, '部门信息更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 删除部门 */
export const deleteDepartmentController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { dept_id } = req.params;
    const result = await deleteDepartment(Number(dept_id));
    successResponse(res, result, '部门删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量创建部门 */
export const batchCreateDepartmentsController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchCreateDepartments(req.body);
    successResponse(res, result, '批量创建部门成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.7.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { getAllDepartmentsController, getDepartmentByIdController } from '../controllers/departmentsController';

const router = express.Router();

/** 获取部门列表 */
router.get('/departments/list', getAllDepartmentsController);

/** 获取部门详情 */
router.get('/departments/:dept_id', getDepartmentByIdController);

export default router;
~~~

📁`departmentsRouter`

~~~ts
import express from 'express';
import {
  createDepartmentController,
  updateDepartmentController,
  deleteDepartmentController,
  batchCreateDepartmentsController
} from '../controllers/departmentsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateDepartmentCreate, validateDepartmentUpdate, validateBatchDepartmentCreate } from '../validators/validateRequest';

const router = express.Router();

// 创建部门
router.post('/create', authorizeRole('superadmin'), validateDepartmentCreate, createDepartmentController);

// 更新部门信息
router.put('/update/:dept_id', authorizeRole('admin', 'superadmin'), validateDepartmentUpdate, updateDepartmentController);

// 删除部门
router.delete('/delete/:dept_id', authorizeRole('superadmin'), deleteDepartmentController);

// 批量创建部门
router.post('/batch-create', authorizeRole('superadmin'), validateBatchDepartmentCreate, batchCreateDepartmentsController);

export default router;
~~~

### 8.8 届次管理接口

#### 8.8.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// TeamTerm 校验
// ---------------------------
export const TeamTermSchema: Record<string, FieldRule> = {
  term_name: {
    required: true,
    message: "届次名称不能为空"
  },
  start_date: {
    type: "date",
    message: "开始日期格式错误"
  },
  end_date: {
    type: "date",
    message: "结束日期格式错误"
  },
  is_current: {
    type: "number",
    message: "是否当前届次必须为数字"
  },
  remark: {
    type: "string",
    message: "备注必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * TeamTerm
 * --------------------------- */
export const validateTeamTermCreate = createValidator(TeamTermSchema, "create");
export const validateTeamTermUpdate = createValidator(TeamTermSchema, "update");
export const validateBatchTeamTermCreate = createBatchValidator(TeamTermSchema, "create");
```

#### 8.8.2 服务层

📁`teamTermsService`

```ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  TeamTermRecord,
  TeamTermWritable,
  TeamTermWritableFields,
} from '../types/dbTypes';

/** 创建届次（自动映射字段，校验名称唯一，支持设置当前届） */
export const createTeamTerm = async (body: Partial<TeamTermWritable>) => {
  const { term_name, is_current = 0 } = body;

  if (!term_name) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '届次名称不能为空' };
  }

  // 校验重名
  const [exists]: any = await query(
    `SELECT term_id FROM team_terms WHERE term_name = ?`,
    [term_name]
  );
  if (exists) {
    throw { status: HTTP_STATUS.CONFLICT, message: '该届次名称已存在' };
  }

  // 设置当前届则取消其他届
  if (is_current === 1) {
    await query(`UPDATE team_terms SET is_current = 0`);
  }

  // 自动构建字段
  const columns = TeamTermWritableFields.join(', ');
  const placeholders = TeamTermWritableFields.map(() => '?').join(', ');
  const values = TeamTermWritableFields.map((f) => (body as any)[f] ?? null);

  const sql = `
    INSERT INTO team_terms (${columns})
    VALUES (${placeholders})
  `;

  const result: any = await query(sql, values);

  return {
    term_id: result.insertId,
    ...body,
    is_current,
  };
};

/** 获取所有届次（按开始时间+届次ID倒序） */
export const getAllTeamTerms = async () => {
  const sql = `
    SELECT *
    FROM team_terms
    ORDER BY start_date DESC, term_id DESC;
  `;
  const rows: any[] = await query(sql);
  return { total: rows.length, data: rows };
};

/** 按ID获取单个届次 */
export const getTeamTermById = async (term_id: number) => {
  const [term]: any = await query(
    `SELECT * FROM team_terms WHERE term_id = ?`,
    [term_id]
  );

  if (!term) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '未找到该届次信息' };
  }

  return term;
};

/** 按ID更新届次（自动映射字段，支持设置当前届） */
export const updateTeamTerm = async (
  term_id: number,
  body: Partial<TeamTermWritable>
) => {
  const [exists]: any = await query(
    `SELECT * FROM team_terms WHERE term_id = ?`,
    [term_id]
  );

  if (!exists) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '届次不存在' };
  }

  // 自动构建更新字段
  const updates: string[] = [];
  const values: any[] = [];

  for (const key of TeamTermWritableFields) {
    if (body[key] !== undefined && body[key] !== null) {
      updates.push(`${key} = ?`);
      values.push((body as any)[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新的字段' };
  }

  // 设置当前届则取消其他届
  if (body.is_current === 1) {
    await query(
      `UPDATE team_terms SET is_current = 0 WHERE term_id != ?`,
      [term_id]
    );
  }

  const sql = `UPDATE team_terms SET ${updates.join(', ')} WHERE term_id = ?`;
  await query(sql, [...values, term_id]);

  return { message: `届次 ${term_id} 更新成功` };
};

/** 按ID删除届次 */
export const deleteTeamTerm = async (term_id: number) => {
  const sql = `DELETE FROM team_terms WHERE term_id = ?`;
  const result: any = await query(sql, [term_id]);

  if (result.affectedRows === 0) {
    throw {
      status: HTTP_STATUS.NOT_FOUND,
      message: '届次不存在或已被删除',
    };
  }

  return { message: `届次 ${term_id} 删除成功` };
};

/** 批量创建届次（自动映射字段，校验名称唯一，返回创建/跳过详情） */
export const batchCreateTeamTerms = async (
  terms: Partial<TeamTermWritable>[]
) => {
  if (!Array.isArray(terms) || terms.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请求体必须为非空届次数组',
    };
  }

  const created: any[] = [];
  const skipped: any[] = [];

  for (const [index, term] of terms.entries()) {
    const { term_name, is_current = 0 } = term || {};

    if (!term_name) {
      skipped.push({ index: index + 1, reason: '届次名称不能为空' });
      continue;
    }

    // 校验重名
    const [exists]: any = await query(
      `SELECT term_id FROM team_terms WHERE term_name = ?`,
      [term_name]
    );
    if (exists) {
      skipped.push({ term_name, reason: '届次名称已存在' });
      continue;
    }

    try {
      // 设置当前届则取消其他届
      if (is_current === 1) {
        await query(`UPDATE team_terms SET is_current = 0`);
      }

      // 自动构建字段
      const columns = TeamTermWritableFields.join(', ');
      const placeholders = TeamTermWritableFields.map(() => '?').join(', ');
      const values = TeamTermWritableFields.map((f) => (term as any)[f] ?? null);

      const sql = `
        INSERT INTO team_terms (${columns})
        VALUES (${placeholders})
      `;

      const result: any = await query(sql, values);

      created.push({
        term_id: result.insertId,
        ...term,
        is_current,
      });
    } catch (err: any) {
      skipped.push({
        term_name,
        reason: err.message || '数据库插入失败',
      });
    }
  }

  return {
    message: '批量届次创建完成',
    total: terms.length,
    created: created.length,
    skipped: skipped.length,
    details: { created, skipped },
  };
};
```

#### 8.8.3 控制层

📁`teamTermsController`

```ts
import { Request, Response } from 'express';
import {
  createTeamTerm,
  getAllTeamTerms,
  getTeamTermById,
  updateTeamTerm,
  deleteTeamTerm,
  batchCreateTeamTerms
} from '../services/teamTermsService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建届次 */
export const createTeamTermController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await createTeamTerm(req.body);
    successResponse(res, result, '届次创建成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有届次 */
export const getAllTeamTermsController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getAllTeamTerms();
    successResponse(res, result, '查询所有届次成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取单个届次信息 */
export const getTeamTermByIdController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { term_id } = req.params;
    const result = await getTeamTermById(Number(term_id));
    successResponse(res, result, '查询届次信息成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 更新届次信息 */
export const updateTeamTermController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { term_id } = req.params;
    const result = await updateTeamTerm(Number(term_id), req.body);
    successResponse(res, result, '届次信息更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 删除届次 */
export const deleteTeamTermController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { term_id } = req.params;
    const result = await deleteTeamTerm(Number(term_id));
    successResponse(res, result, '届次删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量创建届次 */
export const batchCreateTeamTermsController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchCreateTeamTerms(req.body);
    successResponse(res, result, '批量创建届次成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
```

#### 8.8.4 路由层

📁`publicRouter`

```ts
import express from 'express';
import { getAllTeamTermsController, getTeamTermByIdController } from '../controllers/teamTermsController';

const router = express.Router();

/** 获取届次列表 */
router.get('/team-terms/list', getAllTeamTermsController);

/** 获取届次详情 */
router.get('/team-terms/:term_id', getTeamTermByIdController);

export default router;
```

📁`teamTermsRouter`

```ts
import express from 'express';
import {
  createTeamTermController,
  updateTeamTermController,
  deleteTeamTermController,
  batchCreateTeamTermsController
} from '../controllers/teamTermsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateTeamTermCreate, validateTeamTermUpdate, validateBatchTeamTermCreate } from '../validators/validateRequest';

const router = express.Router();

// 创建届次
router.post('/create', authorizeRole('superadmin'), validateTeamTermCreate, createTeamTermController);

// 更新届次信息
router.put('/update/:term_id', authorizeRole('superadmin'), validateTeamTermUpdate, updateTeamTermController);

// 删除届次
router.delete('/delete/:term_id', authorizeRole('superadmin'), deleteTeamTermController);

// 批量创建届次
router.post('/batch-create', authorizeRole('superadmin'), validateBatchTeamTermCreate, batchCreateTeamTermsController);

export default router;
```

### 8.9 骨干成员管理接口

#### 8.9.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// BackboneMember 校验
// ---------------------------
export const BackboneMemberSchema: Record<string, FieldRule> = {
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号错误"
  },
  dept_id: {
    required: true,
    type: "number",
    message: "部门 ID 必须为数字"
  },
  term_id: {
    required: true,
    type: "number",
    message: "届次 ID 必须为数字"
  },
  position: {
    type: "enum",
    enumValues: ["队长", "部长", "副部长", "部员"],
    message: "职位不合法"
  },
  photo_url: {
    type: "string",
    message: "照片 URL 必须为字符串"
  },
  photo_key: {
    type: "string",
    message: "照片 key 必须为字符串"
  },
  term_start: {
    type: "date",
    message: "任期开始日期格式错误"
  },
  term_end: {
    type: "date",
    message: "任期结束日期格式错误"
  },
  remark: {
    type: "string",
    message: "备注必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * BackboneMember
 * --------------------------- */
export const validateBackboneMemberCreate = createValidator(BackboneMemberSchema, "create");
export const validateBackboneMemberUpdate = createValidator(BackboneMemberSchema, "update");
export const validateBatchBackboneMemberCreate = createBatchValidator(BackboneMemberSchema, "create");
```

#### 8.9.2 服务层

📁`backboneMembersService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import { deleteFileFromOSS } from '../oss/deleteService';
import {
  BackboneMemberRecord,
  BackboneMemberWritable,
  BackboneMemberWritableFields,
} from '../types/dbTypes';

/** 合法职务：队长、部长、副部长、部员 */
const VALID_POSITIONS = ['队长', '部长', '副部长', '部员'];

/** 创建骨干成员（校验必填字段、职务合法性、届次内唯一性，自动映射可写字段） */
export const createBackboneMember = async (
  body: Partial<BackboneMemberWritable>
) => {
  const { student_id, dept_id, term_id, position } = body;

  if (!student_id || !dept_id || !term_id) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '学号、部门ID、届次ID不能为空',
    };
  }

  if (position && !VALID_POSITIONS.includes(position)) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: `无效的职务类型：${position}`,
    };
  }

  // 校验届次内唯一性
  const [exists]: any = await query(
    `SELECT member_id FROM backbone_members WHERE student_id = ? AND term_id = ?`,
    [student_id, term_id]
  );
  if (exists) {
    throw {
      status: HTTP_STATUS.CONFLICT,
      message: '该成员在该届次下已存在',
    };
  }

  // 自动构建插入字段与值
  const columns = BackboneMemberWritableFields.join(', ');
  const placeholders = BackboneMemberWritableFields.map(() => '?').join(', ');
  const values = BackboneMemberWritableFields.map(
    (f) => (body as any)[f] ?? null
  );

  const sql = `
    INSERT INTO backbone_members (${columns})
    VALUES (${placeholders})
  `;

  const result: any = await query(sql, values);

  return {
    member_id: result.insertId,
    ...body,
    position: position || '部员',
  };
};

/** 更新骨干成员（校验职务合法性，支持OSS头像替换，自动过滤可写字段） */
export const updateBackboneMember = async (
  member_id: number,
  body: Partial<BackboneMemberWritable>
) => {
  const [existing]: BackboneMemberRecord[] = await query(
    `SELECT * FROM backbone_members WHERE member_id = ?`,
    [member_id]
  );

  if (!existing) {
    throw {
      status: HTTP_STATUS.NOT_FOUND,
      message: '成员记录不存在',
    };
  }

  // 校验职务合法性
  if (body.position && !VALID_POSITIONS.includes(body.position)) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: `无效的职务类型：${body.position}`,
    };
  }

  // 头像替换（删除旧OSS文件）
  if (body.photo_key && body.photo_key !== existing.photo_key) {
    if (existing.photo_key) {
      try {
        await deleteFileFromOSS(existing.photo_key);
      } catch (err) {
        console.warn('⚠️ 删除旧头像失败（不影响更新）:', err);
      }
    }
  }

  // 自动构建更新字段
  const updates: string[] = [];
  const values: any[] = [];

  for (const key of BackboneMemberWritableFields) {
    if (body[key] !== undefined) {
      updates.push(`${key} = ?`);
      values.push((body as any)[key]);
    }
  }

  if (updates.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '没有可更新字段',
    };
  }

  const sql = `
    UPDATE backbone_members
    SET ${updates.join(', ')}
    WHERE member_id = ?
  `;

  await query(sql, [...values, member_id]);

  return { message: '骨干成员更新成功' };
};

/** 删除骨干成员（连带删除OSS头像文件） */
export const deleteBackboneMember = async (member_id: number) => {
  const [existing]: BackboneMemberRecord[] = await query(
    `SELECT * FROM backbone_members WHERE member_id = ?`,
    [member_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '成员不存在' };
  }

  // 删除OSS头像
  if (existing.photo_key) {
    try {
      await deleteFileFromOSS(existing.photo_key);
    } catch (err) {
      console.warn('⚠️ 删除头像失败（不影响主记录删除）:', err);
    }
  }

  await query(`DELETE FROM backbone_members WHERE member_id = ?`, [member_id]);

  return { message: '骨干成员删除成功' };
};

/** 获取所有骨干成员（关联部门、届次信息，按届次时间+部门ID+职务排序） */
export const getAllBackboneMembers = async () => {
  const sql = `
    SELECT 
      m.*,
      d.dept_name,
      t.term_name,
      t.is_current
    FROM backbone_members m
    LEFT JOIN departments d ON m.dept_id = d.dept_id
    LEFT JOIN team_terms t ON m.term_id = t.term_id
    ORDER BY t.start_date DESC, d.dept_id ASC, m.position ASC;
  `;
  const rows = await query(sql);
  return { total: rows.length, data: rows };
};

/** 按届次-部门分组获取骨干成员（树状结构，供门户展示） */
export const getBackboneTree = async () => {
  const sql = `
    SELECT 
      t.term_id, t.term_name, t.is_current,
      d.dept_id, d.dept_name,
      m.member_id, m.student_id, m.position, m.photo_url, m.term_start, m.term_end
    FROM team_terms t
    LEFT JOIN backbone_members m ON t.term_id = m.term_id
    LEFT JOIN departments d ON m.dept_id = d.dept_id
    ORDER BY t.start_date DESC, d.dept_id ASC;
  `;

  const rows: any[] = await query(sql);
  const termMap: Record<number, any> = {};

  for (const row of rows) {
    if (!termMap[row.term_id]) {
      termMap[row.term_id] = {
        term_id: row.term_id,
        term_name: row.term_name,
        is_current: row.is_current,
        departments: {},
      };
    }

    const t = termMap[row.term_id];

    if (row.dept_id && !t.departments[row.dept_id]) {
      t.departments[row.dept_id] = {
        dept_id: row.dept_id,
        dept_name: row.dept_name,
        members: [],
      };
    }

    if (row.member_id) {
      t.departments[row.dept_id].members.push({
        member_id: row.member_id,
        student_id: row.student_id,
        position: row.position,
        photo_url: row.photo_url,
        term_start: row.term_start,
        term_end: row.term_end,
      });
    }
  }

  return Object.values(termMap).map((t) => ({
    term_id: t.term_id,
    term_name: t.term_name,
    is_current: t.is_current,
    departments: Object.values(t.departments),
  }));
};

/** 批量创建骨干成员（校验必填字段、职务合法性、届次内唯一性，返回创建/失败详情） */
export const batchCreateBackboneMembers = async (
  members: Partial<BackboneMemberWritable>[]
) => {
  if (!Array.isArray(members) || members.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请求体必须为非空数组',
    };
  }

  const created: any[] = [];
  const failed: any[] = [];

  for (const item of members) {
    const { student_id, dept_id, term_id, position } = item;

    // 校验必填字段
    if (!student_id || !dept_id || !term_id) {
      failed.push({
        student_id,
        reason: '缺少必要字段 student_id/dept_id/term_id',
      });
      continue;
    }

    // 校验职务合法性
    if (position && !VALID_POSITIONS.includes(position)) {
      failed.push({
        student_id,
        reason: `无效的职务类型：${position}`,
      });
      continue;
    }

    try {
      // 校验届次内唯一性
      const [exists]: any = await query(
        `SELECT member_id FROM backbone_members WHERE student_id = ? AND term_id = ?`,
        [student_id, term_id]
      );

      if (exists) {
        failed.push({ student_id, reason: '该成员在该届次下已存在' });
        continue;
      }

      // 自动构建插入字段
      const columns = BackboneMemberWritableFields.join(', ');
      const placeholders = BackboneMemberWritableFields.map(() => '?').join(
        ', '
      );
      const values = BackboneMemberWritableFields.map(
        (f) => (item as any)[f] ?? null
      );

      const sql = `
        INSERT INTO backbone_members (${columns})
        VALUES (${placeholders})
      `;

      const result: any = await query(sql, values);

      created.push({
        member_id: result.insertId,
        ...item,
        position: item.position || '部员',
      });
    } catch (error: any) {
      failed.push({
        student_id,
        reason: error.message || '数据库错误',
      });
    }
  }

  return {
    total: members.length,
    created: created.length,
    failed: failed.length,
    createdList: created,
    failedList: failed,
  };
};
~~~

#### 8.9.3 控制层

📁`backboneMembersController`

~~~ts
import { Request, Response } from 'express';
import {
  createBackboneMember,
  updateBackboneMember,
  deleteBackboneMember,
  getAllBackboneMembers,
  getBackboneTree,
  batchCreateBackboneMembers
} from '../services/backboneMembersService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建骨干成员 */
export const createBackboneMemberController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await createBackboneMember(req.body);
    successResponse(res, result, '骨干成员创建成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 更新骨干成员信息 */
export const updateBackboneMemberController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { member_id } = req.params;
    const result = await updateBackboneMember(Number(member_id), req.body);
    successResponse(res, result, '骨干成员信息更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 删除骨干成员 */
export const deleteBackboneMemberController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { member_id } = req.params;
    const result = await deleteBackboneMember(Number(member_id));
    successResponse(res, result, '骨干成员删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有骨干成员 */
export const getAllBackboneMembersController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getAllBackboneMembers();
    successResponse(res, result, '查询所有骨干成员成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取骨干成员树状结构（届次→部门→成员） */
export const getBackboneTreeController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getBackboneTree();
    successResponse(res, result, '查询骨干成员树状结构成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量创建骨干成员 */
export const batchCreateBackboneMembersController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchCreateBackboneMembers(req.body);
    successResponse(res, result, '批量创建骨干成员成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.9.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { getAllBackboneMembersController, getBackboneTreeController } from '../controllers/backboneMembersController';

const router = express.Router();

/** 获取骨干成员列表 */
router.get('/backbone-members/list', getAllBackboneMembersController);

/** 获取骨干成员树 */
router.get('/backbone-members/tree', getBackboneTreeController);

export default router;
~~~

📁`backboneMembersRouter`

~~~ts
import express from 'express';
import {
  createBackboneMemberController,
  updateBackboneMemberController,
  deleteBackboneMemberController,
  batchCreateBackboneMembersController
} from '../controllers/backboneMembersController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateBackboneMemberCreate, validateBackboneMemberUpdate, validateBatchBackboneMemberCreate } from '../validators/validateRequest'

const router = express.Router();

// 创建骨干成员
router.post('/create', authorizeRole('admin', 'superadmin'), validateBackboneMemberCreate, createBackboneMemberController);

// 更新骨干成员信息
router.put('/update/:member_id', authorizeRole('admin', 'superadmin'), validateBackboneMemberUpdate, updateBackboneMemberController);

// 删除骨干成员
router.delete('/delete/:member_id', authorizeRole('admin', 'superadmin'), deleteBackboneMemberController);

// 批量创建骨干成员
router.post('/batch-create', authorizeRole('admin', 'superadmin'), validateBatchBackboneMemberCreate, batchCreateBackboneMembersController);

export default router;
~~~

### 8.10 志愿活动记录管理接口

#### 8.10.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// Activity 校验
// ---------------------------
export const ActivitySchema: Record<string, FieldRule> = {
  activity_name: {
    required: true,
    type: "string",
    message: "活动名称不能为空"
  },
  dept_id: {
    type: "number",
    message: "部门 ID 必须为数字"
  },
  term_id: {
    type: "number",
    message: "届次 ID 必须为数字"
  },
  category: {
    type: "string",
    message: "类别必须为字符串"
  },
  cover_url: {
    type: "string",
    message: "封面 URL 必须为字符串"
  },
  cover_key: {
    type: "string",
    message: "封面 key 必须为字符串"
  },
  recruitment_limit: {
    type: "number",
    message: "招募人数必须为数字"
  },
  service_hours: {
    type: "number",
    message: "服务时长必须为数字"
  },
  location: {
    type: "string",
    message: "地点必须为字符串"
  },
  start_time: {
    type: "date",
    message: "开始时间格式错误"
  },
  end_time: {
    type: "date",
    message: "结束时间格式错误"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  status: {
    type: "enum",
    enumValues: ["草稿", "进行中", "已结束"],
    message: "状态不合法"
  },
  created_by: {
    type: "string",
    message: "创建人必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * Activity
 * --------------------------- */
export const validateActivityCreate = createValidator(ActivitySchema, "create");
export const validateActivityUpdate = createValidator(ActivitySchema, "update");
```

#### 8.10.2 服务层

📁`activitiesService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  ActivityRecord,
  ActivityWritable,
  ActivityWritableFields
} from '../types/dbTypes';

/** 创建志愿活动（自动映射可写字段，必填活动名称） */
export const createActivity = async (body: Partial<ActivityWritable>) => {
  if (!body.activity_name) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '活动名称不能为空' };
  }

  // 筛选可写字段
  const fields = ActivityWritableFields.filter(key => body[key] !== undefined);
  const placeholders = fields.map(() => '?').join(', ');
  const sql = `
    INSERT INTO activities (${fields.join(', ')})
    VALUES (${placeholders})
  `;
  const values = fields.map(key => body[key] ?? null);

  const result = await query<{ insertId: number }>(sql, values);

  return {
    activity_id: result.insertId,
    activity_name: body.activity_name,
    service_hours: body.service_hours ?? null,
    status: body.status ?? '草稿'
  };
};

/** 更新志愿活动（自动过滤可写字段） */
export const updateActivity = async (
  activity_id: number,
  body: Partial<ActivityWritable>
) => {
  const [existing]: any = await query(
    `SELECT * FROM activities WHERE activity_id = ?`,
    [activity_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '活动不存在' };
  }

  const updates: string[] = [];
  const values: any[] = [];

  for (const key of Object.keys(body) as (keyof ActivityWritable)[]) {
    if (ActivityWritableFields.includes(key) && body[key] !== undefined) {
      updates.push(`${key} = ?`);
      values.push(body[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新字段' };
  }

  await query(
    `UPDATE activities SET ${updates.join(', ')} WHERE activity_id = ?`,
    [...values, activity_id]
  );

  return {
    message: '活动更新成功',
    updated_fields: updates.map(u => u.split('=')[0].trim())
  };
};

/** 删除志愿活动 */
export const deleteActivity = async (activity_id: number) => {
  const [existing]: any = await query(
    `SELECT * FROM activities WHERE activity_id = ?`,
    [activity_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '活动不存在' };
  }

  await query(`DELETE FROM activities WHERE activity_id = ?`, [activity_id]);

  return { message: '活动删除成功' };
};

/** 获取所有志愿活动（关联部门、届次信息，按创建时间倒序） */
export const getAllActivities = async () => {
  const sql = `
    SELECT 
      a.*, d.dept_name, t.term_name
    FROM activities a
    LEFT JOIN departments d ON a.dept_id = d.dept_id
    LEFT JOIN team_terms t ON a.term_id = t.term_id
    ORDER BY a.created_at DESC;
  `;

  const rows: any[] = await query(sql);
  return { total: rows.length, data: rows };
};

/** 按ID获取志愿活动详情（关联部门、届次信息） */
export const getActivityById = async (activity_id: number) => {
  const [row]: any = await query(
    `
    SELECT 
      a.*, d.dept_name, t.term_name
    FROM activities a
    LEFT JOIN departments d ON a.dept_id = d.dept_id
    LEFT JOIN team_terms t ON a.term_id = t.term_id
    WHERE a.activity_id = ?
    `,
    [activity_id]
  );

  if (!row) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '活动不存在' };
  }

  return row;
};

/** 切换志愿活动状态（支持：草稿、进行中、已结束） */
export const changeActivityStatus = async (
  activity_id: number,
  newStatus: ActivityRecord['status']
) => {
  const validStatuses: ActivityRecord['status'][] = ['草稿', '进行中', '已结束'];

  if (!validStatuses.includes(newStatus)) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '非法状态值' };
  }

  const [existing]: any = await query(
    `SELECT * FROM activities WHERE activity_id = ?`,
    [activity_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '活动不存在' };
  }

  await query(`UPDATE activities SET status = ? WHERE activity_id = ?`, [
    newStatus,
    activity_id
  ]);

  return { message: `活动状态已更新为：${newStatus}` };
};
~~~

#### 8.10.3 控制层

📁`activitiesController`

~~~ts
import { Request, Response } from 'express';
import {
  createActivity,
  updateActivity,
  deleteActivity,
  getAllActivities,
  getActivityById,
  changeActivityStatus
} from '../services/activitiesService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建志愿活动 */
export const createActivityController = async (req: Request, res: Response) => {
  try {
    const result = await createActivity(req.body);
    successResponse(res, result, '活动创建成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 更新志愿活动 */
export const updateActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const result = await updateActivity(Number(activity_id), req.body);
    successResponse(res, result, '活动更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 删除志愿活动 */
export const deleteActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const result = await deleteActivity(Number(activity_id));
    successResponse(res, result, '活动删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有志愿活动 */
export const getAllActivitiesController = async (_req: Request, res: Response) => {
  try {
    const result = await getAllActivities();
    successResponse(res, result, '查询所有活动成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取活动详情 */
export const getActivityByIdController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const result = await getActivityById(Number(activity_id));
    successResponse(res, result, '查询活动详情成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 切换活动状态 */
export const changeActivityStatusController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const { status } = req.body;
    const result = await changeActivityStatus(Number(activity_id), status);
    successResponse(res, result, '活动状态更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.10.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { getAllActivitiesController, getActivityByIdController } from '../controllers/activitiesController';

const router = express.Router();

/** 获取活动列表 */
router.get('/activities/list', getAllActivitiesController);

/** 获取活动详情 */
router.get('/activities/:activity_id', getActivityByIdController);

export default router;
~~~

📁`activitiesRouter`

~~~ts
import express from 'express';
import {
  createActivityController,
  updateActivityController,
  deleteActivityController,
  changeActivityStatusController
} from '../controllers/activitiesController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateActivityCreate, validateActivityUpdate } from '../validators/validateRequest';

const router = express.Router();

// 创建志愿活动
router.post('/create', authorizeRole('admin', 'superadmin'), validateActivityCreate, createActivityController);

// 更新志愿活动
router.put('/update/:activity_id', authorizeRole('admin', 'superadmin'), validateActivityUpdate, updateActivityController);

// 删除志愿活动
router.delete('/delete/:activity_id', authorizeRole('admin', 'superadmin'), deleteActivityController);

// 切换活动状态
router.patch('/status/:activity_id', authorizeRole('admin', 'superadmin'), validateActivityUpdate, changeActivityStatusController);

export default router;
~~~

### 8.11 参与志愿活动相关接口

#### 8.11.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// ActivityParticipant 校验
// ---------------------------
export const ActivityParticipantSchema: Record<string, FieldRule> = {
  activity_id: {
    required: true,
    type: "number",
    message: "活动 ID 必须为数字"
  },
  student_id: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号错误"
  },
  role: {
    type: "string",
    message: "角色必须为字符串"
  },
  service_hours: {
    type: "number",
    message: "服务时长必须为数字"
  },
  signed_in: {
    type: "number",
    message: "签到状态必须为数字"
  },
  remark: {
    type: "string",
    message: "备注必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * ActivityParticipant
 * --------------------------- */
export const validateActivityParticipantCreate = createValidator(ActivityParticipantSchema, "create");
export const validateActivityParticipantUpdate = createValidator(ActivityParticipantSchema, "update");
export const validateBatchActivityParticipantUpdate = createBatchValidator(ActivityParticipantSchema, "update");
```

#### 8.11.2 服务层

📁`activityParticipantsService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  ActivityParticipantRecord,
  ActivityParticipantWritable,
  ActivityParticipantWritableFields
} from '../types/dbTypes';

/** 获取活动报名名单（关联活动、学生信息） */
export const getParticipantsByActivity = async (activity_id: number) => {
  const sql = `
    SELECT 
      p.*, a.activity_name, i.name AS student_name, i.college, i.major
    FROM activity_participants p
    LEFT JOIN activities a ON p.activity_id = a.activity_id
    LEFT JOIN auth_info i ON p.student_id = i.student_id
    WHERE p.activity_id = ?
    ORDER BY p.record_id ASC
  `;
  const rows: any[] = await query(sql, [activity_id]);
  return { total: rows.length, data: rows };
};

/** 学生报名活动（校验活动存在、未重复报名、人数限制，自动映射字段） */
export const joinActivity = async (activity_id: number, student_id: string) => {
  // 校验活动存在
  const [activity]: any = await query(
    `SELECT * FROM activities WHERE activity_id = ?`,
    [activity_id]
  );
  if (!activity)
    throw { status: HTTP_STATUS.NOT_FOUND, message: '活动不存在' };

  // 校验未重复报名
  const [existing]: any = await query(
    `SELECT * FROM activity_participants WHERE activity_id = ? AND student_id = ?`,
    [activity_id, student_id]
  );
  if (existing)
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '您已报名该活动'
    };

  // 校验人数限制
  if (activity.recruitment_limit) {
    const [{ count }]: any = await query(
      `SELECT COUNT(*) AS count FROM activity_participants WHERE activity_id = ?`,
      [activity_id]
    );
    if (count >= activity.recruitment_limit)
      throw {
        status: HTTP_STATUS.BAD_REQUEST,
        message: '报名人数已满'
      };
  }

  // 自动构建报名数据
  const body: ActivityParticipantWritable = {
    activity_id,
    student_id,
    role: '志愿者',
    service_hours: 0,
    signed_in: 0,
    remark: null
  };

  const fields = ActivityParticipantWritableFields;
  const placeholders = fields.map(() => '?').join(', ');
  const values = fields.map(key => body[key] ?? null);

  const sql = `
    INSERT INTO activity_participants (${fields.join(', ')})
    VALUES (${placeholders})
  `;

  await query(sql, values);

  return { message: '报名成功', activity_id, student_id };
};

/** 取消活动报名 */
export const cancelActivity = async (
  activity_id: number,
  student_id: string
) => {
  const [existing]: any = await query(
    `SELECT record_id FROM activity_participants WHERE activity_id = ? AND student_id = ?`,
    [activity_id, student_id]
  );

  if (!existing)
    throw { status: HTTP_STATUS.NOT_FOUND, message: '您未报名该活动' };

  await query(
    `DELETE FROM activity_participants WHERE activity_id = ? AND student_id = ?`,
    [activity_id, student_id]
  );

  return { message: '取消报名成功', activity_id, student_id };
};

/** 活动签到/取消签到（1=签到，0=取消） */
export const markSignIn = async (record_id: number, signed_in: 0 | 1) => {
  const [existing]: any = await query(
    `SELECT * FROM activity_participants WHERE record_id = ?`,
    [record_id]
  );

  if (!existing)
    throw { status: HTTP_STATUS.NOT_FOUND, message: '参与记录不存在' };

  await query(
    `UPDATE activity_participants SET signed_in = ? WHERE record_id = ?`,
    [signed_in, record_id]
  );

  return { message: signed_in ? '签到成功' : '签到状态取消' };
};

/** 单个更新志愿者服务时长 */
export const updateServiceHours = async (
  record_id: number,
  service_hours: number
) => {
  const [existing]: any = await query(
    `SELECT * FROM activity_participants WHERE record_id = ?`,
    [record_id]
  );

  if (!existing)
    throw { status: HTTP_STATUS.NOT_FOUND, message: '参与记录不存在' };

  await query(
    `UPDATE activity_participants SET service_hours = ? WHERE record_id = ?`,
    [service_hours, record_id]
  );

  return { message: '服务时长更新成功', record_id, service_hours };
};

/** 批量更新志愿者服务时长（返回更新结果详情） */
export const batchUpdateServiceHours = async (
  updates: { record_id: number; service_hours: number }[]
) => {
  if (!Array.isArray(updates) || updates.length === 0) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请求体必须为非空数组'
    };
  }

  const successList: any[] = [];
  const failedList: any[] = [];

  for (const item of updates) {
    const { record_id, service_hours } = item;

    if (!record_id || typeof service_hours !== 'number') {
      failedList.push({
        record_id,
        reason: '缺少 record_id 或 service_hours 无效'
      });
      continue;
    }

    try {
      const [exists]: any = await query(
        `SELECT record_id FROM activity_participants WHERE record_id = ?`,
        [record_id]
      );

      if (!exists) {
        failedList.push({ record_id, reason: '报名记录不存在' });
        continue;
      }

      const result: any = await query(
        `UPDATE activity_participants SET service_hours = ? WHERE record_id = ?`,
        [service_hours, record_id]
      );

      if (result.affectedRows === 0) {
        failedList.push({
          record_id,
          reason: '更新失败（无受影响行）'
        });
        continue;
      }

      successList.push({ record_id, service_hours });
    } catch (error: any) {
      failedList.push({
        record_id,
        reason: error.message || '数据库错误'
      });
    }
  }

  return {
    total: updates.length,
    success: successList.length,
    failed: failedList.length,
    successList,
    failedList,
    message:
      failedList.length === 0
        ? '全部更新成功'
        : failedList.length === updates.length
          ? '全部更新失败'
          : '部分更新成功'
  };
};

/** 获取学生个人报名记录（关联活动、个人信息） */
export const getRecordsByStudent = async (student_id: string) => {
  const sql = `
    SELECT 
      p.*, 
      a.activity_name, 
      a.start_time, 
      a.end_time, 
      a.location, 
      a.category,
      a.status AS activity_status,
      i.name AS student_name,
      i.college, 
      i.major
    FROM activity_participants p
    LEFT JOIN activities a ON p.activity_id = a.activity_id
    LEFT JOIN auth_info i ON p.student_id = i.student_id
    WHERE p.student_id = ?
    ORDER BY a.start_time DESC
  `;
  const rows: any[] = await query(sql, [student_id]);
  return { total: rows.length, data: rows };
};

/** 获取所有活动参与记录（关联活动、学生信息） */
export const getAllParticipants = async () => {
  const sql = `
    SELECT 
      p.*, 
      a.activity_id, 
      a.activity_name, 
      a.start_time, 
      a.end_time, 
      a.location,
      a.category,
      i.name AS student_name, 
      i.college, 
      i.major
    FROM activity_participants p
    LEFT JOIN activities a ON p.activity_id = a.activity_id
    LEFT JOIN auth_info i ON p.student_id = i.student_id
    ORDER BY a.activity_id ASC, p.record_id ASC
  `;
  const rows: any[] = await query(sql);
  return { total: rows.length, data: rows };
};
~~~

#### 8.11.3 控制层

📁`activityParticipantsController`

~~~ts
import { Request, Response } from 'express';
import { successResponse, errorResponse, HTTP_STATUS } from '../utils/response';
import {
  getParticipantsByActivity,
  joinActivity,
  cancelActivity,
  markSignIn,
  updateServiceHours,
  batchUpdateServiceHours,
  getRecordsByStudent,
  getAllParticipants
} from '../services/activityParticipantsService';

/** 获取活动报名名单 */
export const getParticipantsByActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const result = await getParticipantsByActivity(Number(activity_id));
    successResponse(res, result, '获取活动报名名单成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 学生报名活动 */
export const joinActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id, student_id } = req.body;
    const user = (req as any).user;

    if (user.role !== 'admin' && user.role !== 'superadmin' && user.student_id !== student_id) {
      errorResponse(res, '不能为别人报名活动！', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await joinActivity(Number(activity_id), student_id);
    successResponse(res, result, '报名成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 取消活动报名 */
export const cancelActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id, student_id } = req.params;
    const user = (req as any).user;

    if (user.role !== 'admin' && user.role !== 'superadmin' && user.student_id !== student_id) {
      errorResponse(res, '不能取消别人报名的活动！', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await cancelActivity(Number(activity_id), student_id);
    successResponse(res, result, '取消报名成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 活动签到/取消签到 */
export const markSignInController = async (req: Request, res: Response) => {
  try {
    const { record_id } = req.params;
    const { signed_in } = req.body;
    const result = await markSignIn(Number(record_id), signed_in);
    successResponse(res, result, '签到状态更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 单个更新服务时长 */
export const updateServiceHoursController = async (req: Request, res: Response) => {
  try {
    const { record_id } = req.params;
    const { service_hours } = req.body;
    const result = await updateServiceHours(Number(record_id), Number(service_hours));
    successResponse(res, result, '服务时长更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量更新服务时长 */
export const batchUpdateServiceHoursController = async (req: Request, res: Response) => {
  try {
    const { updates } = req.body;
    const result = await batchUpdateServiceHours(updates);
    successResponse(res, result, '批量服务时长更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取学生个人报名记录 */
export const getRecordsByStudentController = async (req: Request, res: Response) => {
  try {
    const { student_id } = req.params;
    const user = (req as any).user;

    if (user.role !== 'admin' && user.role !== 'superadmin' && user.student_id !== student_id) {
      errorResponse(res, '无权查看他人报名记录', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await getRecordsByStudent(student_id);
    successResponse(res, result, '获取个人报名记录成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有活动参与记录 */
export const getAllParticipantsController = async (req: Request, res: Response) => {
  try {
    const result = await getAllParticipants();
    successResponse(res, result, '获取所有活动参与记录成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.11.4 路由层

📁`activityParticipantsRouter`

~~~ts
import express from 'express';
import {
  getParticipantsByActivityController,
  joinActivityController,
  cancelActivityController,
  markSignInController,
  updateServiceHoursController,
  batchUpdateServiceHoursController,
  getRecordsByStudentController,
  getAllParticipantsController
} from '../controllers/activityParticipantsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateActivityParticipantCreate, validateActivityParticipantUpdate, validateBatchActivityParticipantUpdate } from '../validators/validateRequest';

const router = express.Router();

// 获取活动报名名单
router.get('/list/:activity_id', authorizeRole('admin', 'superadmin'), getParticipantsByActivityController);

// 学生报名活动
router.post('/join', validateActivityParticipantCreate, joinActivityController);

// 取消活动报名
router.delete('/cancel/:activity_id/:student_id', cancelActivityController);

// 活动签到/取消签到
router.patch('/signin/:record_id', authorizeRole('admin', 'superadmin'), validateActivityParticipantUpdate, markSignInController);

// 单个更新服务时长
router.patch('/hours/:record_id', authorizeRole('admin', 'superadmin'), validateActivityParticipantUpdate, updateServiceHoursController);

// 批量更新服务时长
router.put('/hours/batch', authorizeRole('admin', 'superadmin'), validateBatchActivityParticipantUpdate, batchUpdateServiceHoursController);

// 查询学生个人报名记录
router.get('/records/:student_id', getRecordsByStudentController);

// 查询所有活动参与记录
router.get('/all', authorizeRole('admin', 'superadmin'), getAllParticipantsController);

export default router;
~~~

### 8.12 荣誉与表彰记录接口

#### 8.12.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// Honor 校验
// ---------------------------
export const HonorSchema: Record<string, FieldRule> = {
  student_id: {
    validator: (v: unknown) => typeof v === "string" && isStudentId(v),
    message: "学号错误"
  },
  term_id: {
    type: "number",
    message: "届次 ID 必须为数字"
  },
  honor_title: {
    required: true,
    type: "string", message: "荣誉名称不能为空"
  },
  honor_level: {
    type: "string",
    message: "荣誉等级必须为字符串"
  },
  issue_date: {
    type: "date",
    message: "颁发日期格式错误"
  },
  issuer: {
    type: "string",
    message: "颁发单位必须为字符串"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  certificate_url: {
    type: "string",
    message: "证书图片 URL 必须为字符串"
  },
  certificate_key: {
    type: "string",
    message: "证书图片 key 必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * Honor
 * --------------------------- */
export const validateHonorCreate = createValidator(HonorSchema, "create");
export const validateHonorUpdate = createValidator(HonorSchema, "update");
export const validateBatchHonorCreate = createBatchValidator(HonorSchema, "create");
```

#### 8.12.2 服务层

📁`honorRecordsService`

```ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  HonorRecord,
  HonorWritable,
  HonorWritableFields
} from '../types/dbTypes';

/** 创建荣誉记录（自动映射可写字段，必填荣誉名称） */
export const createHonorRecord = async (body: Partial<HonorWritable>) => {
  if (!body.honor_title) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '荣誉名称不能为空' };
  }

  // 自动构建字段与值
  const fields = HonorWritableFields.filter(f => body[f] !== undefined);
  const placeholders = fields.map(() => '?').join(', ');
  const values = fields.map(f => body[f] ?? null);

  const sql = `
    INSERT INTO honor_records (${fields.join(', ')})
    VALUES (${placeholders})
  `;

  const result: any = await query(sql, values);

  return {
    honor_id: result.insertId,
    ...body
  };
};

/** 更新荣誉记录（自动过滤可写字段） */
export const updateHonorRecord = async (
  honor_id: number,
  body: Partial<HonorWritable>
) => {
  const [existing]: any = await query(
    `SELECT * FROM honor_records WHERE honor_id = ?`,
    [honor_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '荣誉记录不存在' };
  }

  const updates: string[] = [];
  const values: any[] = [];

  for (const key of HonorWritableFields) {
    if (body[key] !== undefined) {
      updates.push(`${key} = ?`);
      values.push(body[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新字段' };
  }

  const sql = `UPDATE honor_records SET ${updates.join(', ')} WHERE honor_id = ?`;
  await query(sql, [...values, honor_id]);

  return { message: '荣誉记录更新成功' };
};

/** 删除荣誉记录 */
export const deleteHonorRecord = async (honor_id: number) => {
  const [existing]: any = await query(
    `SELECT * FROM honor_records WHERE honor_id = ?`,
    [honor_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '荣誉记录不存在' };
  }

  await query(`DELETE FROM honor_records WHERE honor_id = ?`, [honor_id]);

  return { message: '荣誉记录删除成功' };
};

/** 获取所有荣誉记录（关联学生、届次信息，按颁发日期+荣誉等级排序） */
export const getAllHonorRecords = async () => {
  const sql = `
    SELECT 
      h.*,
      a.name AS student_name,
      t.term_name,
      t.is_current
    FROM honor_records h
    LEFT JOIN auth_info a ON h.student_id = a.student_id
    LEFT JOIN team_terms t ON h.term_id = t.term_id
    ORDER BY h.issue_date DESC, h.honor_level ASC;
  `;
  const rows: any[] = await query(sql);
  return { total: rows.length, data: rows };
};

/** 按届次分组获取荣誉墙（届次→荣誉记录结构） */
export const getHonorWall = async () => {
  const sql = `
    SELECT 
      t.term_id, t.term_name, t.is_current,
      h.honor_id, h.honor_title, h.honor_level, h.issue_date, h.issuer, h.description,
      a.student_id, a.name AS student_name
    FROM team_terms t
    LEFT JOIN honor_records h ON t.term_id = h.term_id
    LEFT JOIN auth_info a ON h.student_id = a.student_id
    ORDER BY t.start_date DESC, h.issue_date DESC;
  `;
  const rows: any[] = await query(sql);

  const termMap: Record<number, any> = {};

  for (const row of rows) {
    if (!termMap[row.term_id]) {
      termMap[row.term_id] = {
        term_id: row.term_id,
        term_name: row.term_name,
        is_current: row.is_current,
        honors: []
      };
    }

    if (row.honor_id) {
      termMap[row.term_id].honors.push({
        honor_id: row.honor_id,
        honor_title: row.honor_title,
        honor_level: row.honor_level,
        issue_date: row.issue_date,
        issuer: row.issuer,
        description: row.description,
        student_id: row.student_id,
        student_name: row.student_name
      });
    }
  }

  return Object.values(termMap);
};

/** 批量创建荣誉记录（自动映射可写字段，返回创建/失败详情） */
export const batchCreateHonorRecords = async (
  records: Partial<HonorWritable>[]
) => {
  if (!Array.isArray(records) || records.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '请求体必须为非空数组' };
  }

  const created: any[] = [];
  const failed: any[] = [];

  for (const item of records) {
    if (!item.honor_title) {
      failed.push({
        honor_title: item.honor_title,
        reason: '缺少必要字段 honor_title'
      });
      continue;
    }

    try {
      const fields = HonorWritableFields.filter(f => item[f] !== undefined);
      const placeholders = fields.map(() => '?').join(', ');
      const values = fields.map(f => item[f] ?? null);

      const sql = `
        INSERT INTO honor_records (${fields.join(', ')})
        VALUES (${placeholders})
      `;

      const result: any = await query(sql, values);

      created.push({
        honor_id: result.insertId,
        ...item
      });
    } catch (error: any) {
      failed.push({
        honor_title: item.honor_title,
        reason: error.message || '数据库错误'
      });
    }
  }

  return {
    total: records.length,
    created: created.length,
    failed: failed.length,
    createdList: created,
    failedList: failed
  };
};
```

#### 8.12.3 控制层

📁`honorRecordsController`

```ts
import { Request, Response } from 'express';
import {
  createHonorRecord,
  updateHonorRecord,
  deleteHonorRecord,
  getAllHonorRecords,
  getHonorWall,
  batchCreateHonorRecords
} from '../services/honorRecordsService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建荣誉记录 */
export const createHonorRecordController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await createHonorRecord(req.body);
    successResponse(res, result, '荣誉记录创建成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 更新荣誉记录 */
export const updateHonorRecordController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { honor_id } = req.params;
    const result = await updateHonorRecord(Number(honor_id), req.body);
    successResponse(res, result, '荣誉记录更新成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 删除荣誉记录 */
export const deleteHonorRecordController = async (req: Request, res: Response): Promise<void> => {
  try {
    const { honor_id } = req.params;
    const result = await deleteHonorRecord(Number(honor_id));
    successResponse(res, result, '荣誉记录删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有荣誉记录 */
export const getAllHonorRecordsController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getAllHonorRecords();
    successResponse(res, result, '查询所有荣誉记录成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取历届荣誉墙（按届次分组） */
export const getHonorWallController = async (_req: Request, res: Response): Promise<void> => {
  try {
    const result = await getHonorWall();
    successResponse(res, result, '查询荣誉墙成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 批量创建荣誉记录 */
export const batchCreateHonorRecordsController = async (req: Request, res: Response): Promise<void> => {
  try {
    const result = await batchCreateHonorRecords(req.body);
    successResponse(res, result, '批量创建荣誉记录成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
```

#### 8.12.4 路由层

📁`publicRouter`

```ts
import express from 'express';
import { getAllHonorRecordsController, getHonorWallController } from '../controllers/honorRecordsController';

const router = express.Router();

/** 获取荣誉记录列表 */
router.get('/honor-records/list', getAllHonorRecordsController);

/** 获取荣誉墙 */
router.get('/honor-records/wall', getHonorWallController);

export default router;
```

📁 `honorRecordsRouter`

```ts
import express from 'express';
import {
  createHonorRecordController,
  updateHonorRecordController,
  deleteHonorRecordController,
  batchCreateHonorRecordsController
} from '../controllers/honorRecordsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateHonorCreate, validateHonorUpdate, validateBatchHonorCreate } from '../validators/validateRequest';

const router = express.Router();

// 创建荣誉记录
router.post('/create', authorizeRole('admin', 'superadmin'), validateHonorCreate, createHonorRecordController);

// 更新荣誉记录
router.put('/update/:honor_id', authorizeRole('admin', 'superadmin'), validateHonorUpdate, updateHonorRecordController);

// 删除荣誉记录
router.delete('/delete/:honor_id', authorizeRole('admin', 'superadmin'), deleteHonorRecordController);

// 批量创建荣誉记录
router.post('/batch-create', authorizeRole('admin', 'superadmin'), validateBatchHonorCreate, batchCreateHonorRecordsController);

export default router;
```

### 8.13 公告与通知接口

#### 8.13.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// Announcement 校验
// ---------------------------
export const AnnouncementSchema: Record<string, FieldRule> = {
  title: {
    required: true,
    type: "string",
    message: "标题不能为空"
  },
  content: {
    required: true,
    type: "string",
    message: "内容不能为空"
  },
  author_id: {
    type: "string",
    message: "作者 ID 必须为字符串"
  },
  term_id: {
    type: "number",
    message: "届次 ID 必须为数字"
  },
  publish_time: {
    type: "date",
    message: "发布时间格式错误"
  },
  status: {
    type: "enum",
    enumValues: ["草稿", "已发布", "归档"],
    message: "状态不合法"
  },
  file_url: {
    type: "string",
    message: "文件 URL 必须为字符串"
  },
  file_key: {
    type: "string",
    message: "文件 key 必须为字符串"
  },
  file_type: {
    type: "enum",
    enumValues: ["none", "pdf", "word"],
    message: "文件类型不合法"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * Announcement
 * --------------------------- */
export const validateAnnouncementCreate = createValidator(AnnouncementSchema, "create");
export const validateAnnouncementUpdate = createValidator(AnnouncementSchema, "update");
```

#### 8.13.2 服务层

📁`announcementsService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  AnnouncementWritable,
  AnnouncementWritableFields,
  AnnouncementRecord
} from '../types/dbTypes';
import { convertDocxToHtml } from '../utils/docxToHtml';
import { downloadFileFromOSS } from '../oss/downloadService';
import { deleteFileFromOSS, deleteFilesFromOSS } from '../oss/deleteService';
import fs from 'fs';

/** 创建公告（支持Word转HTML，自动映射可写字段，OSS存储附件） */
export const createAnnouncement = async (body: Partial<AnnouncementWritable>) => {
  if (!body.title) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '标题不能为空' };
  }

  let content = body.content || '';
  let imageKeys: string[] = [];

  // Word文件转HTML + 收集图片key
  if (body.file_type === 'word' && body.file_key) {
    const localPath = await downloadFileFromOSS(body.file_key);
    try {
      const result = await convertDocxToHtml(localPath);
      content = result.html;
      imageKeys = result.imageKeys;
    } catch (err) {
      fs.unlinkSync(localPath);
      throw { status: HTTP_STATUS.INTERNAL_ERROR, message: 'Word 文档转换失败' };
    }
    fs.unlinkSync(localPath);
  }

  // 构建可写入数据
  const writableBody: Partial<AnnouncementWritable> = {
    ...body,
    content,
    image_keys: imageKeys.length > 0 ? JSON.stringify(imageKeys) : null,
    publish_time: body.publish_time || null,
    status: body.status ?? '草稿',
    file_type: body.file_type ?? 'none'
  };

  // 自动筛选可写字段
  const fields = AnnouncementWritableFields.filter(f => writableBody[f] !== undefined);
  if (writableBody.image_keys !== undefined) fields.push('image_keys');

  const placeholders = fields.map(() => '?').join(', ');
  const values = fields.map(f => writableBody[f] ?? null);

  const sql = `INSERT INTO announcements (${fields.join(', ')}) VALUES (${placeholders})`;
  const result: any = await query(sql, values);

  return {
    message: '公告创建成功',
    announcement_id: result.insertId
  };
};

/** 更新公告（支持OSS附件替换、Word转HTML，自动过滤可写字段） */
export const updateAnnouncement = async (
  announcement_id: number,
  body: Partial<AnnouncementWritable>
) => {
  const [existing]: AnnouncementRecord[] | any = await query(
    `SELECT * FROM announcements WHERE announcement_id = ?`,
    [announcement_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '公告不存在' };
  }

  const updates: string[] = [];
  const values: any[] = [];

  // 处理附件替换 + Word 重新转换
  if (body.file_key && body.file_key !== existing.file_key) {
    // 删除旧附件
    if (existing.file_key) await deleteFileFromOSS(existing.file_key);
    // 删除旧图片
    if (existing.image_keys) {
      try {
        const oldKeys = JSON.parse(existing.image_keys);
        if (oldKeys.length > 0) await deleteFilesFromOSS(oldKeys);
      } catch (e) { console.error('删除旧图片失败:', e); }
    }

    updates.push(`file_url = ?`, `file_key = ?`, `file_type = ?`, `image_keys = NULL`, `content = ?`);
    values.push(body.file_url ?? null, body.file_key, body.file_type ?? 'none');

    if (body.file_type === 'word') {
      const localPath = await downloadFileFromOSS(body.file_key);
      try {
        const { html, imageKeys } = await convertDocxToHtml(localPath);
        values[values.length - 1] = html; // 替换 content
        values.push(imageKeys.length > 0 ? JSON.stringify(imageKeys) : null); // 更新 image_keys
        updates.push(`image_keys = ?`);
      } catch (err) {
        fs.unlinkSync(localPath);
        throw { status: HTTP_STATUS.INTERNAL_ERROR, message: 'Word 文档转换失败' };
      }
      fs.unlinkSync(localPath);
    } else {
      values.push(null); // image_keys = NULL
    }
  }

  // 自动更新其他文本字段
  for (const key of AnnouncementWritableFields) {
    if (
      key !== 'file_url' &&
      key !== 'file_key' &&
      key !== 'file_type' &&
      body[key] !== undefined
    ) {
      updates.push(`${key} = ?`);
      values.push(body[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新的字段' };
  }

  const sql = `UPDATE announcements SET ${updates.join(', ')} WHERE announcement_id = ?`;
  await query(sql, [...values, announcement_id]);

  return { message: '公告更新成功' };
};

/** 删除公告（精准删除附件 + 所有图片） */
export const deleteAnnouncement = async (announcement_id: number) => {
  const [existing]: any = await query(
    `SELECT file_key, image_keys FROM announcements WHERE announcement_id = ?`,
    [announcement_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '公告不存在' };
  }

  // 删除主附件
  if (existing.file_key) {
    await deleteFileFromOSS(existing.file_key).catch(() => { });
  }

  // 删除所有转换出的图片
  if (existing.image_keys) {
    try {
      const keys: string[] = JSON.parse(existing.image_keys);
      if (keys.length > 0) {
        await deleteFilesFromOSS(keys);
        console.log(`公告 ${announcement_id} 的 ${keys.length} 张图片已删除`);
      }
    } catch (e) {
      console.error('解析或删除图片失败:', e);
    }
  }

  await query(`DELETE FROM announcements WHERE announcement_id = ?`, [announcement_id]);

  return { message: '公告删除成功，所有相关文件已清理' };
};

/** 获取所有公告（关联届次信息，供后台使用） */
export const getAllAnnouncements = async () => {
  const sql = `
    SELECT 
      a.*,
      t.term_name,
      t.is_current
    FROM announcements a
    LEFT JOIN team_terms t ON a.term_id = t.term_id
    ORDER BY a.publish_time DESC
  `;
  const rows: any[] = await query(sql);

  return { total: rows.length, data: rows };
};

/** 获取已发布公告（关联届次信息，供门户展示） */
export const getPublishedAnnouncements = async () => {
  const sql = `
    SELECT 
      a.*,
      t.term_name
    FROM announcements a
    LEFT JOIN team_terms t ON a.term_id = t.term_id
    WHERE a.status = '已发布'
    ORDER BY a.publish_time DESC
  `;
  const rows: any[] = await query(sql);

  return { total: rows.length, data: rows };
};
~~~

#### 8.13.3 控制层

📁`announcementsController`

~~~ts
import { Request, Response } from 'express';
import {
  createAnnouncement,
  updateAnnouncement,
  deleteAnnouncement,
  getAllAnnouncements,
  getPublishedAnnouncements
} from '../services/announcementsService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建公告 */
export const createAnnouncementController = async (req: Request, res: Response) => {
  try {
    const body = req.body;

    const hasContent = typeof body.content === 'string' && body.content.trim() !== '';
    const hasFile = !!body.file_url || !!body.file_key;
    if (!hasContent && !hasFile) {
      errorResponse(res, '正文内容和附件至少要填写一个', HTTP_STATUS.FORBIDDEN);
      return;
    }

    const result = await createAnnouncement(body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 更新公告 */
export const updateAnnouncementController = async (req: Request, res: Response) => {
  try {
    const { announcement_id } = req.params;
    const result = await updateAnnouncement(Number(announcement_id), req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 删除公告 */
export const deleteAnnouncementController = async (req: Request, res: Response) => {
  try {
    const { announcement_id } = req.params;
    const result = await deleteAnnouncement(Number(announcement_id));
    successResponse(res, result, '公告删除成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取所有公告（后台） */
export const getAllAnnouncementsController = async (_req: Request, res: Response) => {
  try {
    const result = await getAllAnnouncements();
    successResponse(res, result, '查询公告成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};

/** 获取已发布公告（门户） */
export const getPublishedAnnouncementsController = async (_req: Request, res: Response) => {
  try {
    const result = await getPublishedAnnouncements();
    successResponse(res, result, '查询已发布公告成功');
  } catch (error: any) {
    errorResponse(res, error.message, error.status);
  }
};
~~~

#### 8.13.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { getPublishedAnnouncementsController } from '../controllers/announcementsController';

const router = express.Router();

/** 获取已发布公告 */
router.get('/announcements/published', getPublishedAnnouncementsController);

export default router;
~~~

📁`announcementsRouter`

~~~ts
import express from 'express';
import {
  createAnnouncementController,
  updateAnnouncementController,
  deleteAnnouncementController,
  getAllAnnouncementsController
} from '../controllers/announcementsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateAnnouncementCreate, validateAnnouncementUpdate } from '../validators/validateRequest';

const router = express.Router();

// 创建公告
router.post('/create', authorizeRole('admin', 'superadmin'), validateAnnouncementCreate, createAnnouncementController);

// 更新公告
router.put('/update/:announcement_id', authorizeRole('admin', 'superadmin'), validateAnnouncementUpdate, updateAnnouncementController);

// 删除公告
router.delete('/delete/:announcement_id', authorizeRole('admin', 'superadmin'), deleteAnnouncementController);

// 获取全部公告
router.get('/list', authorizeRole('admin', 'superadmin'), getAllAnnouncementsController);

export default router;
~~~

### 8.14 团队相册/风采展示管理接口

#### 8.14.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// GalleryPhoto 校验
// ---------------------------
export const GalleryPhotoSchema: Record<string, FieldRule> = {
  term_id: {
    type: "number",
    message: "届次 ID 必须为数字"
  },
  activity_id: {
    type: "number",
    message: "活动 ID 必须为数字"
  },
  title: {
    type: "string",
    message: "标题必须为字符串"
  },
  image_url: {
    required: true,
    type: "string",
    message: "图片 URL 不能为空"
  },
  image_key: {
    required: true,
    type: "string",
    message: "图片 key 不能为空"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  uploaded_by: {
    type: "string",
    message: "上传人必须为字符串"
  },
  sort_order: {
    type: "number",
    message: "排序必须为数字"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * GalleryPhoto
 * --------------------------- */
export const validateGalleryPhotoCreate = createValidator(GalleryPhotoSchema, "create");
export const validateGalleryPhotoUpdate = createValidator(GalleryPhotoSchema, "update");
```

#### 8.14.2 服务层

📁`galleryPhotosService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import { deleteFileFromOSS } from '../oss/deleteService';
import {
  GalleryPhotoWritable,
  GalleryPhotoWritableFields,
  GalleryPhotoRecord
} from '../types/dbTypes';

/** 创建照片（OSS存储，必填image_url和image_key，自动映射可写字段） */
export const createPhoto = async (body: Partial<GalleryPhotoWritable>) => {
  if (!body.image_url || !body.image_key) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: 'image_url 和 image_key 不能为空'
    };
  }

  // 自动构建插入字段与值
  const fields = GalleryPhotoWritableFields;
  const values = fields.map(f => body[f] ?? null);

  const sql = `
    INSERT INTO gallery_photos (${fields.join(', ')})
    VALUES (${fields.map(() => '?').join(', ')})
  `;

  const result: any = await query(sql, values);

  return { message: '照片上传成功', photo_id: result.insertId };
};

/** 更新照片（支持OSS图片替换，自动过滤可写字段） */
export const updatePhoto = async (
  photo_id: number,
  body: Partial<GalleryPhotoWritable>
) => {
  const [existing]: GalleryPhotoRecord[] = await query(
    `SELECT * FROM gallery_photos WHERE photo_id = ?`,
    [photo_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '照片不存在' };
  }

  const updates: string[] = [];
  const values: any[] = [];

  // 图片替换（需同时提供image_url和image_key）
  if (body.image_key && body.image_key !== existing.image_key) {
    if (!body.image_url) {
      throw {
        status: HTTP_STATUS.BAD_REQUEST,
        message: '修改图片时必须同时提供 image_url 和 image_key'
      };
    }

    // 删除旧图
    if (existing.image_key) {
      await deleteFileFromOSS(existing.image_key);
    }

    // 写入新图片信息
    updates.push('image_url = ?', 'image_key = ?', 'uploaded_by = ?');
    values.push(body.image_url, body.image_key, body.uploaded_by ?? null);
  }

  // 自动更新其他普通字段
  for (const key of GalleryPhotoWritableFields) {
    if (
      key !== 'image_url' &&
      key !== 'image_key' &&
      body[key] !== undefined
    ) {
      updates.push(`${key} = ?`);
      values.push(body[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新字段' };
  }

  const sql = `UPDATE gallery_photos SET ${updates.join(', ')} WHERE photo_id = ?`;
  await query(sql, [...values, photo_id]);

  return { message: '照片更新成功' };
};

/** 删除照片（连带删除OSS图片文件） */
export const deletePhoto = async (photo_id: number) => {
  const [existing]: GalleryPhotoRecord[] = await query(
    `SELECT * FROM gallery_photos WHERE photo_id = ?`,
    [photo_id]
  );

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '照片不存在' };
  }

  // 删除OSS图片
  if (existing.image_key) {
    await deleteFileFromOSS(existing.image_key);
  }

  await query(`DELETE FROM gallery_photos WHERE photo_id = ?`, [photo_id]);

  return { message: '照片删除成功' };
};

/** 获取全部照片（关联届次信息，供后台使用，按上传时间倒序） */
export const getAllPhotos = async () => {
  const sql = `
    SELECT p.*, t.term_name
    FROM gallery_photos p
    LEFT JOIN team_terms t ON p.term_id = t.term_id
    ORDER BY p.uploaded_at DESC
  `;

  const rows: any[] = await query(sql);
  return { total: rows.length, data: rows };
};

/** 按届次筛选照片（供门户展示，按上传时间倒序） */
export const getPhotosByTerm = async (term_id: number) => {
  const sql = `
    SELECT * FROM gallery_photos
    WHERE term_id = ?
    ORDER BY uploaded_at DESC
  `;

  const rows: GalleryPhotoRecord[] = await query(sql, [term_id]);
  return { total: rows.length, data: rows };
};

/** 按活动筛选照片（供门户展示，按上传时间倒序） */
export const getPhotosByActivity = async (activity_id: number) => {
  const sql = `
    SELECT * FROM gallery_photos
    WHERE activity_id = ?
    ORDER BY uploaded_at DESC
  `;

  const rows: GalleryPhotoRecord[] = await query(sql, [activity_id]);
  return { total: rows.length, data: rows };
};
~~~

#### 8.14.3 控制层

📁galleryPhotosController`

~~~ts
import { Request, Response } from 'express';
import {
  createPhoto,
  updatePhoto,
  deletePhoto,
  getAllPhotos,
  getPhotosByTerm,
  getPhotosByActivity
} from '../services/galleryPhotosService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建照片 */
export const createPhotoController = async (req: Request, res: Response) => {
  try {
    req.body.uploaded_by = req.user.student_id;
    const result = await createPhoto(req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 更新照片 */
export const updatePhotoController = async (req: Request, res: Response) => {
  try {
    const { photo_id } = req.params;
    if (req.body.image_key) {
      req.body.uploaded_by = req.user.student_id;
    }
    const result = await updatePhoto(Number(photo_id), req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 删除照片 */
export const deletePhotoController = async (req: Request, res: Response) => {
  try {
    const { photo_id } = req.params;
    const result = await deletePhoto(Number(photo_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 后台照片列表 */
export const getAllPhotosController = async (_req: Request, res: Response) => {
  try {
    const result = await getAllPhotos();
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 门户-按届次显示照片 */
export const getPhotosByTermController = async (req: Request, res: Response) => {
  try {
    const { term_id } = req.params;
    const result = await getPhotosByTerm(Number(term_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 门户-按活动显示照片 */
export const getPhotosByActivityController = async (req: Request, res: Response) => {
  try {
    const { activity_id } = req.params;
    const result = await getPhotosByActivity(Number(activity_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};
~~~

#### 8.14.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import { getPhotosByTermController, getPhotosByActivityController } from '../controllers/galleryPhotosController';

const router = express.Router();

/** 获取届次照片 */
router.get('/gallery-photos/term/:term_id', getPhotosByTermController);

/** 获取活动照片 */
router.get('/gallery-photos/activity/:activity_id', getPhotosByActivityController);

export default router;
~~~

📁`galleryPhotosRouter`

~~~ts
import express from 'express';
import {
  createPhotoController,
  updatePhotoController,
  deletePhotoController,
  getAllPhotosController
} from '../controllers/galleryPhotosController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateGalleryPhotoCreate, validateGalleryPhotoUpdate } from '../validators/validateRequest';

const router = express.Router();

// 后台创建照片
router.post('/create', authorizeRole('admin', 'superadmin'), validateGalleryPhotoCreate, createPhotoController);

// 后台更新照片
router.put('/update/:photo_id', authorizeRole('admin', 'superadmin'), validateGalleryPhotoUpdate, updatePhotoController);

// 删除照片
router.delete('/delete/:photo_id', authorizeRole('admin', 'superadmin'), deletePhotoController);

// 后台照片列表
router.get('/list', authorizeRole('admin', 'superadmin'), getAllPhotosController);

export default router;
~~~

### 8.15 服务队发展历程管理接口

#### 8.15.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// TeamMilestone 校验
// ---------------------------
export const TeamMilestoneSchema: Record<string, FieldRule> = {
  term_id: {
    type: "number",
    message: "届次 ID 必须为数字"
  },
  title: {
    required: true,
    type: "string",
    message: "标题不能为空"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  event_date: {
    required: true,
    type: "date",
    message: "事件日期格式错误"
  },
  event_type: {
    type: "string",
    message: "事件类型必须为字符串"
  },
  image_url: {
    type: "string",
    message: "图片 URL 必须为字符串"
  },
  image_key: {
    type: "string",
    message: "图片 key 必须为字符串"
  },
  created_by: {
    type: "string",
    message: "创建人必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * TeamMilestone
 * --------------------------- */
export const validateTeamMilestoneCreate = createValidator(TeamMilestoneSchema, "create");
export const validateTeamMilestoneUpdate = createValidator(TeamMilestoneSchema, "update");
```

#### 8.15.2 服务层

📁`teamMilestonesService`

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import { deleteFileFromOSS } from '../oss/deleteService';
import {
  TeamMilestoneWritable,
  TeamMilestoneWritableFields,
  TeamMilestoneRecord
} from '../types/dbTypes';

/** 创建里程碑事件（必填标题和日期，图片上传需配套image_key，自动映射可写字段） */
export const createMilestone = async (
  body: Partial<TeamMilestoneWritable>
) => {
  if (!body.title || !body.event_date) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: 'title 和 event_date 不能为空'
    };
  }

  // 图片上传校验（需同时提供image_url和image_key）
  if (body.image_url && !body.image_key) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '上传图片时必须提供 image_key'
    };
  }

  // 自动构建插入字段与值
  const fields = TeamMilestoneWritableFields;
  const values = fields.map(f => body[f] ?? null);

  const sql = `
    INSERT INTO team_milestones (${fields.join(', ')})
    VALUES (${fields.map(() => '?').join(', ')})
  `;

  const result: any = await query(sql, values);

  return { message: '里程碑创建成功', milestone_id: result.insertId };
};

/** 更新里程碑（支持OSS图片替换，自动过滤可写字段） */
export const updateMilestone = async (
  milestone_id: number,
  body: Partial<TeamMilestoneWritable>
) => {
  const rows = await query<TeamMilestoneRecord[]>(
    `SELECT * FROM team_milestones WHERE milestone_id = ?`,
    [milestone_id]
  );
  const existing = rows[0];

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '里程碑不存在' };
  }

  const updates: string[] = [];
  const values: any[] = [];

  // 图片替换逻辑（需同时提供image_url和image_key）
  if (body.image_key && body.image_key !== existing.image_key) {
    if (!body.image_url) {
      throw {
        status: HTTP_STATUS.BAD_REQUEST,
        message: '替换图片时必须同时提供 image_url 和 image_key'
      };
    }

    // 删除旧OSS图片
    if (existing.image_key) {
      await deleteFileFromOSS(existing.image_key);
    }

    updates.push('image_url = ?', 'image_key = ?');
    values.push(body.image_url, body.image_key);
  }

  // 自动更新其他普通字段
  for (const key of TeamMilestoneWritableFields) {
    if (
      key !== 'image_url' &&
      key !== 'image_key' &&
      body[key] !== undefined
    ) {
      updates.push(`${key} = ?`);
      values.push(body[key]);
    }
  }

  if (updates.length === 0) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '没有可更新字段' };
  }

  const sql = `
    UPDATE team_milestones SET ${updates.join(', ')}
    WHERE milestone_id = ?
  `;

  await query(sql, [...values, milestone_id]);

  return { message: '里程碑更新成功' };
};

/** 删除里程碑（连带删除OSS图片文件） */
export const deleteMilestone = async (milestone_id: number) => {
  const rows = await query<TeamMilestoneRecord[]>(
    `SELECT * FROM team_milestones WHERE milestone_id = ?`,
    [milestone_id]
  );
  const existing = rows[0];

  if (!existing) {
    throw { status: HTTP_STATUS.NOT_FOUND, message: '里程碑不存在' };
  }

  // 删除OSS图片
  if (existing.image_key) {
    await deleteFileFromOSS(existing.image_key);
  }

  await query(
    `DELETE FROM team_milestones WHERE milestone_id = ?`,
    [milestone_id]
  );

  return { message: '里程碑删除成功' };
};

/** 获取所有里程碑（关联届次信息，供后台使用，按事件日期倒序） */
export const getAllMilestones = async () => {
  const sql = `
    SELECT m.*, t.term_name
    FROM team_milestones m
    LEFT JOIN team_terms t ON m.term_id = t.term_id
    ORDER BY m.event_date DESC
  `;
  const rows = await query<TeamMilestoneRecord[]>(sql);
  return { total: rows.length, data: rows };
};

/** 按届次筛选里程碑（供门户展示，按事件日期正序） */
export const getMilestonesByTerm = async (term_id: number) => {
  const sql = `
    SELECT *
    FROM team_milestones
    WHERE term_id = ?
    ORDER BY event_date ASC
  `;
  const rows = await query<TeamMilestoneRecord[]>(sql, [term_id]);
  return { total: rows.length, data: rows };
};

/** 按事件类型筛选里程碑（供门户展示，按事件日期正序） */
export const getMilestonesByType = async (event_type: string) => {
  const sql = `
    SELECT *
    FROM team_milestones
    WHERE event_type = ?
    ORDER BY event_date ASC
  `;
  const rows = await query<TeamMilestoneRecord[]>(sql, [event_type]);
  return { total: rows.length, data: rows };
};

/** 按时间范围筛选里程碑（供门户展示，按事件日期正序） */
export const getMilestonesByDateRange = async (
  start: string,
  end: string
) => {
  const sql = `
    SELECT *
    FROM team_milestones
    WHERE event_date BETWEEN ? AND ?
    ORDER BY event_date ASC
  `;
  const rows = await query<TeamMilestoneRecord[]>(sql, [start, end]);
  return { total: rows.length, data: rows };
};
~~~

#### 8.15.3 控制层

📁`teamMilestonesController`

~~~ts
import { Request, Response } from 'express';
import {
  createMilestone,
  updateMilestone,
  deleteMilestone,
  getAllMilestones,
  getMilestonesByTerm,
  getMilestonesByType,
  getMilestonesByDateRange
} from '../services/teamMilestonesService';
import { successResponse, errorResponse } from '../utils/response';

/** 创建里程碑 */
export const createMilestoneController = async (req: Request, res: Response) => {
  try {
    req.body.created_by = req.user.student_id;
    const result = await createMilestone(req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 更新里程碑 */
export const updateMilestoneController = async (req: Request, res: Response) => {
  try {
    const { milestone_id } = req.params;
    const result = await updateMilestone(Number(milestone_id), req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 删除里程碑 */
export const deleteMilestoneController = async (req: Request, res: Response) => {
  try {
    const { milestone_id } = req.params;
    const result = await deleteMilestone(Number(milestone_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 后台里程碑列表 */
export const getAllMilestonesController = async (_req: Request, res: Response) => {
  try {
    const result = await getAllMilestones();
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 门户-按届次筛选里程碑 */
export const getMilestonesByTermController = async (req: Request, res: Response) => {
  try {
    const { term_id } = req.params;
    const result = await getMilestonesByTerm(Number(term_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 门户-按类型筛选里程碑 */
export const getMilestonesByTypeController = async (req: Request, res: Response) => {
  try {
    const { event_type } = req.params;
    const result = await getMilestonesByType(event_type);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 门户-按时间范围筛选里程碑 */
export const getMilestonesByDateRangeController = async (
  req: Request,
  res: Response
) => {
  try {
    const { start, end } = req.query;
    const result = await getMilestonesByDateRange(
      String(start),
      String(end)
    );

    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};
~~~

#### 8.15.4 路由层

📁`publicRouter`

~~~ts
import express from 'express';
import {
  getMilestonesByTermController,
  getMilestonesByTypeController,
  getMilestonesByDateRangeController
} from '../controllers/teamMilestoneController';

const router = express.Router();

/** 获取届次历程 */
router.get('/team-milestones/term/:term_id', getMilestonesByTermController);

/** 按事件类型获取历程 */
router.get('/team-milestones/type/:event_type', getMilestonesByTypeController);

/** 按时间范围获取历程 */
router.get('/team-milestones/date-range', getMilestonesByDateRangeController);

export default router;
~~~

📁teamMilestonesRouter`

~~~ts
import express from 'express';
import {
  createMilestoneController,
  updateMilestoneController,
  deleteMilestoneController,
  getAllMilestonesController
} from '../controllers/teamMilestonesController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateTeamMilestoneCreate, validateTeamMilestoneUpdate } from '../validators/validateRequest';

const router = express.Router();

// 创建里程碑
router.post('/create', authorizeRole('admin', 'superadmin'), validateTeamMilestoneCreate, createMilestoneController);

// 更新里程碑
router.put('/update/:milestone_id', authorizeRole('admin', 'superadmin'), validateTeamMilestoneUpdate, updateMilestoneController);

// 删除里程碑
router.delete('/delete/:milestone_id', authorizeRole('admin', 'superadmin'), deleteMilestoneController);

// 后台里程碑列表
router.get('/list', authorizeRole('admin', 'superadmin'), getAllMilestonesController);

export default router;
~~~

### 8.16 系统操作日志管理接口

#### 8.16.1 校验层

📁`validators/validateSchemas`

~~~ts
// ---------------------------
// OperationLog 校验
// ---------------------------
export const OperationLogSchema: Record<string, FieldRule> = {
  user_id: {
    required: true,
    type: "string",
    message: "用户 ID 不能为空"
  },
  action: {
    required: true,
    type: "string",
    message: "操作动作不能为空"
  },
  target_table: {
    type: "string",
    message: "目标表必须为字符串"
  },
  target_id: {
    type: "string",
    message: "目标 ID 必须为字符串"
  },
  description: {
    type: "string",
    message: "描述必须为字符串"
  },
  ip_address: {
    type: "string",
    message: "IP 地址必须为字符串"
  },
  user_agent: {
    type: "string",
    message: "User-Agent 必须为字符串"
  },
};
~~~

📁`validators/validateRequest`

```ts
/* ---------------------------
 * OperationLog
 * --------------------------- */
export const validateOperationLogCreate = createValidator(OperationLogSchema, "create");
export const validateOperationLogUpdate = createValidator(OperationLogSchema, "update");
```

#### 8.16.2 服务层

📁`operationLogsService`

```ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import { OperationLogRecord } from '../types/dbTypes';

/** 查询参数类型（避免 any） */
interface OperationLogQueryParams {
  page?: number | string;
  pageSize?: number | string;
  user_id?: string;
  action?: string;
  start_date?: string;
  end_date?: string;
}

/** 后台分页查询操作日志（支持用户ID、操作类型、时间范围多条件过滤） */
export const getOperationLogs = async (queryParams: OperationLogQueryParams) => {
  let {
    page = 1,
    pageSize = 20,
    user_id,
    action,
    start_date,
    end_date,
  } = queryParams;

  // 格式化分页参数为数字
  page = Number(page) || 1;
  pageSize = Number(pageSize) || 20;

  const conditions: string[] = [];
  const values: any[] = [];

  // 拼接查询条件
  if (user_id) {
    conditions.push('user_id = ?');
    values.push(user_id);
  }
  if (action) {
    conditions.push('action = ?');
    values.push(action);
  }
  if (start_date) {
    conditions.push('created_at >= ?');
    values.push(start_date);
  }
  if (end_date) {
    conditions.push('created_at <= ?');
    values.push(end_date);
  }

  const whereSQL = conditions.length ? `WHERE ${conditions.join(' AND ')}` : '';

  // 统计符合条件的日志总数
  const totalSql = `SELECT COUNT(*) AS total FROM operation_logs ${whereSQL}`;
  const [{ total }]: { total: number }[] = await query(totalSql, values);

  const offset = (page - 1) * pageSize;

  // 分页查询日志数据（按创建时间倒序）
  const sql = `
    SELECT *
    FROM operation_logs
    ${whereSQL}
    ORDER BY created_at DESC
    LIMIT ? OFFSET ?
  `;

  const rows: OperationLogRecord[] = await query(sql, [...values, pageSize, offset]);

  return { total, page, pageSize, data: rows };
};

/** 查看单条操作日志详情 */
export const getOperationLogById = async (log_id: number) => {
  const [row]: OperationLogRecord[] = await query(
    `SELECT * FROM operation_logs WHERE log_id = ?`,
    [log_id]
  );

  if (!row) {
    throw {
      status: HTTP_STATUS.NOT_FOUND,
      message: '日志不存在',
    };
  }

  return row;
};
```

#### 8.16.3 控制层

📁`operationLogsController`

~~~ts
import { Request, Response } from 'express';
import { getOperationLogs, getOperationLogById } from '../services/operationLogsService';
import { successResponse, errorResponse } from '../utils/response';

/** 操作日志分页列表（后台用） */
export const getLogsController = async (req: Request, res: Response) => {
  try {
    const result = await getOperationLogs(req.query);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 操作日志单条详情（按log_id查询） */
export const getLogByIdController = async (req: Request, res: Response) => {
  try {
    const { log_id } = req.params;
    const result = await getOperationLogById(Number(log_id));
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};
~~~

#### 8.16.4 路由层

📁`operationLogsRouter`

~~~ts
import express from 'express';
import { getLogsController, getLogByIdController } from '../controllers/operationLogsController';
import { authorizeRole } from '../middlewares/authMiddleware';

const router = express.Router();

/** 操作日志分页查询 */
router.get('/list', authorizeRole('admin', 'superadmin'), getLogsController);

/** 操作日志单条查询（按log_id） */
router.get('/:log_id', authorizeRole('admin', 'superadmin'), getLogByIdController);

export default router;
~~~



## 九、API接口文档

### 9.1 通用返回格式规范

所有接口返回格式由 `src/utils/response.ts` 统一封装，响应结构固定如下：

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {},
  "meta": {},
  "debug": {}
}
```

**字段说明**

| 字段名    | 类型        | 说明                                                         |
| --------- | ----------- | ------------------------------------------------------------ |
| `code`    | number      | HTTP 状态码（如 200 / 400 / 401 / 500）                      |
| `success` | boolean     | 是否成功（`code` 在 2xx 范围内即为成功）                     |
| `message` | string      | 操作结果说明（如成功、错误原因等）                           |
| `data`    | object/null | 实际业务数据内容，可为空                                     |
| `meta`    | object/null | 附加元数据（分页信息、统计信息等，可选）                     |
| `debug`   | object/null | 开发模式下返回的调试信息（仅在 NODE_ENV=development 时存在） |

**响应方法来源**

来自 `src/utils/response.ts`：

- `successResponse`：成功响应（默认 200）
- `errorResponse`：失败响应（默认 500，可附带 debug）
- `sendResponse`：可自定义状态码，例如 201、204、400 等
- `HTTP_STATUS`：集中管理所有 HTTP 状态码枚举

**项目中统一使用的状态码（HTTP_STATUS）**

| 常量名                | 状态码 | 说明                   |
| --------------------- | ------ | ---------------------- |
| `OK`                  | 200    | 请求成功               |
| `CREATED`             | 201    | 创建成功               |
| `BAD_REQUEST`         | 400    | 参数错误               |
| `UNAUTHORIZED`        | 401    | 未登录 / Token 失效    |
| `FORBIDDEN`           | 403    | 权限不足               |
| `NOT_FOUND`           | 404    | 资源不存在             |
| `CONFLICT`            | 409    | 数据冲突（如邮箱重复） |
| `INTERNAL_ERROR`      | 500    | 内部服务器错误         |
| `SERVICE_UNAVAILABLE` | 503    | 服务不可用             |

> 所有接口将在文档中使用这些状态码，不会出现其它自定义数字。

**Token 与权限规范（全局要求）**

所有非 `/public/\**` 的接口必须携带 Token

请求头格式：

```makefile
Authorization: Bearer <token>
```

接口会根据需求限制访问角色：

| 角色         | 名称       | 权限说明                   |
| ------------ | ---------- | -------------------------- |
| `user`       | 普通用户   | 仅允许访问用户相关业务     |
| `admin`      | 管理员     | 拥有更多管理权限           |
| `superadmin` | 超级管理员 | 拥有最高权限，可管理管理员 |

### 9.2 接口测试建议

为了保证接口在开发与联调阶段稳定可测，建议使用以下规范进行测试。

| 工具                             | 说明                                       |
| -------------------------------- | ------------------------------------------ |
| **Postman / Apifox**             | 适合接口调试、环境变量管理、Token 自动注入 |
| **VSCode + Thunder Client**      | 轻量级、本地即可使用                       |
| **自动化测试(Jest + Supertest)** | 用于编写单元测试与集成测试                 |

**接口测试注意事项**

- 登录后正确保存 Token（环境变量非常有用）
- 管理员接口必须使用管理员账号的 token
- 超级管理员接口不能使用普通管理员户 token
- 如涉及上传，请确认 Content-Type 是否为 `multipart/form-data`
- Debug 信息仅在开发环境出现，不会在生产环境返回

### 9.3 OSS直传接口

用于前端上传头像、图片、文档等文件至阿里云 OSS。上传方式采用 **前端直传**，后端仅负责生成上传签名，不接触文件流。

#### 9.3.1 获取 OSS 直传签名

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **接口地址** | `/api/oss/signature`                                         |
| **请求方法** | `POST`                                                       |
| **是否鉴权** | 是（普通用户 / 管理员 / 超级管理员均可）                     |
| **功能描述** | 后端根据指定目录生成 OSS 直传签名（policy、signature、key 前缀等） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名 | 类型   | 必填 | 说明                                                         |
| ------ | ------ | ---- | ------------------------------------------------------------ |
| dir    | string | 否   | 上传目录前缀，不传则默认 `"uploads/"`。必须以 `/` 结尾，例如 `"avatars/"`、`"uploads/test/"` |

**请求说明**

- `dir` 用于限制前端上传的 `key` 必须以该目录开头

   **示例：**若 dir = `avatars/` → key 必须类似 `avatars/image_123.png`

- 服务器自动生成：

  - policy（上传策略，不可篡改）
  - signature（policy 签名）
  - expire（过期时间戳）

- 单文件大小限制：**最大 10MB**

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "success",
  "data": {
    "host": "https://ctbu-cqt.oss-cn-chengdu.aliyuncs.com/",
    "accessid": "LTAI5tPMxqNbJ91VyJqcgGoV",
    "signature": "r/3gXJdYcAgsWV4JLi2i3LvIyEA=",
    "policy": "eyJleHBpcmF0aW9uIjoiMjAyNS0xMS0xMVQxNDowNjoyMC4wMDBaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjBdLFsic3RhcnRzLXdpdGgiLCIka2V5IiwidXBsb2Fkcy90ZXN0Il1dfQ==",
    "expire": 1762869980,
    "dir": "uploads/test/"
  }
}
```

**状态码说明**

| 状态码 | message  | 说明                       |
| ------ | -------- | -------------------------- |
| 401    | 未授权   | 未携带 Token 或 Token 失效 |
| 400    | 参数错误 | dir 格式不正确             |
| 500    | 服务异常 | 签名计算失败、配置缺失等   |

#### 9.3.2 前端直传文件到 OSS

前端使用第 9.3.1 步骤返回的数据，直接将文件上传至 OSS，无需后端中转。

| 项目                     | 内容                                          |
| ------------------------ | --------------------------------------------- |
| **接口地址（直传目标）** | `https://<bucket>.oss-<region>.aliyuncs.com/` |
| **请求方法**             | `POST`                                        |
| **是否鉴权**             | 否（公开上传，不带 Token）                    |
| **功能描述**             | 使用表单方式上传文件到 OSS                    |

> 文件最终访问路径 = `host + key`

**请求体（form-data）**

| Key                   | Value                  | 说明                              |
| --------------------- | ---------------------- | --------------------------------- |
| OSSAccessKeyId        | `<accessid>`           | 获取自签名接口                    |
| signature             | `<signature>`          | 获取自签名接口                    |
| policy                | `<policy>`             | Base64 编码上传策略               |
| key                   | `uploads/test/xxx.png` | 最终文件路径（必须以 `dir` 开头） |
| success_action_status | `200`                  | 上传成功后 OSS 返回的状态码       |
| file                  | 文件对象               | 用户选择的本地文件                |

**上传说明与注意事项**

- **key 必须以签名接口返回的 dir 开头**，否则会被拒绝

  如 dir = `avatars/`，`key` 必须为：

  - `avatars/a.jpg`
  - `avatars/2025/avatar123.png`

- 文件大小限制：**≤ 10MB**

- 后端生成的 `policy` 已固定目录与大小限制，任何不符合条件的请求会被 OSS 拒绝

- 上传成功时，OSS 返回 200 或指定的 success_action_status

### 9.4 邮箱接口

本模块用于发送、验证、清理邮箱验证码。验证码采用 6 位数字，默认有效期 5 分钟，并具有 1 分钟发送限流机制。

#### 9.4.1 发送邮箱验证码

| 项目         | 内容                                            |
| ------------ | ----------------------------------------------- |
| **接口地址** | `/api/public/email/send`                        |
| **请求方法** | `POST`                                          |
| **是否鉴权** | 否（公共接口）                                  |
| **可用角色** | 任意（未登录用户也可）                          |
| **功能描述** | 发送邮箱验证码（含 1 分钟限流、入库、邮件发送） |

**请求头**

无需 Authorization

```makefile
Content-Type: application/json
```

**请求体（JSON）**

| 字段名 | 类型   | 必填 | 说明                                                         |
| ------ | ------ | ---- | ------------------------------------------------------------ |
| email  | string | 是   | 目标邮箱，必须是学校邮箱格式（如 `xxx@ctbu.edu.cn`）         |
| type   | string | 否   | 验证码类型，默认 `register`，可在业务中扩展如 login/resetPassword 等 |

**请求逻辑说明**

- 同一邮箱 + type 的验证码 **1 分钟内只能发送一次**
- 验证码有效期 **5 分钟**
- 会写入数据库 `email_verification_codes` 表
- 会通过 `sendCodeEmail()` 实际发送邮件

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "验证码已发送，请查收邮箱"
}
```

**错误响应示例**

| 状态码 | message                  | 说明                     |
| ------ | ------------------------ | ------------------------ |
| 400    | 邮箱不能为空             | 请求缺少 email           |
| 400    | 邮箱格式错误             | 不符合校验规则           |
| 400    | 发送过于频繁，请稍后再试 | 1 分钟内重复发送         |
| 500    | 发送验证码失败           | 邮件服务异常或数据库异常 |

#### 9.4.2 校验邮箱验证码

| 项目         | 内容                                             |
| ------------ | ------------------------------------------------ |
| **接口地址** | `/api/public/email/verify`                       |
| **请求方法** | `POST`                                           |
| **是否鉴权** | 否（公共接口）                                   |
| **可用角色** | 任意（未登录用户也可）                           |
| **功能描述** | 校验邮箱验证码有效性，包括匹配、过期、状态更新等 |

**请求头**

无需 Authorization

```makefile
Content-Type: application/json
```

**请求体（JSON）**

| 字段名 | 类型   | 必填 | 说明                        |
| ------ | ------ | ---- | --------------------------- |
| email  | string | 是   | 验证的邮箱                  |
| code   | string | 是   | 用户收到的 6 位验证码       |
| type   | string | 否   | 验证码类型，默认 `register` |

**校验逻辑说明**

- 查询该邮箱 + type 最新的一条验证码
- 校验验证码是否匹配
- 校验是否过期
- 校验通过后会将 `verified` 更新为 `1`
- 返回校验结果（不返回验证码内容）

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "邮箱验证成功"
}
```

**失败响应示例**

| 状态码 | message              | 说明           |
| ------ | -------------------- | -------------- |
| 400    | 邮箱和验证码不能为空 | 缺少必传参数   |
| 400    | 邮箱格式错误         | 不符合校验规则 |
| 400    | 验证码无效或已过期   | 错误或已过期   |
| 500    | 验证失败，请稍后再试 | 服务层异常     |

#### 9.4.3 清理验证码记录（管理员）

| 项目         | 内容                                               |
| ------------ | -------------------------------------------------- |
| **接口地址** | `/api/email/cleanup`                               |
| **请求方法** | `DELETE`                                           |
| **是否鉴权** | 是（需要 Token）                                   |
| **可用角色** | 管理员 / 超级管理员                                |
| **功能描述** | 清理过期或已验证的验证码记录，可按天数清理更早记录 |

**请求头**

```makefile
Authorization: Bearer <token>
```

**查询参数（Query）**

| 参数名     | 类型   | 必填 | 说明                                                         |
| ---------- | ------ | ---- | ------------------------------------------------------------ |
| daysBefore | number | 否   | 删除 `daysBefore` 天前的记录，不传则删除所有已过期或 verified=1 的记录 |

**清理逻辑说明**

- 若传入 `daysBefore`：删除 `created_at < 当前时间 - daysBefore 天` 的所有记录
- 若未传：删除 **过期验证码** 与 **已验证验证码**（verified=1）

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "清理完成，共删除 43 条记录",
  "data": {
    "deleted": 43
  }
}
```

**失败响应示例**

| 状态码 | message              | 说明                         |
| ------ | -------------------- | ---------------------------- |
| 401    | 未授权               | 未携带 Token 或权限不足      |
| 500    | 清理失败，请稍后再试 | 数据库异常、权限中间件异常等 |

### 9.5 注册 / 登录接口

本模块用于用户注册、登录及管理员进行批量导入用户账号。注册接口依赖邮箱验证码，批量注册接口不需要验证码。

#### 9.5.1 注册

| 项目         | 内容                           |
| ------------ | ------------------------------ |
| **接口地址** | `/public/auth/register`        |
| **请求方法** | `POST`                         |
| **是否鉴权** | 否（公共接口）                 |
| **可用角色** | 任意（未登录用户也可）         |
| **功能描述** | 用户注册，需要邮箱验证码校验。 |

**请求头**

无需 Authorization

```makefile
Content-Type: application/json
```

**请求体（JSON）**

| 字段名     | 类型   | 必填 | 说明                     |
| ---------- | ------ | ---- | ------------------------ |
| student_id | string | 是   | 10 位数字学生账号        |
| email      | string | 是   | 必须以 @ctbu.edu.cn 结尾 |
| password   | string | 是   | 强密码，需通过校验       |
| name       | string | 是   | 用户姓名                 |
| code       | string | 是   | 邮箱验证码               |

**业务逻辑说明**

- 校验邮箱是否以 `@ctbu.edu.cn` 结尾
- 检查学号或邮箱是否已存在
- 校验验证码是否匹配、是否过期、是否已使用
- 校验成功后更新验证码状态为 verified = 1
- 密码使用 bcrypt.hash 加密
- 向 `auth_login` 写入账号记录（默认角色 user）
- 向 `auth_info` 写入基础信息
- 发送欢迎邮件

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "注册成功",
  "data": {
    "message": "注册成功"
  }
}
```

**错误响应示例**

| 状态码 | message                      | 说明                 |
| ------ | ---------------------------- | -------------------- |
| 400    | 邮箱必须以 @ctbu.edu.cn 结尾 | 邮箱格式不符合要求   |
| 409    | 该学号或邮箱已注册           | 用户重复注册         |
| 400    | 验证码错误或未发送           | 未找到有效验证码记录 |
| 400    | 验证码已过期                 | expires_at < now     |
| 400    | 验证码已被使用，请重新获取   | verified = 1         |
| 400    | 密码强度不符合要求           | 未通过 password 校验 |
| 500    | 服务器错误                   | 其他内部异常         |

#### 9.5.2 登录

| 项目         | 内容                       |
| ------------ | -------------------------- |
| **接口地址** | `/public/auth/login`       |
| **请求方法** | `POST`                     |
| **是否鉴权** | 否（公共接口）             |
| **可用角色** | 任意（未登录用户也可）     |
| **功能描述** | 登录系统并获取 JWT Token。 |

**请求头**

无需 Authorization

```makefile
Content-Type: application/json
```

**请求体（JSON）**

| 字段名     | 类型   | 必填 | 说明                          |
| ---------- | ------ | ---- | ----------------------------- |
| loginInput | string | 是   | 学号、ctbu 邮箱或普通邮箱均可 |
| password   | string | 是   | 用户密码                      |

**业务逻辑说明**

- 若 loginInput 为学号，则按学号查询
- 若为邮箱，则采用邮箱查询
- 用户不存在则返回 401
- 使用 bcrypt.compare 校验密码
- 校验成功后生成 JWT Token，包含：
  - auth_id
  - student_id
  - email
  - role
- 返回 token 及用户基础信息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "<JWT Token>",
    "student_id": "2020123456",
    "email": "xxx@ctbu.edu.cn",
    "role":  "admin",
  }
}
```

**错误响应示例**

| 状态码 | message      | 说明         |
| ------ | ------------ | ------------ |
| 401    | 用户不存在   | 查无该账号   |
| 401    | 密码错误     | 密码校验失败 |
| 400    | 请求格式错误 | 登录校验失败 |
| 500    | 服务器错误   | 其他内部异常 |

#### 9.5.3 批量注册（管理员）

| 项目         | 内容                               |
| ------------ | ---------------------------------- |
| **接口地址** | `/auth/login/batch-register`       |
| **请求方法** | `POST`                             |
| **是否鉴权** | 是（需要 Token）                   |
| **可用角色** | 管理员 / 超级管理员                |
| **功能描述** | 管理员批量导入用户账号，无需验证码 |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

请求体为数组，每个对象按以下结构：

| 字段名     | 类型   | 必填 | 说明          |
| ---------- | ------ | ---- | ------------- |
| student_id | string | 是   | 10 位数字     |
| email      | string | 是   | ctbu 校园邮箱 |
| password   | string | 是   | 强密码        |
| name       | string | 是   | 用户姓名      |

**业务逻辑说明**

- 遍历数组内每个用户
- 校验学号与邮箱是否重复
- 密码加密后写入 auth_login
- 写入基本信息到 auth_info
- 单条错误不会停止任务，将错误记录汇总后返回

**成功返回示例**

```json
{
  "code": 200,
  "message": "批量注册成功",
  "data": {
    "message": "批量注册完成",
    "total": 3,
    "success": 2,
    "failed": 1,
    "details": [
      {
        "student_id": "2020123456",
        "email": "a@ctbu.edu.cn",
        "status": "success"
      },
      {
        "student_id": "2020123457",
        "email": "b@ctbu.edu.cn",
        "status": "failed",
        "reason": "该学号或邮箱已注册"
      }
    ]
  }
}
```

**错误响应示例**

| 状态码 | message              | 说明                     |
| ------ | -------------------- | ------------------------ |
| 400    | 请求体必须为非空数组 | users 数组为空或不是数组 |
| 403    | 权限不足             | 非管理员/超管访问        |
| 401    | Token 无效           | 未携带或携带无效 Token   |
| 500    | 服务器错误           | 其他内部异常             |

### 9.6 删除用户接口

本模块用于管理员删除系统用户，包括 **单个删除** 与 **批量删除** 两种方式。

该操作为危险操作，仅限 **超级管理员（superadmin）** 使用。

#### 9.6.1 删除单个用户（按学号）

| 项目         | 内容                                 |
| ------------ | ------------------------------------ |
| **接口地址** | `/api/auth/login/delete/:student_id` |
| **请求方法** | `DELETE`                             |
| **是否鉴权** | 是（需要 Token）                     |
| **可用角色** | 仅限 **superadmin**                  |
| **功能描述** | 根据学号删除系统中的单个用户         |

**请求头**

```makefile
Authorization: Bearer <token>
```

无需请求体。

**参数说明**

| 参数名     | 位置 | 类型   | 必填 | 说明                        |
| ---------- | ---- | ------ | ---- | --------------------------- |
| student_id | path | string | 是   | 10 位学号，必须符合校验规则 |

**删除逻辑说明**

1. 根据 `student_id` 查询用户是否存在于 `auth_login` 表。
2. 若不存在返回 404。
3. 若存在，则依次删除：
   - `auth_info`
   - `auth_login`
4. 返回删除成功消息。

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "用户删除成功",
  "data": {
    "message": "用户 2020123456 删除成功"
  }
}
```

**失败响应示例**

| 状态码 | message    | 说明             |
| ------ | ---------- | ---------------- |
| 401    | 未授权     | 未携带 token     |
| 403    | 权限不足   | 不是 superadmin  |
| 404    | 用户不存在 | 数据库查无该学号 |
| 500    | 删除失败   | 删除过程异常     |

#### 9.6.2 批量删除用户（超管）

| 项目         | 内容                             |
| ------------ | -------------------------------- |
| **接口地址** | `/api/auth/login/delete/batch`   |
| **请求方法** | `POST`                           |
| **是否鉴权** | 是（需要 Token）                 |
| **可用角色** | 仅限 **superadmin**              |
| **功能描述** | 批量删除多个用户（通过学号数组） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

原始输入格式：

```json
{
  "studentIds": ["2020123456", "2020123457"]
}
```

校验层会自动把它转为：

```json
[
  { "student_id": "2020123456" },
  { "student_id": "2020123457" }
]
```

**字段说明**

| 字段名     | 类型     | 必填 | 说明                      |
| ---------- | -------- | ---- | ------------------------- |
| studentIds | string[] | 是   | 学号数组，需至少 1 条记录 |

**业务逻辑说明**

对每个学号逐个执行：

1. 检查该学号对应的用户是否存在
2. 若不存在 → 记录为 `failed`
3. 若存在 → 删除 `auth_info` 与 `auth_login`
4. 批量流程不会被单个错误阻断
5. 最终返回整体统计与每条记录是否删除成功

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量删除完成",
  "data": {
    "message": "批量删除完成",
    "total": 3,
    "success": 2,
    "failed": 1,
    "details": [
      {
        "student_id": "2020123456",
        "status": "success"
      },
      {
        "student_id": "2020123457",
        "status": "failed",
        "reason": "用户不存在"
      },
      {
        "student_id": "2020123458",
        "status": "success"
      }
    ]
  }
}
```

**失败响应示例**

| 状态码 | message              | 说明                      |
| ------ | -------------------- | ------------------------- |
| 400    | 请求体必须为非空数组 | studentIds 为空或格式错误 |
| 401    | 未授权               | 未携带 token              |
| 403    | 权限不足             | 非 superadmin             |
| 500    | 删除失败，请稍后再试 | 服务层或数据库异常        |

### 9.7 用户信息管理接口

本模块用于对系统用户的基本信息（姓名、性别、学院、技能标签、头像等）进行 **查询、更新、批量导入/更新** 操作。

功能包含：

- 用户自主更新自己的信息
- 管理员/超管更新任意用户信息
- 查询单个用户信息（含账号信息）
- 查询所有用户信息（管理员）
- 批量导入或批量更新用户信息

#### 9.7.1 更新单个用户信息

| 项目         | 内容                                     |
| ------------ | ---------------------------------------- |
| **接口地址** | `/api/auth/info/update/:student_id`      |
| **请求方法** | `PUT`                                    |
| **是否鉴权** | 是（需要 Token）                         |
| **可用角色** | 本人 / admin / superadmin                |
| **功能描述** | 根据学号更新用户的基础信息（含头像处理） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

仅需填写要更新的字段，所有字段均为 **可选**：

| 字段名      | 类型   | 说明                                  |
| ----------- | ------ | ------------------------------------- |
| name        | string | 姓名                                  |
| gender      | enum   | “男 / 女 / 其他”                      |
| college     | string | 学院名称                              |
| major       | string | 专业                                  |
| phone       | string | 手机号（自动校验格式）                |
| avatar_url  | string | 新头像 URL（旧头像会自动从 OSS 删除） |
| avatar_key  | string | OSS 对象 key                          |
| join_date   | string | 入队日期（YYYY-MM-DD）                |
| total_hours | number | 总服务时长（数字）                    |
| skill_tags  | string | 技能标签（逗号分隔）                  |

**参数说明**

| 参数名     | 位置 | 类型   | 必填 | 说明         |
| ---------- | ---- | ------ | ---- | ------------ |
| student_id | path | string | 是   | 要更新的学号 |

**业务逻辑说明**

- 校验请求体字段格式（validateAuthInfoUpdate）
- 若更新头像：
  - 新旧头像不同 → 自动删除 OSS 旧文件
- 自动构建 SQL，仅更新请求体中出现的字段
- 用户只能修改自己的信息，管理员/超管可修改任意用户
- 返回更新成功消息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "用户信息更新成功",
  "data": {
    "message": "用户 2020123456 信息更新成功"
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明                    |
| ------ | ---------------- | ----------------------- |
| 400    | 学号不能为空     | student_id 缺失         |
| 400    | 没有可更新的字段 | 请求体为空              |
| 403    | 权限不足         | 非本人且不是管理员/超管 |
| 404    | 用户信息不存在   | 数据库查无该 student_id |
| 500    | 更新失败         | SQL 异常等              |

#### 9.7.2 查询单个用户信息

| 项目         | 内容                               |
| ------------ | ---------------------------------- |
| **接口地址** | `/api/auth/info/info/:student_id`  |
| **请求方法** | `GET`                              |
| **是否鉴权** | 是                                 |
| **可用角色** | 本人 / admin / superadmin          |
| **功能描述** | 查询单个用户信息（含账号基础信息） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名     | 位置 | 类型   | 必填 | 说明       |
| ---------- | ---- | ------ | ---- | ---------- |
| student_id | path | string | 是   | 要查询学号 |

**查询逻辑说明**

- 权限校验：仅本人、管理员、超管可查
- 关联查询 `auth_info` + `auth_login` 两张表
- 返回完整信息（包含登录邮箱、角色）

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询用户信息成功",
  "data": {
    "student_id": "2023000001",
    "name": "张三",
    "gender": "男",
    "college": "计算机科学与技术学院",
    "major": "软件工程",
    "phone": "13812345678",
    "avatar_url": "https://oss.example.com/avatar/2023123456.png",
    "join_date": "2024-08-31T16:00:00.000Z",
    "total_hours": "120.5",
    "skill_tags": "[\"志愿服务\", \"前端开发\"]",
    "info_created_at": "2025-11-21T07:56:03.000Z",
    "info_updated_at": "2025-11-22T03:00:13.000Z",
    "email": "student1@ctbu.edu.cn",
    "role": "user",
    "account_created_at": "2025-11-21T07:56:03.000Z",
    "account_updated_at": "2025-11-21T07:56:03.000Z"
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明               |
| ------ | ---------------- | ------------------ |
| 403    | 权限不足         | 非本人且无管理权限 |
| 404    | 未找到该用户信息 | student_id 不存在  |

#### 9.7.3 查询所有用户信息（管理员）

| 项目         | 内容                             |
| ------------ | -------------------------------- |
| **接口地址** | `/api/auth/info/all`             |
| **请求方法** | `GET`                            |
| **是否鉴权** | 是                               |
| **可用角色** | admin / superadmin               |
| **功能描述** | 查询系统所有用户信息（关联账号） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有用户信息成功",
  "data": {
    "total": 2,
    "data": [
      {
        "student_id": "2023000001",
        "name": "张三",
        "gender": "男",
        "college": "计算机科学与技术学院",
        "major": "软件工程",
        "phone": "13812345678",
        "avatar_url": "https://oss.example.com/avatar/2023123456.png",
        "join_date": "2024-08-31T16:00:00.000Z",
        "total_hours": "120.5",
        "skill_tags": "[\"志愿服务\", \"前端开发\"]",
        "email": "student1@ctbu.edu.cn",
        "role": "user",
        "info_created_at": "2025-11-21T07:56:03.000Z",
        "account_created_at": "2025-11-21T07:56:03.000Z"
      },
      {
        "student_id": "2023000002",
        "name": "李四",
        "gender": null,
        "college": null,
        "major": null,
        "phone": null,
        "avatar_url": null,
        "join_date": null,
        "total_hours": "0.0",
        "skill_tags": null,
        "email": "student2@ctbu.edu.cn",
        "role": "user",
        "info_created_at": "2025-11-21T07:56:03.000Z",
        "account_created_at": "2025-11-21T07:56:03.000Z"
      }
    ]
  }
}
```

**失败响应示例**

| 状态码 | message  | 说明           |
| ------ | -------- | -------------- |
| 403    | 权限不足 | 仅管理员可使用 |
| 500    | 查询失败 | 数据库异常     |

#### 9.7.4 批量导入 / 更新用户信息（管理员）

| 项目         | 内容                                 |
| ------------ | ------------------------------------ |
| **接口地址** | `/api/auth/info/batch-import`        |
| **请求方法** | `POST`                               |
| **是否鉴权** | 是                                   |
| **可用角色** | admin / superadmin                   |
| **功能描述** | 批量根据学号更新用户信息（不会新增） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

```json
[
  {
    "student_id": "2023000001",
    "name": "张三",
    "college": "计算机学院",
    "phone": "13812345678"
  },
  {
    "student_id": "2023123457",
    "name": "李四",
    "major": "会计学",
    "gender": "女"
  }
]
```

**字段说明**

| 字段名     | 类型   | 必填 | 说明           |
| ---------- | ------ | ---- | -------------- |
| student_id | string | 是   | 要更新的学号   |
| name       | string | 是   | 目的怕对应错误 |
| 其他字段   | 任意   | 否   | 更新内容       |

**业务逻辑说明**

对每条记录执行：

- 如果缺少 `student_id`、`name` → 失败
- 若用户不存在 → `skipped`
- 若无可更新字段 → `skipped`
- 正常更新 → `updated`
- 任何单条失败不会中断整体执行

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量更新用户信息成功",
  "data": {
    "message": "批量信息更新完成",
    "total": 2,
    "updated": 1,
    "skipped": 1,
    "failed": 0,
    "details": [
      {
        "student_id": "2023000001",
        "status": "updated"
      },
      {
        "student_id": "2023123457",
        "status": "skipped",
        "reason": "用户不存在，未更新"
      }
    ]
  }
}
```

**失败响应示例**

| 状态码 | message                  | 说明                |
| ------ | ------------------------ | ------------------- |
| 400    | 请求体必须为非空数组     | 输入格式不符合要求  |
| 403    | 权限不足                 | 仅管理员/超管可操作 |
| 500    | 批量更新失败，请稍后再试 | 数据库或服务层异常  |

### 9.8 修改密码接口

本接口用于用户通过旧密码 + 邮箱验证码来完成密码修改。

#### 9.8.1 修改密码

| 项目         | 内容                                |
| ------------ | ----------------------------------- |
| **接口地址** | `/api/public/auth/change-password`  |
| **请求方法** | `POST`                              |
| **是否鉴权** | 否（仅依靠邮箱验证码）              |
| **可用角色** | 所有用户                            |
| **功能描述** | 用户通过旧密码 + 邮箱验证码修改密码 |

**请求头**

```makefile
Content-Type: application/json
```

**请求体（JSON）**

```json
{
  "email": "2020123456@ctbu.edu.cn",
  "oldPassword": "123456",
  "newPassword": "Aa123456!",
  "code": "582913"
}
```

**字段说明**

| 字段名      | 类型   | 必填 | 说明                       |
| ----------- | ------ | ---- | -------------------------- |
| email       | string | 是   | 必须为学校邮箱             |
| oldPassword | string | 是   | 用户当前旧密码             |
| newPassword | string | 是   | 必须满足强密码校验         |
| code        | string | 是   | 邮箱验证码（重置密码类型） |

**业务逻辑说明**

- 校验字段格式（validateChangePassword）
- 校验新旧密码不能相同
- 根据邮箱查询用户
- 校验旧密码是否正确
- 校验邮箱验证码是否正确、是否过期、是否已使用
- 使用 bcrypt 哈希新密码
- 更新数据库密码
- 邮件通知用户密码修改成功

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "密码修改成功",
  "data": {
    "message": "密码修改成功"
  }
}
```

**失败响应示例**

| 状态码 | message              | 说明               |
| ------ | -------------------- | ------------------ |
| 400    | 新旧密码不能一致     | 用户输入 new = old |
| 400    | 验证码错误或未发送   | 未找到验证码记录   |
| 400    | 验证码已过期         | expires_at 超时    |
| 400    | 验证码已被使用       | verified = 1       |
| 401    | 旧密码错误           | bcrypt 校验未通过  |
| 404    | 用户不存在           | email 未注册       |
| 500    | 修改失败，请稍后再试 | 数据库异常         |

### 9.9 部门管理接口

部门管理模块用于维护系统中的部门基础信息，包括部门创建、更新、查询、删除、批量创建等操作。

#### 9.9.1 创建部门（超管）

| 项目         | 内容                         |
| ------------ | ---------------------------- |
| **接口地址** | `/api/departments/create`    |
| **请求方法** | `POST`                       |
| **是否鉴权** | 是                           |
| **可用角色** | superadmin                   |
| **功能描述** | 创建一个新的部门（名称唯一） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名        | 类型   | 必填 | 说明                       |
| ------------- | ------ | ---- | -------------------------- |
| dept_name     | string | 是   | 部门名称（唯一）           |
| description   | string | 否   | 部门描述                   |
| leader_id     | string | 否   | 负责人学号（自动校验格式） |
| display_order | number | 否   | 排序数字，越小越靠前       |

**业务逻辑说明**

- 校验字段格式（`validateDepartmentCreate`）
- 检查部门名称是否已存在（唯一性约束）
- 自动构建 SQL 字段，仅插入请求体中出现的字段
- 创建成功后返回部门 ID

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "部门创建成功",
  "data": {
    "dept_id": 5,
    "dept_name": "外联部",
    "description": "外部联系与协调",
    "leader_id": "2020123456",
    "display_order": 3
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明                 |
| ------ | ---------------- | -------------------- |
| 400    | 部门名称不能为空 | dept_name 缺失       |
| 400    | 负责人ID格式错误 | leader_id 不符合规则 |
| 409    | 该部门名称已存在 | 重名                 |
| 500    | 创建失败         | SQL 异常等           |

#### 9.9.2 获取所有部门信息

| 项目         | 内容                             |
| ------------ | -------------------------------- |
| **接口地址** | `/api/public/departments/list`   |
| **请求方法** | `GET`                            |
| **是否鉴权** | 否（公开接口）                   |
| **可用角色** | 所有人                           |
| **功能描述** | 获取所有部门信息（含负责人姓名） |

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有部门成功",
  "data": {
    "total": 3,
    "data": [
      {
        "dept_id": 1,
        "dept_name": "组织部",
        "description": "负责组织建设",
        "leader_id": "2020123456",
        "leader_name": "张三",
        "display_order": 1
      },
      {
        "dept_id": 2,
        "dept_name": "宣传部",
        "description": "负责宣传材料制作",
        "leader_id": null,
        "leader_name": null,
        "display_order": 2
      }
    ]
  }
}
```

#### 9.9.3 获取单个部门信息

| 项目         | 内容                               |
| ------------ | ---------------------------------- |
| **接口地址** | `/api/public/departments/:dept_id` |
| **请求方法** | `GET`                              |
| **是否鉴权** | 否（公开接口）                     |
| **可用角色** | 所有人                             |
| **功能描述** | 查询单个部门信息（含负责人姓名）   |

**参数说明**

| 参数名  | 位置 | 类型 | 必填 | 说明       |
| ------- | ---- | ---- | ---- | ---------- |
| dept_id | path | int  | 是   | 部门主键ID |

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询部门信息成功",
  "data": {
    "dept_id": 2,
    "dept_name": "宣传部",
    "description": "负责宣传材料制作",
    "leader_id": "2021123456",
    "leader_name": "李四",
    "display_order": 2
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明           |
| ------ | ---------------- | -------------- |
| 404    | 未找到该部门信息 | dept_id 不存在 |

#### 9.9.4 更新部门信息（管理员）

| 项目         | 内容                                   |
| ------------ | -------------------------------------- |
| **接口地址** | `/api/departments/update/:dept_id`     |
| **请求方法** | `PUT`                                  |
| **是否鉴权** | 是                                     |
| **可用角色** | admin / superadmin                     |
| **功能描述** | 更新部门信息，仅更新请求体中的字段部分 |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体说明**

所有字段均为 **可选**：

| 字段名        | 类型   | 说明       |
| ------------- | ------ | ---------- |
| dept_name     | string | 新部门名称 |
| description   | string | 部门描述   |
| leader_id     | string | 负责人学号 |
| display_order | number | 排序数字   |

**业务逻辑说明**

- 校验字段格式（`validateDepartmentUpdate`）
- 检查部门是否存在
- 若部门名更新 → 校验是否重名
- 自动构建 SQL，仅更新出现的字段
- 返回更新结果

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "部门信息更新成功",
  "data": {
    "message": "部门 3 更新成功"
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明         |
| ------ | ---------------- | ------------ |
| 400    | 没有可更新的字段 | 请求体为空   |
| 404    | 部门不存在       | dept_id 无效 |
| 409    | 该部门名称已存在 | 新名称冲突   |
| 500    | 更新失败         | SQL 异常     |

#### 9.9.5 删除部门（超管）

| 项目         | 内容                               |
| ------------ | ---------------------------------- |
| **接口地址** | `/api/departments/delete/:dept_id` |
| **请求方法** | `DELETE`                           |
| **是否鉴权** | 是                                 |
| **可用角色** | superadmin                         |
| **功能描述** | 删除指定部门                       |

**请求头**

```makefile
Authorization: Bearer <token>
```

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "部门删除成功",
  "data": {
    "message": "部门 4 删除成功"
  }
}
```

**失败响应示例**

| 状态码 | message            | 说明         |
| ------ | ------------------ | ------------ |
| 404    | 部门不存在或已删除 | dept_id 无效 |

#### 9.9.6 批量创建部门（超管）

| 项目         | 内容                                     |
| ------------ | ---------------------------------------- |
| **接口地址** | `/api/departments/batch-create`          |
| **请求方法** | `POST`                                   |
| **是否鉴权** | 是                                       |
| **可用角色** | superadmin                               |
| **功能描述** | 批量创建多个部门（自动跳过已存在的名称） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

```json
[
  { "dept_name": "技术部", "leader_id": "2020112233" },
  { "dept_name": "宣传部", "description": "负责宣传" }
]
```

**字段说明**

| 字段名    | 类型   | 必填 | 说明           |
| --------- | ------ | ---- | -------------- |
| dept_name | string | 是   | 部门名称       |
| 其他字段  | 任意   | 否   | 与单条创建相同 |

**业务逻辑**

针对每条记录进行：

- dept_name 缺失 → `skipped`
- 如果名称已存在 → `skipped`
- 否则正常创建 → `created`

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量创建部门成功",
  "data": {
    "message": "批量部门创建完成",
    "total": 3,
    "created": 2,
    "skipped": 1,
    "details": {
      "created": [
        { "dept_id": 10, "dept_name": "技术部" },
        { "dept_id": 11, "dept_name": "财务部" }
      ],
      "skipped": [
        { "dept_name": "宣传部", "reason": "部门名称已存在" }
      ]
    }
  }
}
```

### 9.10 届次管理接口

本模块用于对 **服务队届次（team_terms）** 进行统一管理，包括：

- 创建届次（可指定是否为“当前届”）
- 更新届次
- 删除届次
- 批量创建届次（跳过已存在/不合法项）
- 查询单个届次
- 查询全部届次

其中，**创建/更新/删除/批量创建** 仅限 **超级管理员（superadmin）**。

#### 9.10.1 创建届次（超管）

| 项目         | 内容                     |
| ------------ | ------------------------ |
| **接口地址** | `/api/team-terms/create` |
| **请求方法** | `POST`                   |
| **是否鉴权** | 是（Token）              |
| **可用角色** | superadmin               |
| **功能描述** | 创建新的服务队届次记录   |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名     | 类型   | 必填 | 说明                 |
| ---------- | ------ | ---- | -------------------- |
| term_name  | string | 是   | 届次名称，必须唯一   |
| start_date | string | 否   | 开始时间：YYYY-MM-DD |
| end_date   | string | 否   | 结束时间：YYYY-MM-DD |
| is_current | number | 否   | 是否当前届（0/1）    |
| remark     | string | 否   | 备注                 |

**业务逻辑说明**

- 校验届次名称唯一（term_name 不可重复）
- 若 `is_current = 1` → 自动取消其他届次的 is_current
- 自动映射字段写入数据库
- 返回新增的 `term_id`

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "届次创建成功",
  "data": {
    "term_id": 3,
    "term_name": "第六届",
    "start_date": "2024-09-01",
    "end_date": "2025-07-01",
    "is_current": 1,
    "remark": "本届重点扩招"
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明           |
| ------ | ---------------- | -------------- |
| 400    | 届次名称不能为空 | term_name 缺失 |
| 409    | 该届次名称已存在 | term_name 重复 |
| 500    | 创建届次失败     | SQL 异常       |

#### 9.10.2 查询所有届次

| 项目         | 内容                          |
| ------------ | ----------------------------- |
| **接口地址** | `/api/public/team-terms/list` |
| **请求方法** | `GET`                         |
| **是否鉴权** | 否（公开接口）                |
| **可用角色** | 所有人                        |
| **功能描述** | 获取所有届次信息（时间排序）  |

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有届次成功",
  "data": {
    "total": 3,
    "data": [
      {
        "term_id": 3,
        "term_name": "第六届",
        "start_date": "2024-09-01",
        "end_date": "2025-07-01",
        "is_current": 1,
        "remark": null
      },
      {
        "term_id": 2,
        "term_name": "第五届",
        "start_date": "2023-09-01",
        "end_date": "2024-07-01",
        "is_current": 0,
        "remark": null
      }
    ]
  }
}
```

**失败响应示例**

| 状态码 | message  | 说明       |
| ------ | -------- | ---------- |
| 500    | 查询失败 | 数据库异常 |

#### 9.10.3 查询单个届次详情

| 项目         | 内容                              |
| ------------ | --------------------------------- |
| **接口地址** | `/api/public/team-terms/:term_id` |
| **请求方法** | `GET`                             |
| **是否鉴权** | 否（公开接口）                    |
| **可用角色** | 所有人                            |
| **功能描述** | 根据 term_id 查询特定届次详细信息 |

**参数说明**

| 参数名  | 位置 | 类型   | 必填 | 说明        |
| ------- | ---- | ------ | ---- | ----------- |
| term_id | path | number | 是   | 届次主键 ID |

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询届次信息成功",
  "data": {
    "term_id": 3,
    "term_name": "第六届",
    "start_date": "2024-09-01",
    "end_date": "2025-07-01",
    "is_current": 1,
    "remark": "本届重点扩招"
  }
}
```

**失败响应示例**

| 状态码 | message          | 说明           |
| ------ | ---------------- | -------------- |
| 404    | 未找到该届次信息 | term_id 不存在 |

#### 9.10.4 更新届次信息（超管）

| 项目         | 内容                              |
| ------------ | --------------------------------- |
| **接口地址** | `/api/team-terms/update/:term_id` |
| **请求方法** | `PUT`                             |
| **是否鉴权** | 是（Token）                       |
| **可用角色** | superadmin                        |
| **功能描述** | 根据 term_id 更新届次信息         |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（部分可选字段）**

| 字段名     | 类型   | 说明                |
| ---------- | ------ | ------------------- |
| term_name  | string | 届次名称            |
| start_date | string | 开始时间            |
| end_date   | string | 结束时间            |
| is_current | number | 是否为当前届（0/1） |
| remark     | string | 备注                |

**业务逻辑说明**

- 所有字段可选，未提供的字段不会更新
- 若 `is_current = 1` → 自动取消其他届的 current 状态
- 若无有效字段 → 返回错误

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "届次信息更新成功",
  "data": { "message": "届次 3 更新成功" }
}
```

**失败响应示例**

| 状态码 | message          | 说明           |
| ------ | ---------------- | -------------- |
| 400    | 没有可更新的字段 | 请求体为空     |
| 404    | 届次不存在       | term_id 不存在 |
| 500    | 更新失败         | SQL 异常       |

#### 9.10.5 删除届次（超管）

| 项目         | 内容                              |
| ------------ | --------------------------------- |
| **接口地址** | `/api/team-terms/delete/:term_id` |
| **请求方法** | `DELETE`                          |
| **是否鉴权** | 是（Token）                       |
| **可用角色** | superadmin                        |
| **功能描述** | 根据 term_id 删除指定届次         |

**请求头**

```makefile
Authorization: Bearer <token>
```

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "届次删除成功",
  "data": {
    "message": "届次 3 删除成功"
  }
}
```

**失败响应示例**

| 状态码 | message            | 说明         |
| ------ | ------------------ | ------------ |
| 404    | 届次不存在或已删除 | term_id 无效 |

#### 9.10.6 批量创建届次（超管）

| 项目         | 内容                               |
| ------------ | ---------------------------------- |
| **接口地址** | `/api/team-terms/batch-create`     |
| **请求方法** | `POST`                             |
| **是否鉴权** | 是                                 |
| **可用角色** | superadmin                         |
| **功能描述** | 批量创建届次（跳过重名或不合法项） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON 数组）**

```json
[
  {
    "term_name": "第七届",
    "start_date": "2025-09-01",
    "is_current": 0
  },
  {
    "term_name": "第五届",
    "start_date": "2023-09-01"
  }
]
```

**字段说明**

| 字段名    | 类型   | 必填 | 说明       |
| --------- | ------ | ---- | ---------- |
| term_name | string | 是   | 届次名称   |
| 其他字段  | 任意   | 否   | 同单个创建 |

**业务逻辑说明**

- 遍历每项：
  - 缺少 term_name → skipped
  - 名称已存在 → skipped
  - 插入失败 → skipped
- 成功和跳过不会互相影响
- 若 is_current=1 → 自动取消其他届

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量创建届次成功",
  "data": {
    "message": "批量届次创建完成",
    "total": 3,
    "created": 2,
    "skipped": 1,
    "details": {
      "created": [
        { "term_id": 7, "term_name": "第七届" },
        { "term_id": 8, "term_name": "第八届" }
      ],
      "skipped": [
        { "term_name": "第五届", "reason": "届次名称已存在" }
      ]
    }
  }
}
```

**失败响应示例**

| 状态码 | message              | 说明         |
| ------ | -------------------- | ------------ |
| 400    | 请求体必须为非空数组 | 输入格式错误 |
| 500    | 批量创建失败         | 数据库异常   |

### 9.11 骨干成员管理接口

骨干成员管理模块用于维护系统中的骨干成员信息，包括骨干成员的创建、更新、查询、删除、批量创建等操作，支持关联部门和届次信息，提供树状结构查询供门户展示。

#### 9.11.1 创建骨干成员（管理员）

| 项目         | 内容                                   |
| ------------ | -------------------------------------- |
| **接口地址** | `/api/backbone-members/create`         |
| **请求方法** | `POST`                                 |
| **是否鉴权** | 是                                     |
| **可用角色** | admin / superadmin                     |
| **功能描述** | 创建一个新的骨干成员（届次内学号唯一） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名     | 类型   | 必填 | 说明                                               |
| ---------- | ------ | ---- | -------------------------------------------------- |
| student_id | string | 是   | 学号（格式校验）                                   |
| dept_id    | number | 是   | 部门 ID                                            |
| term_id    | number | 是   | 届次 ID                                            |
| position   | string | 否   | 职位（可选值：队长、部长、副部长、部员，默认部员） |
| photo_url  | string | 否   | 照片 URL                                           |
| photo_key  | string | 否   | 照片 OSS 存储 key                                  |
| term_start | date   | 否   | 任期开始日期                                       |
| term_end   | date   | 否   | 任期结束日期                                       |
| remark     | string | 否   | 备注                                               |

**业务逻辑说明**

- 校验字段格式（`validateBackboneMemberCreate`）
- 校验必填字段（student_id、dept_id、term_id 不能为空）
- 校验职位合法性（仅支持指定枚举值）
- 校验届次内唯一性（同一学号在同一届次下不可重复）
- 自动构建 SQL 字段，仅插入请求体中出现的字段
- 职位未指定时默认设为 "部员"
- 创建成功后返回完整成员信息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "骨干成员创建成功",
  "data": {
    "member_id": 10,
    "student_id": "2020123456",
    "dept_id": 3,
    "term_id": 2,
    "position": "部长",
    "photo_url": "https://example.com/photos/xxx.jpg",
    "photo_key": "backbone/2020123456.jpg",
    "term_start": "2023-09-01",
    "term_end": "2024-06-30",
    "remark": "负责部门日常工作"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                         | 说明                         |
| ------ | ------------------------------- | ---------------------------- |
| 400    | 学号、部门 ID、届次 ID 不能为空 | 缺少必填字段                 |
| 400    | 学号错误                        | student_id 格式不合法        |
| 400    | 部门 ID 必须为数字              | dept_id 类型错误             |
| 400    | 无效的职务类型：xxx             | position 不在枚举范围内      |
| 401    | 未登录 / Token 失效             | 未携带 Token 或 Token 无效   |
| 403    | 权限不足                        | 非 admin/superadmin 角色访问 |
| 409    | 该成员在该届次下已存在          | 学号 + 届次组合重复          |
| 500    | 内部服务器错误                  | 数据库操作异常等             |

#### 9.11.2 获取所有骨干成员

| 项目         | 内容                                   |
| ------------ | -------------------------------------- |
| **接口地址** | `/api/public/backbone-members/list`    |
| **请求方法** | `GET`                                  |
| **是否鉴权** | 否（公开接口）                         |
| **可用角色** | 所有人                                 |
| **功能描述** | 获取所有骨干成员信息（关联部门、届次） |

**业务逻辑说明**

- 关联查询部门表（departments）获取部门名称
- 关联查询届次表（team_terms）获取届次名称和当前届标识
- 排序规则：按届次开始时间倒序 → 部门 ID 升序 → 职位升序

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有骨干成员成功",
  "data": {
    "total": 5,
    "data": [
      {
        "member_id": 10,
        "student_id": "2020123456",
        "student_name": "张三丰",
        "avatar_url": "https://example.com/photos/zhangsan.jpg",
        "dept_id": 3,
        "dept_name": "技术部",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "position": "部长",
        "term_start": "2023-09-01",
        "term_end": "2024-06-30",
        "remark": "负责部门日常工作",
        "created_at": "2023-08-15T10:20:30.000Z",
        "updated_at": "2024-01-10T08:15:22.000Z"
      },
      {
        "member_id": 11,
        "student_id": "2021123456",
        "student_name": "李四",
        "avatar_url": null,
        "dept_id": 3,
        "dept_name": "技术部",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "position": "部员",
        "term_start": null,
        "term_end": null,
        "remark": null,
        "created_at": "2023-09-20T14:30:45.000Z",
        "updated_at": "2023-09-20T14:30:45.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.11.3 获取骨干成员树状结构

| 项目         | 内容                                                 |
| ------------ | ---------------------------------------------------- |
| **接口地址** | `/api/public/backbone-members/tree`                  |
| **请求方法** | `GET`                                                |
| **是否鉴权** | 否（公开接口）                                       |
| **可用角色** | 所有人                                               |
| **功能描述** | 按届次→部门→成员的树状结构返回骨干信息（供门户展示） |

**业务逻辑说明**

- 关联查询届次表、部门表和骨干成员表
- 按届次开始时间倒序、部门 ID 升序排序
- 构建树状结构：届次列表 → 部门列表 → 成员列表
- 仅返回门户展示所需核心字段

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "获取骨干成员组织架构成功",
  "data": [
    {
      "term_id": 2,
      "term_name": "2023-2024届",
      "is_current": true,
      "departments": [
        {
          "dept_id": 1,
          "dept_name": "秘书处",
          "members": [
            {
              "member_id": 5,
              "student_id": "202000001",
              "student_name": "王五",
              "position": "部长",
              "avatar_url": "https://example.com/backbone/wangwu.jpg",
              "term_start": "2023-09-01",
              "term_end": "2024-06-30"
            },
            {
              "member_id": 6,
              "student_id": "202100002",
              "student_name": "赵六",
              "position": "副部长",
              "avatar_url": "https://example.com/backbone/zhaoliu.jpg",
              "term_start": "2023-09-01",
              "term_end": "2024-06-30"
            }
          ]
        },
        {
          "dept_id": 3,
          "dept_name": "技术部",
          "members": [
            {
              "member_id": 10,
              "student_id": "2020123456",
              "student_name": "张三丰",
              "position": "部长",
              "avatar_url": "https://example.com/photos/zhangsan.jpg",
              "term_start": "2023-09-01",
              "term_end": "2024-06-30"
            },
            {
              "member_id": 11,
              "student_id": "2021123456",
              "student_name": "李四",
              "position": "部员",
              "avatar_url": null,
              "term_start": null,
              "term_end": null
            }
          ]
        }
      ]
    },
    {
      "term_id": 1,
      "term_name": "2022-2023届",
      "is_current": false,
      "departments": [ /* ...历史届数据... */ ]
    }
  ],
  "meta": {},
  "debug": {}
}
```

#### 9.11.4 更新骨干成员信息（管理员）

| 项目         | 内容                                      |
| ------------ | ----------------------------------------- |
| **接口地址** | `/api/backbone-members/update/:member_id` |
| **请求方法** | `PUT`                                     |
| **是否鉴权** | 是                                        |
| **可用角色** | admin / superadmin                        |
| **功能描述** | 更新骨干成员信息，支持头像 OSS 文件替换   |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名    | 位置 | 类型 | 必填 | 说明            |
| --------- | ---- | ---- | ---- | --------------- |
| member_id | path | int  | 是   | 骨干成员主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名     | 类型   | 说明                                      |
| ---------- | ------ | ----------------------------------------- |
| student_id | string | 学号（格式校验）                          |
| dept_id    | number | 部门 ID                                   |
| term_id    | number | 届次 ID                                   |
| position   | string | 职位（可选值：队长、部长、副部长、部员）  |
| photo_url  | string | 照片 URL                                  |
| photo_key  | string | 照片 OSS 存储 key（变更时自动删除旧文件） |
| term_start | date   | 任期开始日期                              |
| term_end   | date   | 任期结束日期                              |
| remark     | string | 备注                                      |

**业务逻辑说明**

- 校验字段格式（`validateBackboneMemberUpdate`）
- 检查成员记录是否存在
- 校验职位合法性（仅支持指定枚举值）
- 若更新照片 key（photo_key）：
  - 自动删除 OSS 中存储的旧照片文件（删除失败不影响更新操作）
- 自动构建 SQL，仅更新请求体中出现的字段
- 返回更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "骨干成员信息更新成功",
  "data": {
    "message": "骨干成员更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                            |
| ------ | ------------------- | ------------------------------- |
| 400    | 没有可更新的字段    | 请求体为空                      |
| 400    | 无效的职务类型：xxx | position 不在枚举范围内         |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效      |
| 403    | 权限不足            | 非 admin/superadmin 角色访问    |
| 404    | 成员记录不存在      | member_id 无效                  |
| 500    | 内部服务器错误      | 数据库操作或 OSS 文件删除异常等 |

#### 9.11.5 删除骨干成员（管理员）

| 项目         | 内容                                      |
| ------------ | ----------------------------------------- |
| **接口地址** | `/api/backbone-members/delete/:member_id` |
| **请求方法** | `DELETE`                                  |
| **是否鉴权** | 是                                        |
| **可用角色** | admin / superadmin                        |
| **功能描述** | 删除指定骨干成员，连带删除 OSS 头像文件   |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名    | 位置 | 类型 | 必填 | 说明            |
| --------- | ---- | ---- | ---- | --------------- |
| member_id | path | int  | 是   | 骨干成员主键 ID |

**业务逻辑说明**

- 检查成员记录是否存在
- 若存在照片 OSS 存储 key：
  - 自动删除 OSS 中存储的照片文件（删除失败不影响主记录删除）
- 从数据库中删除成员记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "骨干成员删除成功",
  "data": {
    "message": "骨干成员删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                            |
| ------ | ------------------- | ------------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效      |
| 403    | 权限不足            | 非 admin/superadmin 角色访问    |
| 404    | 成员不存在          | member_id 无效或已删除          |
| 500    | 内部服务器错误      | 数据库操作或 OSS 文件删除异常等 |

#### 9.11.6 批量创建骨干成员（管理员）

| 项目         | 内容                                      |
| ------------ | ----------------------------------------- |
| **接口地址** | `/api/backbone-members/batch-create`      |
| **请求方法** | `POST`                                    |
| **是否鉴权** | 是                                        |
| **可用角色** | admin                                     |
| **功能描述** | 批量创建多个骨干成员，返回创建 / 失败详情 |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

```json
[
  {
    "student_id": "2020123456",
    "dept_id": 3,
    "term_id": 2,
    "position": "部长",
    "photo_url": "https://example.com/photos/xxx.jpg"
  },
  {
    "student_id": "2021123456",
    "dept_id": 3,
    "term_id": 2,
    "position": "部员"
  }
]
```

**字段说明**

| 字段名     | 类型   | 必填 | 说明                                               |
| ---------- | ------ | ---- | -------------------------------------------------- |
| student_id | string | 是   | 学号（格式校验）                                   |
| dept_id    | number | 是   | 部门 ID                                            |
| term_id    | number | 是   | 届次 ID                                            |
| position   | string | 否   | 职位（可选值：队长、部长、副部长、部员，默认部员） |
| photo_url  | string | 否   | 照片 URL                                           |
| photo_key  | string | 否   | 照片 OSS 存储 key                                  |
| term_start | date   | 否   | 任期开始日期                                       |
| term_end   | date   | 否   | 任期结束日期                                       |
| remark     | string | 否   | 备注                                               |

**业务逻辑说明**

- 校验请求体格式（必须为非空数组，`validateBatchBackboneMemberCreate`）
- 对每条记录分别处理：
  1. 校验必填字段（student_id、dept_id、term_id）
  2. 校验职位合法性（仅支持指定枚举值）
  3. 校验届次内唯一性（同一学号在同一届次下不可重复）
  4. 校验通过则创建成员记录，职位未指定时默认设为 "部员"
  5. 校验失败则记录失败原因
- 批量处理完成后，返回统计信息和详细结果

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量创建骨干成员成功",
  "data": {
    "total": 3,
    "created": 2,
    "failed": 1,
    "createdList": [
      {
        "member_id": 12,
        "student_id": "2020123456",
        "dept_id": 3,
        "term_id": 2,
        "position": "部长",
        "photo_url": "https://example.com/photos/xxx.jpg"
      },
      {
        "member_id": 13,
        "student_id": "2021123456",
        "dept_id": 3,
        "term_id": 2,
        "position": "部员"
      }
    ],
    "failedList": [
      {
        "student_id": "2022123456",
        "reason": "该成员在该届次下已存在"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                                 | 说明                                     |
| ------ | --------------------------------------- | ---------------------------------------- |
| 400    | 请求体必须为非空数组                    | 请求体格式错误（非数组或空数组）         |
| 400    | 缺少必要字段 student_id/dept_id/term_id | 单条记录缺少必填字段                     |
| 400    | 无效的职务类型：xxx                     | 单条记录 position 不在枚举范围内         |
| 400    | 学号错误                                | 单条记录 student_id 格式不合法           |
| 401    | 未登录 / Token 失效                     | 未携带 Token 或 Token 无效               |
| 403    | 权限不足                                | 非 admin 角色访问（仅 admin 可批量创建） |
| 500    | 内部服务器错误                          | 数据库操作异常等                         |

> 注：批量创建时单条记录失败不会影响其他记录的创建，最终会返回所有记录的处理结果明细。

### 9.12 志愿活动记录管理接口

志愿活动记录管理模块用于维护系统中的志愿活动信息，包括活动的创建、更新、查询、删除以及创建、更新、查询、删除以及状态切换等操作，支持关联部门和届次信息。

#### 9.12.1 创建志愿活动（管理员）

| 项目         | 内容                     |
| ------------ | ------------------------ |
| **接口地址** | `/api/activities/create` |
| **请求方法** | `POST`                   |
| **是否鉴权** | 是                       |
| **可用角色** | admin / superadmin       |
| **功能描述** | 创建一个新的志愿活动     |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名            | 类型   | 必填 | 说明                                           |
| ----------------- | ------ | ---- | ---------------------------------------------- |
| activity_name     | string | 是   | 活动名称                                       |
| dept_id           | number | 否   | 部门 ID                                        |
| term_id           | number | 否   | 届次 ID                                        |
| category          | string | 否   | 活动类别                                       |
| cover_url         | string | 否   | 封面图片 URL                                   |
| cover_key         | string | 否   | 封面图片 OSS 存储 key                          |
| recruitment_limit | number | 否   | 招募人数                                       |
| service_hours     | number | 否   | 服务时长                                       |
| location          | string | 否   | 活动地点                                       |
| start_time        | date   | 否   | 开始时间                                       |
| end_time          | date   | 否   | 结束时间                                       |
| description       | string | 否   | 活动描述                                       |
| status            | string | 否   | 状态（可选值：草稿、进行中、已结束，默认草稿） |
| created_by        | string | 否   | 创建人                                         |

**业务逻辑说明**

- 校验字段格式（`validateActivityCreate`）
- 校验活动名称不能为空
- 自动构建 SQL 字段，仅插入请求体中出现的字段
- 创建成功后返回活动 ID 及关键信息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "活动创建成功",
  "data": {
    "activity_id": 5,
    "activity_name": "社区环保志愿活动",
    "service_hours": 3,
    "status": "草稿"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 活动名称不能为空    | activity_name 缺失           |
| 400    | 部门 ID 必须为数字  | dept_id 类型错误             |
| 400    | 状态不合法          | status 不在枚举范围内        |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.12.2 获取所有志愿活动

| 项目         | 内容                                   |
| ------------ | -------------------------------------- |
| **接口地址** | `/api/public/activities/list`          |
| **请求方法** | `GET`                                  |
| **是否鉴权** | 否（公开接口）                         |
| **可用角色** | 所有人                                 |
| **功能描述** | 获取所有志愿活动信息（关联部门、届次） |

**业务逻辑说明**

- 关联查询部门表（departments）获取部门名称
- 关联查询届次表（team_terms）获取届次名称
- 按创建时间倒序排序

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有活动成功",
  "data": {
    "total": 2,
    "data": [
      {
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "dept_id": 3,
        "dept_name": "技术部",
        "term_id": 2,
        "term_name": "2023-2024届",
        "category": "环保",
        "cover_url": "https://example.com/covers/xxx.jpg",
        "recruitment_limit": 20,
        "service_hours": 3,
        "location": "XX社区",
        "start_time": "2024-05-18T09:00:00.000Z",
        "end_time": "2024-05-18T12:00:00.000Z",
        "description": "参与社区环境清理活动",
        "status": "进行中",
        "created_by": "2020123456",
        "created_at": "2024-05-10T14:30:00.000Z"
      },
      {
        "activity_id": 4,
        "activity_name": "敬老院关怀活动",
        "dept_id": 2,
        "dept_name": "宣传部",
        "term_id": 2,
        "term_name": "2023-2024届",
        "category": "公益",
        "cover_url": "https://example.com/covers/yyy.jpg",
        "recruitment_limit": 15,
        "service_hours": 2,
        "location": "XX敬老院",
        "start_time": "2024-05-11T09:00:00.000Z",
        "end_time": "2024-05-11T11:00:00.000Z",
        "description": "为老人提供陪伴和服务",
        "status": "已结束",
        "created_by": "2020123456",
        "created_at": "2024-05-05T10:20:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.12.3 获取活动详情

| 项目         | 内容                                  |
| ------------ | ------------------------------------- |
| **接口地址** | `/api/public/activities/:activity_id` |
| **请求方法** | `GET`                                 |
| **是否鉴权** | 否（公开接口）                        |
| **可用角色** | 所有人                                |
| **功能描述** | 获取单个志愿活动的详细信息            |

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**业务逻辑说明**

- 关联查询部门表和届次表获取相关信息
- 检查活动是否存在

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询活动详情成功",
  "data": {
    "activity_id": 5,
    "activity_name": "社区环保志愿活动",
    "dept_id": 3,
    "dept_name": "技术部",
    "term_id": 2,
    "term_name": "2023-2024届",
    "category": "环保",
    "cover_url": "https://example.com/covers/xxx.jpg",
    "cover_key": "activities/xxx.jpg",
    "recruitment_limit": 20,
    "service_hours": 3,
    "location": "XX社区",
    "start_time": "2024-05-18T09:00:00.000Z",
    "end_time": "2024-05-18T12:00:00.000Z",
    "description": "参与社区环境清理活动，主要负责街道垃圾收集和分类",
    "status": "进行中",
    "created_by": "2020123456",
    "created_at": "2024-05-10T14:30:00.000Z"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message    | 说明             |
| ------ | ---------- | ---------------- |
| 404    | 活动不存在 | activity_id 无效 |

#### 9.12.4 更新志愿活动（管理员）

| 项目         | 内容                                  |
| ------------ | ------------------------------------- |
| **接口地址** | `/api/activities/update/:activity_id` |
| **请求方法** | `PUT`                                 |
| **是否鉴权** | 是                                    |
| **可用角色** | admin / superadmin                    |
| **功能描述** | 更新志愿活动信息                      |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名            | 类型   | 说明                                 |
| ----------------- | ------ | ------------------------------------ |
| activity_name     | string | 活动名称                             |
| dept_id           | number | 部门 ID                              |
| term_id           | number | 届次 ID                              |
| category          | string | 活动类别                             |
| cover_url         | string | 封面图片 URL                         |
| cover_key         | string | 封面图片 OSS 存储 key                |
| recruitment_limit | number | 招募人数                             |
| service_hours     | number | 服务时长                             |
| location          | string | 活动地点                             |
| start_time        | date   | 开始时间                             |
| end_time          | date   | 结束时间                             |
| description       | string | 活动描述                             |
| status            | string | 状态（可选值：草稿、进行中、已结束） |
| created_by        | string | 创建人                               |

**业务逻辑说明**

- 校验字段格式（`validateActivityUpdate`）
- 检查活动是否存在
- 自动构建 SQL，仅更新请求体中出现的字段
- 返回更新成功提示及更新的字段列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "活动更新成功",
  "data": {
    "message": "活动更新成功",
    "updated_fields": ["recruitment_limit", "status"]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 没有可更新的字段    | 请求体为空                   |
| 400    | 状态不合法          | status 不在枚举范围内        |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 活动不存在          | activity_id 无效             |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.12.5 删除志愿活动（管理员）

| 项目         | 内容                                  |
| ------------ | ------------------------------------- |
| **接口地址** | `/api/activities/delete/:activity_id` |
| **请求方法** | `DELETE`                              |
| **是否鉴权** | 是                                    |
| **可用角色** | admin / superadmin                    |
| **功能描述** | 删除指定的志愿活动                    |

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**业务逻辑说明**

- 检查活动是否存在
- 从数据库中删除活动记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "活动删除成功",
  "data": {
    "message": "活动删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 活动不存在          | activity_id 无效             |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.12.6 切换活动状态（管理员）

| 项目         | 内容                                     |
| ------------ | ---------------------------------------- |
| **接口地址** | `/api/activities/status/:activity_id`    |
| **请求方法** | `PATCH`                                  |
| **是否鉴权** | 是                                       |
| **可用角色** | admin / superadmin                       |
| **功能描述** | 切换志愿活动的状态（草稿→进行中→已结束） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**请求体（JSON）**

| 字段名 | 类型   | 必填 | 说明                                     |
| ------ | ------ | ---- | ---------------------------------------- |
| status | string | 是   | 目标状态（可选值：草稿、进行中、已结束） |

**业务逻辑说明**

- 校验状态值的合法性（仅支持指定的三个状态）
- 检查活动是否存在
- 更新活动状态
- 返回状态更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "活动状态更新成功",
  "data": {
    "message": "活动状态已更新为：进行中"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 非法状态值          | status 不在枚举范围内        |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 活动不存在          | activity_id 无效             |
| 500    | 内部服务器错误      | 数据库操作异常等             |

### 9.13 参与志愿活动相关接口

参与志愿活动相关接口用于管理学生与志愿活动的关联关系，包括活动报名、取消报名、签到管理、服务时长更新以及报名记录查询等操作，支持普通学生和管理员 / 超管不同权限的操作场景。

#### 9.13.1 获取活动报名名单（管理员）

| 项目         | 内容                                                 |
| ------------ | ---------------------------------------------------- |
| **接口地址** | `/api/activity-participants/list/:activity_id`       |
| **请求方法** | `GET`                                                |
| **是否鉴权** | 是                                                   |
| **可用角色** | admin / superadmin                                   |
| **功能描述** | 获取指定活动的所有报名人员信息（关联活动、学生详情） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**业务逻辑说明**

- 关联查询活动表（activities）获取活动名称
- 关联查询学生信息表（auth_info）获取学生姓名、学院、专业
- 按报名记录 ID 升序排序
- 返回报名总人数和详细名单

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "获取活动报名名单成功",
  "data": {
    "total": 2,
    "data": [
      {
        "record_id": 101,
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "student_id": "2020123456",
        "student_name": "张三",
        "college": "计算机学院",
        "major": "软件工程",
        "role": "志愿者",
        "service_hours": 0,
        "signed_in": 0,
        "remark": null,
        "created_at": "2024-05-12T10:00:00.000Z"
      },
      {
        "record_id": 102,
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "student_id": "2021123456",
        "student_name": "李四",
        "college": "环境学院",
        "major": "环境工程",
        "role": "志愿者",
        "service_hours": 0,
        "signed_in": 0,
        "remark": "自带工具",
        "created_at": "2024-05-12T10:30:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.13.2 学生报名活动

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **接口地址** | `/api/activity-participants/join`                            |
| **请求方法** | `POST`                                                       |
| **是否鉴权** | 是                                                           |
| **可用角色** | user / admin / superadmin                                    |
| **功能描述** | 学生报名志愿活动（普通用户仅可自己报名，管理员 / 超管可代报） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名      | 类型   | 必填 | 说明                     |
| ----------- | ------ | ---- | ------------------------ |
| activity_id | number | 是   | 活动主键 ID              |
| student_id  | string | 是   | 报名学生学号（格式校验） |

**业务逻辑说明**

- 校验字段格式（`validateActivityParticipantCreate`）
- 权限校验：
  - 普通用户（user）仅能报名自己的学号
  - 管理员 / 超管可代其他学生报名
- 校验活动是否存在
- 校验是否已重复报名该活动
- 校验活动人数限制（若设置了招募人数上限）
- 自动填充默认值：角色 = 志愿者、服务时长 = 0、签到状态 = 0
- 生成报名记录

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "报名成功",
  "data": {
    "message": "报名成功",
    "activity_id": 5,
    "student_id": "2020123456"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message              | 说明                       |
| ------ | -------------------- | -------------------------- |
| 400    | 活动 ID 必须为数字   | activity_id 类型错误       |
| 400    | 学号错误             | student_id 格式不合法      |
| 400    | 您已报名该活动       | 重复报名                   |
| 400    | 报名人数已满         | 活动达到招募人数上限       |
| 401    | 未登录 / Token 失效  | 未携带 Token 或 Token 无效 |
| 403    | 不能为别人报名活动！ | 普通用户尝试为其他学号报名 |
| 404    | 活动不存在           | activity_id 无效           |
| 500    | 内部服务器错误       | 数据库操作异常等           |

#### 9.13.3 取消活动报名

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **接口地址** | `/api/activity-participants/cancel/:activity_id/:student_id` |
| **请求方法** | `DELETE`                                                     |
| **是否鉴权** | 是                                                           |
| **可用角色** | user / admin / superadmin                                    |
| **功能描述** | 取消活动报名（普通用户仅可取消自己的报名，管理员 / 超管可代取消） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名      | 位置 | 类型   | 必填 | 说明         |
| ----------- | ---- | ------ | ---- | ------------ |
| activity_id | path | int    | 是   | 活动主键 ID  |
| student_id  | path | string | 是   | 报名学生学号 |

**业务逻辑说明**

- 权限校验：
  - 普通用户（user）仅能取消自己的报名
  - 管理员 / 超管可代其他学生取消报名
- 校验该学生是否已报名该活动
- 从数据库中删除报名记录
- 返回取消报名成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "取消报名成功",
  "data": {
    "message": "取消报名成功",
    "activity_id": 5,
    "student_id": "2020123456"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                  | 说明                           |
| ------ | ------------------------ | ------------------------------ |
| 401    | 未登录 / Token 失效      | 未携带 Token 或 Token 无效     |
| 403    | 不能取消别人报名的活动！ | 普通用户尝试取消其他学生的报名 |
| 404    | 您未报名该活动           | 该学生未报名该活动             |
| 500    | 内部服务器错误           | 数据库操作异常等               |

#### 9.13.4 活动签到 / 取消签到（管理员）

| 项目         | 内容                                           |
| ------------ | ---------------------------------------------- |
| **接口地址** | `/api/activity-participants/signin/:record_id` |
| **请求方法** | `PATCH`                                        |
| **是否鉴权** | 是                                             |
| **可用角色** | admin / superadmin                             |
| **功能描述** | 标记活动签到状态（1 = 签到，0 = 取消签到）     |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名    | 位置 | 类型 | 必填 | 说明            |
| --------- | ---- | ---- | ---- | --------------- |
| record_id | path | int  | 是   | 报名记录主键 ID |

**请求体（JSON）**

| 字段名    | 类型   | 必填 | 说明                               |
| --------- | ------ | ---- | ---------------------------------- |
| signed_in | number | 是   | 签到状态（1 = 签到，0 = 取消签到） |

**业务逻辑说明**

- 校验字段格式（`validateActivityParticipantUpdate`）
- 校验报名记录是否存在
- 更新签到状态
- 返回签到状态更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "签到状态更新成功",
  "data": {
    "message": "签到成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 签到状态必须为数字  | signed_in 类型错误           |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 参与记录不存在      | record_id 无效               |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.13.5 单个更新服务时长（管理员）

| 项目         | 内容                                          |
| ------------ | --------------------------------------------- |
| **接口地址** | `/api/activity-participants/hours/:record_id` |
| **请求方法** | `PATCH`                                       |
| **是否鉴权** | 是                                            |
| **可用角色** | admin / superadmin                            |
| **功能描述** | 更新单个志愿者的服务时长                      |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名    | 位置 | 类型 | 必填 | 说明            |
| --------- | ---- | ---- | ---- | --------------- |
| record_id | path | int  | 是   | 报名记录主键 ID |

**请求体（JSON）**

| 字段名        | 类型   | 必填 | 说明                 |
| ------------- | ------ | ---- | -------------------- |
| service_hours | number | 是   | 服务时长（数字类型） |

**业务逻辑说明**

- 校验字段格式（`validateActivityParticipantUpdate`）
- 校验报名记录是否存在
- 更新服务时长
- 返回更新成功提示及更新后的数据

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "服务时长更新成功",
  "data": {
    "message": "服务时长更新成功",
    "record_id": 101,
    "service_hours": 3
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 服务时长必须为数字  | service_hours 类型错误       |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 参与记录不存在      | record_id 无效               |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.13.6 批量更新服务时长（管理员）

| 项目         | 内容                                     |
| ------------ | ---------------------------------------- |
| **接口地址** | `/api/activity-participants/hours/batch` |
| **请求方法** | `PUT`                                    |
| **是否鉴权** | 是                                       |
| **可用角色** | admin / superadmin                       |
| **功能描述** | 批量更新多个志愿者的服务时长             |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

```json
{
  "updates": [
    { "record_id": 101, "service_hours": 3 },
    { "record_id": 102, "service_hours": 2.5 }
  ]
}
```

**字段说明**

| 字段名                  | 类型   | 必填 | 说明                     |
| ----------------------- | ------ | ---- | ------------------------ |
| updates                 | array  | 是   | 批量更新列表（非空数组） |
| updates[].record_id     | number | 是   | 报名记录主键 ID          |
| updates[].service_hours | number | 是   | 服务时长（数字类型）     |

**业务逻辑说明**

- 校验请求体格式（必须为非空数组，`validateBatchActivityParticipantUpdate`）
- 对每条更新记录分别处理：
  1. 校验 record_id 和 service_hours 是否有效
  2. 校验报名记录是否存在
  3. 更新服务时长
  4. 记录成功 / 失败结果
- 批量处理完成后，返回统计信息和详细结果

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量服务时长更新成功",
  "data": {
    "total": 2,
    "success": 1,
    "failed": 1,
    "successList": [
      { "record_id": 101, "service_hours": 3 }
    ],
    "failedList": [
      { "record_id": 102, "reason": "报名记录不存在" }
    ],
    "message": "部分更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                              | 说明                         |
| ------ | ------------------------------------ | ---------------------------- |
| 400    | 请求体必须为非空数组                 | updates 不是非空数组         |
| 400    | 缺少 record_id 或 service_hours 无效 | 单条记录字段缺失或格式错误   |
| 401    | 未登录 / Token 失效                  | 未携带 Token 或 Token 无效   |
| 403    | 权限不足                             | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误                       | 数据库操作异常等             |

#### 9.13.7 获取学生个人报名记录

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **接口地址** | `/api/activity-participants/records/:student_id`             |
| **请求方法** | `GET`                                                        |
| **是否鉴权** | 是                                                           |
| **可用角色** | user / admin / superadmin                                    |
| **功能描述** | 获取指定学生的所有活动报名记录（普通用户仅可查看自己的记录） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名     | 位置 | 类型   | 必填 | 说明     |
| ---------- | ---- | ------ | ---- | -------- |
| student_id | path | string | 是   | 学生学号 |

**业务逻辑说明**

- 权限校验：
  - 普通用户（user）仅能查看自己的报名记录
  - 管理员 / 超管可查看任意学生的报名记录
- 关联查询活动表获取活动详情（名称、时间、地点、类别、状态）
- 关联查询学生信息表获取个人详情（姓名、学院、专业）
- 按活动开始时间倒序排序
- 返回报名总条数和详细记录

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "获取个人报名记录成功",
  "data": {
    "total": 2,
    "data": [
      {
        "record_id": 101,
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "activity_status": "进行中",
        "start_time": "2024-05-18T09:00:00.000Z",
        "end_time": "2024-05-18T12:00:00.000Z",
        "location": "XX社区",
        "category": "环保",
        "student_id": "2020123456",
        "student_name": "张三",
        "college": "计算机学院",
        "major": "软件工程",
        "role": "志愿者",
        "service_hours": 3,
        "signed_in": 1,
        "remark": null,
        "created_at": "2024-05-12T10:00:00.000Z"
      },
      {
        "record_id": 95,
        "activity_id": 4,
        "activity_name": "敬老院关怀活动",
        "activity_status": "已结束",
        "start_time": "2024-05-11T09:00:00.000Z",
        "end_time": "2024-05-11T11:00:00.000Z",
        "location": "XX敬老院",
        "category": "公益",
        "student_id": "2020123456",
        "student_name": "张三",
        "college": "计算机学院",
        "major": "软件工程",
        "role": "志愿者",
        "service_hours": 2,
        "signed_in": 1,
        "remark": null,
        "created_at": "2024-05-06T15:00:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message              | 说明                           |
| ------ | -------------------- | ------------------------------ |
| 401    | 未登录 / Token 失效  | 未携带 Token 或 Token 无效     |
| 403    | 无权查看他人报名记录 | 普通用户尝试查看其他学生的记录 |
| 500    | 内部服务器错误       | 数据库操作异常等               |

#### 9.13.8 获取所有活动参与记录（管理员）

| 项目         | 内容                                               |
| ------------ | -------------------------------------------------- |
| **接口地址** | `/api/activity-participants/all`                   |
| **请求方法** | `GET`                                              |
| **是否鉴权** | 是                                                 |
| **可用角色** | admin / superadmin                                 |
| **功能描述** | 获取系统中所有活动的参与记录（关联活动、学生信息） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**业务逻辑说明**

- 关联查询活动表获取活动详情（ID、名称、时间、地点、类别）
- 关联查询学生信息表获取学生详情（姓名、学院、专业）
- 按活动 ID 升序、报名记录 ID 升序排序
- 返回总记录数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "获取所有活动参与记录成功",
  "data": {
    "total": 3,
    "data": [
      {
        "record_id": 95,
        "activity_id": 4,
        "activity_name": "敬老院关怀活动",
        "start_time": "2024-05-11T09:00:00.000Z",
        "end_time": "2024-05-11T11:00:00.000Z",
        "location": "XX敬老院",
        "category": "公益",
        "student_id": "2020123456",
        "student_name": "张三",
        "college": "计算机学院",
        "major": "软件工程",
        "role": "志愿者",
        "service_hours": 2,
        "signed_in": 1,
        "remark": null,
        "created_at": "2024-05-06T15:00:00.000Z"
      },
      {
        "record_id": 101,
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "start_time": "2024-05-18T09:00:00.000Z",
        "end_time": "2024-05-18T12:00:00.000Z",
        "location": "XX社区",
        "category": "环保",
        "student_id": "2020123456",
        "student_name": "张三",
        "college": "计算机学院",
        "major": "软件工程",
        "role": "志愿者",
        "service_hours": 3,
        "signed_in": 1,
        "remark": null,
        "created_at": "2024-05-12T10:00:00.000Z"
      },
      {
        "record_id": 102,
        "activity_id": 5,
        "activity_name": "社区环保志愿活动",
        "start_time": "2024-05-18T09:00:00.000Z",
        "end_time": "2024-05-18T12:00:00.000Z",
        "location": "XX社区",
        "category": "环保",
        "student_id": "2021123456",
        "student_name": "李四",
        "college": "环境学院",
        "major": "环境工程",
        "role": "志愿者",
        "service_hours": 0,
        "signed_in": 0,
        "remark": "自带工具",
        "created_at": "2024-05-12T10:30:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

### 9.14 荣誉与表彰记录接口

荣誉与表彰记录接口用于维护系统中的学生荣誉信息，包括荣誉记录的创建、更新、查询、删除及批量创建等操作，支持按届次分组展示荣誉墙，关联学生和届次信息。

#### 9.14.1 创建荣誉记录（管理员）

| 项目         | 内容                        |
| ------------ | --------------------------- |
| **接口地址** | `/api/honor-records/create` |
| **请求方法** | `POST`                      |
| **是否鉴权** | 是                          |
| **可用角色** | admin / superadmin          |
| **功能描述** | 创建一条学生荣誉记录        |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名          | 类型   | 必填 | 说明                               |
| --------------- | ------ | ---- | ---------------------------------- |
| honor_title     | string | 是   | 荣誉名称                           |
| student_id      | string | 否   | 获奖学生学号（格式校验）           |
| term_id         | number | 否   | 届次 ID                            |
| honor_level     | string | 否   | 荣誉等级（如：国家级、省级、校级） |
| issue_date      | date   | 否   | 颁发日期                           |
| issuer          | string | 否   | 颁发单位                           |
| description     | string | 否   | 荣誉描述                           |
| certificate_url | string | 否   | 证书图片 URL                       |
| certificate_key | string | 否   | 证书图片 OSS 存储 key              |

**业务逻辑说明**

- 校验字段格式（`validateHonorCreate`）
- 校验荣誉名称不能为空
- 自动构建 SQL 字段，仅插入请求体中出现的字段
- 创建成功后返回完整荣誉记录信息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "荣誉记录创建成功",
  "data": {
    "honor_id": 8,
    "honor_title": "优秀志愿者标兵",
    "student_id": "2020123456",
    "term_id": 2,
    "honor_level": "校级",
    "issue_date": "2024-06-30",
    "issuer": "学校志愿者协会",
    "description": "年度志愿服务时长TOP10，表现突出",
    "certificate_url": "https://example.com/certificates/xxx.jpg",
    "certificate_key": "honors/2020123456.jpg"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 荣誉名称不能为空    | honor_title 缺失             |
| 400    | 学号错误            | student_id 格式不合法        |
| 400    | 届次 ID 必须为数字  | term_id 类型错误             |
| 400    | 颁发日期格式错误    | issue_date 格式不合法        |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.14.2 获取所有荣誉记录

| 项目         | 内容                                   |
| ------------ | -------------------------------------- |
| **接口地址** | `/api/public/honor-records/list`       |
| **请求方法** | `GET`                                  |
| **是否鉴权** | 否（公开接口）                         |
| **可用角色** | 所有人                                 |
| **功能描述** | 获取所有荣誉记录（关联学生、届次信息） |

**业务逻辑说明**

- 关联查询学生信息表（auth_info）获取学生姓名
- 关联查询届次表（team_terms）获取届次名称和当前届标识
- 排序规则：按颁发日期倒序 → 荣誉等级升序

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询所有荣誉记录成功",
  "data": {
    "total": 2,
    "data": [
      {
        "honor_id": 8,
        "honor_title": "优秀志愿者标兵",
        "student_id": "2020123456",
        "student_name": "张三",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "honor_level": "校级",
        "issue_date": "2024-06-30",
        "issuer": "学校志愿者协会",
        "description": "年度志愿服务时长TOP10，表现突出",
        "certificate_url": "https://example.com/certificates/xxx.jpg",
        "certificate_key": "honors/2020123456.jpg"
      },
      {
        "honor_id": 7,
        "honor_title": "志愿服务先进个人",
        "student_id": "2021123456",
        "student_name": "李四",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "honor_level": "院级",
        "issue_date": "2024-06-25",
        "issuer": "计算机学院",
        "description": "积极参与各类志愿服务活动",
        "certificate_url": null,
        "certificate_key": null
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.14.3 获取历届荣誉墙

| 项目         | 内容                                                    |
| ------------ | ------------------------------------------------------- |
| **接口地址** | `/api/public/honor-records/wall`                        |
| **请求方法** | `GET`                                                   |
| **是否鉴权** | 否（公开接口）                                          |
| **可用角色** | 所有人                                                  |
| **功能描述** | 按届次分组展示荣誉记录（届次→荣誉列表结构，供门户展示） |

**业务逻辑说明**

- 关联查询届次表、荣誉记录表和学生信息表
- 按届次开始时间倒序、荣誉颁发日期倒序排序
- 构建树状结构：届次列表 → 该届次下的荣誉记录列表
- 每个荣誉记录包含学生姓名、荣誉详情等核心信息

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询荣誉墙成功",
  "data": [
    {
      "term_id": 2,
      "term_name": "2023-2024届",
      "is_current": true,
      "honors": [
        {
          "honor_id": 8,
          "honor_title": "优秀志愿者标兵",
          "honor_level": "校级",
          "issue_date": "2024-06-30",
          "issuer": "学校志愿者协会",
          "description": "年度志愿服务时长TOP10，表现突出",
          "student_id": "2020123456",
          "student_name": "张三"
        },
        {
          "honor_id": 7,
          "honor_title": "志愿服务先进个人",
          "honor_level": "院级",
          "issue_date": "2024-06-25",
          "issuer": "计算机学院",
          "description": "积极参与各类志愿服务活动",
          "student_id": "2021123456",
          "student_name": "李四"
        }
      ]
    },
    {
      "term_id": 1,
      "term_name": "2022-2023届",
      "is_current": false,
      "honors": [
        {
          "honor_id": 5,
          "honor_title": "优秀志愿者",
          "honor_level": "校级",
          "issue_date": "2023-06-28",
          "issuer": "学校志愿者协会",
          "description": "志愿服务表现优秀",
          "student_id": "2019123456",
          "student_name": "王五"
        }
      ]
    }
  ],
  "meta": {},
  "debug": {}
}
```

#### 9.14.4 更新荣誉记录（管理员）

| 项目         | 内容                                  |
| ------------ | ------------------------------------- |
| **接口地址** | `/api/honor-records/update/:honor_id` |
| **请求方法** | `PUT`                                 |
| **是否鉴权** | 是                                    |
| **可用角色** | admin / superadmin                    |
| **功能描述** | 更新荣誉记录信息                      |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名   | 位置 | 类型 | 必填 | 说明            |
| -------- | ---- | ---- | ---- | --------------- |
| honor_id | path | int  | 是   | 荣誉记录主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名          | 类型   | 说明                               |
| --------------- | ------ | ---------------------------------- |
| honor_title     | string | 荣誉名称                           |
| student_id      | string | 获奖学生学号（格式校验）           |
| term_id         | number | 届次 ID                            |
| honor_level     | string | 荣誉等级（如：国家级、省级、校级） |
| issue_date      | date   | 颁发日期                           |
| issuer          | string | 颁发单位                           |
| description     | string | 荣誉描述                           |
| certificate_url | string | 证书图片 URL                       |
| certificate_key | string | 证书图片 OSS 存储 key              |

**业务逻辑说明**

- 校验字段格式（`validateHonorUpdate`）
- 检查荣誉记录是否存在
- 自动构建 SQL，仅更新请求体中出现的字段
- 返回更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "荣誉记录更新成功",
  "data": {
    "message": "荣誉记录更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 400    | 没有可更新的字段    | 请求体为空                   |
| 400    | 学号错误            | student_id 格式不合法        |
| 400    | 颁发日期格式错误    | issue_date 格式不合法        |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 荣誉记录不存在      | honor_id 无效                |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.14.5 删除荣誉记录（管理员）

| 项目         | 内容                                  |
| ------------ | ------------------------------------- |
| **接口地址** | `/api/honor-records/delete/:honor_id` |
| **请求方法** | `DELETE`                              |
| **是否鉴权** | 是                                    |
| **可用角色** | admin / superadmin                    |
| **功能描述** | 删除指定的荣誉记录                    |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名   | 位置 | 类型 | 必填 | 说明            |
| -------- | ---- | ---- | ---- | --------------- |
| honor_id | path | int  | 是   | 荣誉记录主键 ID |

**业务逻辑说明**

- 检查荣誉记录是否存在
- 从数据库中删除荣誉记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "荣誉记录删除成功",
  "data": {
    "message": "荣誉记录删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 荣誉记录不存在      | honor_id 无效或已删除        |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.14.6 批量创建荣誉记录（管理员）

| 项目         | 内容                                      |
| ------------ | ----------------------------------------- |
| **接口地址** | `/api/honor-records/batch-create`         |
| **请求方法** | `POST`                                    |
| **是否鉴权** | 是                                        |
| **可用角色** | admin / superadmin                        |
| **功能描述** | 批量创建多条荣誉记录，返回创建 / 失败详情 |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

```json
[
  {
    "honor_title": "优秀志愿者标兵",
    "student_id": "2020123456",
    "term_id": 2,
    "honor_level": "校级",
    "issue_date": "2024-06-30",
    "issuer": "学校志愿者协会"
  },
  {
    "honor_title": "志愿服务先进个人",
    "student_id": "2021123456",
    "term_id": 2,
    "honor_level": "院级"
  }
]
```

**字段说明**

| 字段名          | 类型   | 必填 | 说明                               |
| --------------- | ------ | ---- | ---------------------------------- |
| honor_title     | string | 是   | 荣誉名称                           |
| student_id      | string | 否   | 获奖学生学号（格式校验）           |
| term_id         | number | 否   | 届次 ID                            |
| honor_level     | string | 否   | 荣誉等级（如：国家级、省级、校级） |
| issue_date      | date   | 否   | 颁发日期                           |
| issuer          | string | 否   | 颁发单位                           |
| description     | string | 否   | 荣誉描述                           |
| certificate_url | string | 否   | 证书图片 URL                       |
| certificate_key | string | 否   | 证书图片 OSS 存储 key              |

**业务逻辑说明**

- 校验请求体格式（必须为非空数组，`validateBatchHonorCreate`）
- 对每条记录分别处理：
  1. 校验荣誉名称是否存在（必填）
  2. 校验字段格式（如学号、日期等）
  3. 校验通过则创建荣誉记录
  4. 校验失败则记录失败原因
- 批量处理完成后，返回统计信息和详细结果

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "批量创建荣誉记录成功",
  "data": {
    "total": 3,
    "created": 2,
    "failed": 1,
    "createdList": [
      {
        "honor_id": 9,
        "honor_title": "优秀志愿者标兵",
        "student_id": "2020123456",
        "term_id": 2,
        "honor_level": "校级",
        "issue_date": "2024-06-30",
        "issuer": "学校志愿者协会"
      },
      {
        "honor_id": 10,
        "honor_title": "志愿服务先进个人",
        "student_id": "2021123456",
        "term_id": 2,
        "honor_level": "院级"
      }
    ],
    "failedList": [
      {
        "honor_title": null,
        "reason": "缺少必要字段 honor_title"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

### 9.15 公告与通知接口

公告与通知接口用于管理系统中的公告信息，支持公告的创建、更新、删除及查询操作，支持 Word 文档转 HTML 内容、OSS 附件存储与替换，区分后台管理和门户展示场景。

#### 9.15.1 创建公告（管理员）

| 项目         | 内容                                                      |
| ------------ | --------------------------------------------------------- |
| **接口地址** | `/api/announcements/create`                               |
| **请求方法** | `POST`                                                    |
| **是否鉴权** | 是                                                        |
| **可用角色** | admin / superadmin                                        |
| **功能描述** | 创建公告（支持 Word 文档转 HTML 内容，自动存储 OSS 附件） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名       | 类型   | 必填 | 说明                                           |
| ------------ | ------ | ---- | ---------------------------------------------- |
| title        | string | 是   | 公告标题                                       |
| content      | string | 是   | 公告内容（Word 附件上传时可留空，自动转换）    |
| author_id    | string | 否   | 作者 ID                                        |
| term_id      | number | 否   | 届次 ID                                        |
| publish_time | date   | 否   | 发布时间（默认空）                             |
| status       | string | 否   | 状态（可选值：草稿、已发布、归档，默认草稿）   |
| file_url     | string | 否   | 附件 URL（仅文件类型非 none 时有效）           |
| file_key     | string | 否   | 附件 OSS 存储 key（仅文件类型非 none 时有效）  |
| file_type    | string | 否   | 附件类型（可选值：none、pdf、word，默认 none） |

**业务逻辑说明**

- 校验字段格式（`validateAnnouncementCreate`）
- 校验必填字段（title、content 不能为空，Word 附件上传时 content 可留空）
- 若附件类型为 word 且存在 file_key：
  1. 从 OSS 下载 Word 文件到本地
  2. 转换 Word 内容为 HTML 格式
  3. 删除本地临时文件
  4. 用转换后的 HTML 替换 content 字段
- 自动填充默认值：status = 草稿、file_type=none
- 自动构建 SQL 字段，仅插入请求体中出现的字段
- 创建成功后返回公告 ID

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "公告创建成功",
  "data": {
    "message": "公告创建成功",
    "announcement_id": 15
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                                       |
| ------ | ------------------- | ------------------------------------------ |
| 400    | 标题不能为空        | title 缺失                                 |
| 400    | 内容不能为空        | content 缺失且未上传 Word 附件             |
| 400    | 状态不合法          | status 不在枚举范围内                      |
| 400    | 文件类型不合法      | file_type 不在枚举范围内                   |
| 400    | 发布时间格式错误    | publish_time 格式不合法                    |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效                 |
| 403    | 权限不足            | 非 admin/superadmin 角色访问               |
| 500    | 内部服务器错误      | 数据库操作、OSS 文件下载或 Word 转换异常等 |

#### 9.15.2 获取已发布公告

| 项目         | 内容                                         |
| ------------ | -------------------------------------------- |
| **接口地址** | `/api/public/announcements/published`        |
| **请求方法** | `GET`                                        |
| **是否鉴权** | 否（公开接口）                               |
| **可用角色** | 所有人                                       |
| **功能描述** | 获取所有状态为 “已发布” 的公告（供门户展示） |

**业务逻辑说明**

- 关联查询届次表（team_terms）获取届次名称
- 仅筛选状态为 “已发布” 的公告
- 按发布时间倒序排序
- 返回公告总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询已发布公告成功",
  "data": {
    "total": 2,
    "data": [
      {
        "announcement_id": 15,
        "title": "2024年暑期志愿服务招募通知",
        "content": "<p>为丰富同学们的暑期生活，现启动2024年暑期志愿服务招募工作...</p>",
        "author_id": "2020123456",
        "term_id": 2,
        "term_name": "2023-2024届",
        "publish_time": "2024-06-10T09:00:00.000Z",
        "status": "已发布",
        "file_url": "https://example.com/files/recruitment.pdf",
        "file_key": "announcements/recruitment.pdf",
        "file_type": "pdf",
        "created_at": "2024-06-09T16:30:00.000Z"
      },
      {
        "announcement_id": 14,
        "title": "2023-2024学年优秀志愿者表彰决定",
        "content": "<p>根据志愿服务时长及表现，经评定，授予以下同学“优秀志愿者”称号...</p>",
        "author_id": "2020123456",
        "term_id": 2,
        "term_name": "2023-2024届",
        "publish_time": "2024-06-01T10:00:00.000Z",
        "status": "已发布",
        "file_url": null,
        "file_key": null,
        "file_type": "none",
        "created_at": "2024-05-30T14:20:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.15.3 获取所有公告（管理员）

| 项目         | 内容                                           |
| ------------ | ---------------------------------------------- |
| **接口地址** | `/api/announcements/list`                      |
| **请求方法** | `GET`                                          |
| **是否鉴权** | 是                                             |
| **可用角色** | admin / superadmin                             |
| **功能描述** | 获取所有状态的公告（含草稿、归档，供后台管理） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**业务逻辑说明**

- 关联查询届次表（team_terms）获取届次名称和当前届标识
- 包含所有状态（草稿、已发布、归档）的公告
- 按发布时间倒序排序
- 返回公告总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "查询公告成功",
  "data": {
    "total": 3,
    "data": [
      {
        "announcement_id": 15,
        "title": "2024年暑期志愿服务招募通知",
        "content": "<p>为丰富同学们的暑期生活，现启动2024年暑期志愿服务招募工作...</p>",
        "author_id": "2020123456",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "publish_time": "2024-06-10T09:00:00.000Z",
        "status": "已发布",
        "file_url": "https://example.com/files/recruitment.pdf",
        "file_key": "announcements/recruitment.pdf",
        "file_type": "pdf",
        "created_at": "2024-06-09T16:30:00.000Z"
      },
      {
        "announcement_id": 14,
        "title": "2023-2024学年优秀志愿者表彰决定",
        "content": "<p>根据志愿服务时长及表现，经评定，授予以下同学“优秀志愿者”称号...</p>",
        "author_id": "2020123456",
        "term_id": 2,
        "term_name": "2023-2024届",
        "is_current": true,
        "publish_time": "2024-06-01T10:00:00.000Z",
        "status": "已发布",
        "file_url": null,
        "file_key": null,
        "file_type": "none",
        "created_at": "2024-05-30T14:20:00.000Z"
      },
      {
        "announcement_id": 13,
        "title": "2024年秋季学期工作计划",
        "content": "<p>一、工作目标...二、主要任务...</p>",
        "author_id": "2020123456",
        "term_id": 3,
        "term_name": "2024-2025届",
        "is_current": false,
        "publish_time": null,
        "status": "草稿",
        "file_url": null,
        "file_key": null,
        "file_type": "none",
        "created_at": "2024-06-15T11:00:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.15.4 更新公告（管理员）

| 项目         | 内容                                                |
| ------------ | --------------------------------------------------- |
| **接口地址** | `/api/announcements/update/:announcement_id`        |
| **请求方法** | `PUT`                                               |
| **是否鉴权** | 是                                                  |
| **可用角色** | admin / superadmin                                  |
| **功能描述** | 更新公告信息（支持 OSS 附件替换、Word 重新转 HTML） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名          | 位置 | 类型 | 必填 | 说明        |
| --------------- | ---- | ---- | ---- | ----------- |
| announcement_id | path | int  | 是   | 公告主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名       | 类型   | 说明                                            |
| ------------ | ------ | ----------------------------------------------- |
| title        | string | 公告标题                                        |
| content      | string | 公告内容（Word 附件更新时可留空）               |
| author_id    | string | 作者 ID                                         |
| term_id      | number | 届次 ID                                         |
| publish_time | date   | 发布时间                                        |
| status       | string | 状态（可选值：草稿、已发布、归档）              |
| file_url     | string | 新附件 URL（仅文件类型非 none 时有效）          |
| file_key     | string | 新附件 OSS 存储 key（仅文件类型非 none 时有效） |
| file_type    | string | 新附件类型（可选值：none、pdf、word）           |

**业务逻辑说明**

- 校验字段格式（`validateAnnouncementUpdate`）
- 检查公告是否存在
- 若更新附件（file_key 变更）：
  1. 删除 OSS 中存储的旧附件文件
  2. 若新附件类型为 word：
     - 从 OSS 下载新 Word 文件到本地
     - 转换为 HTML 格式并更新 content 字段
     - 删除本地临时文件
  3. 更新 file_url、file_key、file_type 字段
- 自动构建 SQL，更新请求体中出现的其他字段
- 返回更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "公告更新成功",
  "data": {
    "message": "公告更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                                       |
| ------ | ------------------- | ------------------------------------------ |
| 400    | 没有可更新的字段    | 请求体为空                                 |
| 400    | 状态不合法          | status 不在枚举范围内                      |
| 400    | 文件类型不合法      | file_type 不在枚举范围内                   |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效                 |
| 403    | 权限不足            | 非 admin/superadmin 角色访问               |
| 404    | 公告不存在          | announcement_id 无效                       |
| 500    | 内部服务器错误      | 数据库操作、OSS 文件操作或 Word 转换异常等 |

#### 9.15.5 删除公告（管理员）

| 项目         | 内容                                         |
| ------------ | -------------------------------------------- |
| **接口地址** | `/api/announcements/delete/:announcement_id` |
| **请求方法** | `DELETE`                                     |
| **是否鉴权** | 是                                           |
| **可用角色** | admin / superadmin                           |
| **功能描述** | 删除指定公告（连带删除 OSS 附件）            |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名          | 位置 | 类型 | 必填 | 说明        |
| --------------- | ---- | ---- | ---- | ----------- |
| announcement_id | path | int  | 是   | 公告主键 ID |

**业务逻辑说明**

- 检查公告是否存在
- 若公告存在附件（file_key 非空）：
  - 从 OSS 中删除对应的附件文件
- 从数据库中删除公告记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "公告删除成功",
  "data": {
    "message": "公告删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                            |
| ------ | ------------------- | ------------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效      |
| 403    | 权限不足            | 非 admin/superadmin 角色访问    |
| 404    | 公告不存在          | announcement_id 无效            |
| 500    | 内部服务器错误      | 数据库操作或 OSS 文件删除异常等 |

### 9.16 团队相册/风采展示管理接口

团队相册 / 风采展示管理接口用于维护系统中的照片资源，支持照片的上传、更新、删除及按届次 / 活动筛选查询，照片文件存储于 OSS，区分后台管理和门户展示场景。

#### 9.16.1 上传照片（管理员）

| 项目         | 内容                                                    |
| ------------ | ------------------------------------------------------- |
| **接口地址** | `/api/gallery-photos/create`                            |
| **请求方法** | `POST`                                                  |
| **是否鉴权** | 是                                                      |
| **可用角色** | admin / superadmin                                      |
| **功能描述** | 上传照片到团队相册（OSS 存储，必填图片 URL 和存储 key） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名      | 类型   | 必填 | 说明                                           |
| ----------- | ------ | ---- | ---------------------------------------------- |
| image_url   | string | 是   | 图片 URL（OSS 访问地址）                       |
| image_key   | string | 是   | 图片 OSS 存储 key（唯一标识）                  |
| term_id     | number | 否   | 届次 ID（关联对应届次）                        |
| activity_id | number | 否   | 活动 ID（关联对应活动）                        |
| title       | string | 否   | 照片标题                                       |
| description | string | 否   | 照片描述                                       |
| uploaded_by | string | 否   | 上传人（自动填充当前登录用户学号，无需手动传） |
| sort_order  | number | 否   | 排序序号（数字越小越靠前）                     |

**业务逻辑说明**

- 校验字段格式（`validateGalleryPhotoCreate`）
- 校验必填字段（image_url 和 image_key 不能为空）
- 自动填充上传人（uploaded_by = 当前登录用户学号）
- 自动构建 SQL 字段，插入所有可写字段（未提供则为 null）
- 上传成功后返回照片 ID

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "照片上传成功",
  "data": {
    "message": "照片上传成功",
    "photo_id": 25
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                         | 说明                         |
| ------ | ------------------------------- | ---------------------------- |
| 400    | image_url 和 image_key 不能为空 | 缺少必填字段                 |
| 400    | 图片 URL 不能为空               | image_url 缺失               |
| 400    | 图片 key 不能为空               | image_key 缺失               |
| 400    | 届次 ID 必须为数字              | term_id 类型错误             |
| 401    | 未登录 / Token 失效             | 未携带 Token 或 Token 无效   |
| 403    | 权限不足                        | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误                  | 数据库操作或 OSS 存储异常等  |

#### 9.16.2 按届次筛选照片

| 项目         | 内容                                       |
| ------------ | ------------------------------------------ |
| **接口地址** | `/api/public/gallery-photos/term/:term_id` |
| **请求方法** | `GET`                                      |
| **是否鉴权** | 否（公开接口）                             |
| **可用角色** | 所有人                                     |
| **功能描述** | 获取指定届次下的所有照片（供门户展示）     |

**参数说明**

| 参数名  | 位置 | 类型 | 必填 | 说明        |
| ------- | ---- | ---- | ---- | ----------- |
| term_id | path | int  | 是   | 届次主键 ID |

**业务逻辑说明**

- 按届次 ID 筛选照片
- 按上传时间倒序排序（最新上传在前）
- 返回照片总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 3,
    "data": [
      {
        "photo_id": 25,
        "term_id": 2,
        "activity_id": 5,
        "title": "社区环保活动合影",
        "image_url": "https://example.com/gallery/20240618-01.jpg",
        "image_key": "gallery/20240618-01.jpg",
        "description": "2024年6月18日社区环保志愿活动全体合影",
        "uploaded_by": "2020123456",
        "sort_order": 1,
        "uploaded_at": "2024-06-18T14:30:00.000Z"
      },
      {
        "photo_id": 24,
        "term_id": 2,
        "activity_id": 4,
        "title": "敬老院关怀活动",
        "image_url": "https://example.com/gallery/20240511-02.jpg",
        "image_key": "gallery/20240511-02.jpg",
        "description": "志愿者与老人互动瞬间",
        "uploaded_by": "2020123456",
        "sort_order": 2,
        "uploaded_at": "2024-05-11T16:00:00.000Z"
      },
      {
        "photo_id": 23,
        "term_id": 2,
        "activity_id": null,
        "title": "团队培训",
        "image_url": "https://example.com/gallery/20240420-01.jpg",
        "image_key": "gallery/20240420-01.jpg",
        "description": "2023-2024届志愿者培训现场",
        "uploaded_by": "2020123456",
        "sort_order": 3,
        "uploaded_at": "2024-04-20T10:15:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.16.3 按活动筛选照片

| 项目         | 内容                                               |
| ------------ | -------------------------------------------------- |
| **接口地址** | `/api/public/gallery-photos/activity/:activity_id` |
| **请求方法** | `GET`                                              |
| **是否鉴权** | 否（公开接口）                                     |
| **可用角色** | 所有人                                             |
| **功能描述** | 获取指定活动下的所有照片（供门户展示）             |

**参数说明**

| 参数名      | 位置 | 类型 | 必填 | 说明        |
| ----------- | ---- | ---- | ---- | ----------- |
| activity_id | path | int  | 是   | 活动主键 ID |

**业务逻辑说明**

- 按活动 ID 筛选照片
- 按上传时间倒序排序（最新上传在前）
- 返回照片总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 2,
    "data": [
      {
        "photo_id": 25,
        "term_id": 2,
        "activity_id": 5,
        "title": "社区环保活动合影",
        "image_url": "https://example.com/gallery/20240618-01.jpg",
        "image_key": "gallery/20240618-01.jpg",
        "description": "2024年6月18日社区环保志愿活动全体合影",
        "uploaded_by": "2020123456",
        "sort_order": 1,
        "uploaded_at": "2024-06-18T14:30:00.000Z"
      },
      {
        "photo_id": 26,
        "term_id": 2,
        "activity_id": 5,
        "title": "垃圾分拣现场",
        "image_url": "https://example.com/gallery/20240618-02.jpg",
        "image_key": "gallery/20240618-02.jpg",
        "description": "志愿者进行垃圾分类分拣",
        "uploaded_by": "2020123456",
        "sort_order": 2,
        "uploaded_at": "2024-06-18T14:35:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.16.4 获取所有照片（管理员）

| 项目         | 内容                                           |
| ------------ | ---------------------------------------------- |
| **接口地址** | `/api/gallery-photos/list`                     |
| **请求方法** | `GET`                                          |
| **是否鉴权** | 是                                             |
| **可用角色** | admin / superadmin                             |
| **功能描述** | 获取系统中所有照片（关联届次信息，供后台管理） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**业务逻辑说明**

- 关联查询届次表（team_terms）获取届次名称
- 包含所有状态的照片（无筛选条件）
- 按上传时间倒序排序（最新上传在前）
- 返回照片总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 3,
    "data": [
      {
        "photo_id": 26,
        "term_id": 2,
        "term_name": "2023-2024届",
        "activity_id": 5,
        "title": "垃圾分拣现场",
        "image_url": "https://example.com/gallery/20240618-02.jpg",
        "image_key": "gallery/20240618-02.jpg",
        "description": "志愿者进行垃圾分类分拣",
        "uploaded_by": "2020123456",
        "sort_order": 2,
        "uploaded_at": "2024-06-18T14:35:00.000Z"
      },
      {
        "photo_id": 25,
        "term_id": 2,
        "term_name": "2023-2024届",
        "activity_id": 5,
        "title": "社区环保活动合影",
        "image_url": "https://example.com/gallery/20240618-01.jpg",
        "image_key": "gallery/20240618-01.jpg",
        "description": "2024年6月18日社区环保志愿活动全体合影",
        "uploaded_by": "2020123456",
        "sort_order": 1,
        "uploaded_at": "2024-06-18T14:30:00.000Z"
      },
      {
        "photo_id": 24,
        "term_id": 2,
        "term_name": "2023-2024届",
        "activity_id": 4,
        "title": "敬老院关怀活动",
        "image_url": "https://example.com/gallery/20240511-02.jpg",
        "image_key": "gallery/20240511-02.jpg",
        "description": "志愿者与老人互动瞬间",
        "uploaded_by": "2020123456",
        "sort_order": 2,
        "uploaded_at": "2024-05-11T16:00:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.16.5 更新照片信息（管理员）

| 项目         | 内容                                            |
| ------------ | ----------------------------------------------- |
| **接口地址** | `/api/gallery-photos/update/:photo_id`          |
| **请求方法** | `PUT`                                           |
| **是否鉴权** | 是                                              |
| **可用角色** | admin / superadmin                              |
| **功能描述** | 更新照片信息（支持 OSS 图片替换，自动删除旧图） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名   | 位置 | 类型 | 必填 | 说明        |
| -------- | ---- | ---- | ---- | ----------- |
| photo_id | path | int  | 是   | 照片主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名      | 类型   | 说明                                             |
| ----------- | ------ | ------------------------------------------------ |
| term_id     | number | 届次 ID                                          |
| activity_id | number | 活动 ID                                          |
| title       | string | 照片标题                                         |
| description | string | 照片描述                                         |
| image_url   | string | 新图片 URL（替换图片时必填）                     |
| image_key   | string | 新图片 OSS 存储 key（替换图片时必填）            |
| uploaded_by | string | 上传人（替换图片时自动填充当前用户，无需手动传） |
| sort_order  | number | 排序序号                                         |

**业务逻辑说明**

- 校验字段格式（`validateGalleryPhotoUpdate`）
- 检查照片是否存在
- 若替换图片（提供新的 image_key）：
  1. 校验必须同时提供新的 image_url
  2. 自动删除 OSS 中存储的旧图片文件
  3. 自动填充上传人为当前登录用户学号
  4. 更新 image_url、image_key、uploaded_by 字段
- 自动构建 SQL，更新请求体中出现的其他字段
- 返回更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "照片更新成功",
  "data": {
    "message": "照片更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                                       | 说明                              |
| ------ | --------------------------------------------- | --------------------------------- |
| 400    | 没有可更新字段                                | 请求体为空                        |
| 400    | 修改图片时必须同时提供 image_url 和 image_key | 仅提供 image_key 未提供 image_url |
| 401    | 未登录 / Token 失效                           | 未携带 Token 或 Token 无效        |
| 403    | 权限不足                                      | 非 admin/superadmin 角色访问      |
| 404    | 照片不存在                                    | photo_id 无效                     |
| 500    | 内部服务器错误                                | 数据库操作或 OSS 文件删除异常等   |

#### 9.16.6 删除照片（管理员）

| 项目         | 内容                                      |
| ------------ | ----------------------------------------- |
| **接口地址** | `/api/gallery-photos/delete/:photo_id`    |
| **请求方法** | `DELETE`                                  |
| **是否鉴权** | 是                                        |
| **可用角色** | admin / superadmin                        |
| **功能描述** | 删除指定照片（连带删除 OSS 中的图片文件） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名   | 位置 | 类型 | 必填 | 说明        |
| -------- | ---- | ---- | ---- | ----------- |
| photo_id | path | int  | 是   | 照片主键 ID |

**业务逻辑说明**

- 检查照片是否存在
- 从 OSS 中删除对应的图片文件（根据 image_key）
- 从数据库中删除照片记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "照片删除成功",
  "data": {
    "message": "照片删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                            |
| ------ | ------------------- | ------------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效      |
| 403    | 权限不足            | 非 admin/superadmin 角色访问    |
| 404    | 照片不存在          | photo_id 无效                   |
| 500    | 内部服务器错误      | 数据库操作或 OSS 文件删除异常等 |

### 9.17 服务队发展历程管理接口

服务队发展历程管理接口用于维护服务队的重要里程碑事件，支持里程碑的创建、更新、删除及多维度筛选查询，图片文件存储于 OSS，区分后台管理和门户展示场景。

#### 9.17.1 创建里程碑事件（管理员）

| 项目         | 内容                                                     |
| ------------ | -------------------------------------------------------- |
| **接口地址** | `/api/team-milestones/create`                            |
| **请求方法** | `POST`                                                   |
| **是否鉴权** | 是                                                       |
| **可用角色** | admin / superadmin                                       |
| **功能描述** | 创建服务队里程碑事件（必填标题和事件日期，支持图片上传） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体（JSON）**

| 字段名      | 类型   | 必填 | 说明                                           |
| ----------- | ------ | ---- | ---------------------------------------------- |
| title       | string | 是   | 里程碑标题                                     |
| event_date  | date   | 是   | 事件日期（格式校验）                           |
| term_id     | number | 否   | 届次 ID（关联对应届次）                        |
| description | string | 否   | 事件描述                                       |
| event_type  | string | 否   | 事件类型（如：成立、获奖、重大活动等）         |
| image_url   | string | 否   | 图片 URL（OSS 访问地址，需配合 image_key）     |
| image_key   | string | 否   | 图片 OSS 存储 key（上传图片时必填）            |
| created_by  | string | 否   | 创建人（自动填充当前登录用户学号，无需手动传） |

**业务逻辑说明**

- 校验字段格式（`validateTeamMilestoneCreate`）
- 校验必填字段（title 和 event_date 不能为空）
- 图片上传校验：若提供 image_url 则必须同时提供 image_key
- 自动填充创建人（created_by = 当前登录用户学号）
- 自动构建 SQL 字段，插入所有可写字段（未提供则为 null）
- 创建成功后返回里程碑 ID

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "里程碑创建成功",
  "data": {
    "message": "里程碑创建成功",
    "milestone_id": 12
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                      | 说明                              |
| ------ | ---------------------------- | --------------------------------- |
| 400    | title 和 event_date 不能为空 | 缺少必填字段                      |
| 400    | 标题不能为空                 | title 缺失                        |
| 400    | 事件日期格式错误             | event_date 格式不合法             |
| 400    | 上传图片时必须提供 image_key | 仅提供 image_url 未提供 image_key |
| 400    | 届次 ID 必须为数字           | term_id 类型错误                  |
| 401    | 未登录 / Token 失效          | 未携带 Token 或 Token 无效        |
| 403    | 权限不足                     | 非 admin/superadmin 角色访问      |
| 500    | 内部服务器错误               | 数据库操作或 OSS 存储异常等       |

#### 9.17.2 按届次筛选里程碑

| 项目         | 内容                                         |
| ------------ | -------------------------------------------- |
| **接口地址** | `/api/public/team-milestones/term/:term_id`  |
| **请求方法** | `GET`                                        |
| **是否鉴权** | 否（公开接口）                               |
| **可用角色** | 所有人                                       |
| **功能描述** | 获取指定届次下的所有里程碑事件（供门户展示） |

**参数说明**

| 参数名  | 位置 | 类型 | 必填 | 说明        |
| ------- | ---- | ---- | ---- | ----------- |
| term_id | path | int  | 是   | 届次主键 ID |

**业务逻辑说明**

- 按届次 ID 筛选里程碑
- 按事件日期正序排序（时间线顺序）
- 返回里程碑总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 2,
    "data": [
      {
        "milestone_id": 11,
        "term_id": 2,
        "title": "服务队正式成立",
        "description": "2023年9月，XX志愿者服务队正式注册成立",
        "event_date": "2023-09-01",
        "event_type": "成立",
        "image_url": "https://example.com/milestones/establish.jpg",
        "image_key": "milestones/establish.jpg",
        "created_by": "2020123456",
        "created_at": "2024-01-10T15:30:00.000Z"
      },
      {
        "milestone_id": 12,
        "term_id": 2,
        "title": "首次获得校级表彰",
        "description": "在2024年志愿服务评选中获得“优秀志愿团队”称号",
        "event_date": "2024-06-30",
        "event_type": "获奖",
        "image_url": "https://example.com/milestones/award.jpg",
        "image_key": "milestones/award.jpg",
        "created_by": "2020123456",
        "created_at": "2024-07-05T10:15:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.17.3 按事件类型筛选里程碑

| 项目         | 内容                                           |
| ------------ | ---------------------------------------------- |
| **接口地址** | `/api/public/team-milestones/type/:event_type` |
| **请求方法** | `GET`                                          |
| **是否鉴权** | 否（公开接口）                                 |
| **可用角色** | 所有人                                         |
| **功能描述** | 获取指定类型的所有里程碑事件（供门户展示）     |

**参数说明**

| 参数名     | 位置 | 类型   | 必填 | 说明                                 |
| ---------- | ---- | ------ | ---- | ------------------------------------ |
| event_type | path | string | 是   | 事件类型（如：成立、获奖、重大活动） |

**业务逻辑说明**

- 按事件类型精确匹配筛选里程碑
- 按事件日期正序排序（时间线顺序）
- 返回里程碑总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 2,
    "data": [
      {
        "milestone_id": 11,
        "term_id": 2,
        "title": "服务队正式成立",
        "description": "2023年9月，XX志愿者服务队正式注册成立",
        "event_date": "2023-09-01",
        "event_type": "成立",
        "image_url": "https://example.com/milestones/establish.jpg",
        "image_key": "milestones/establish.jpg",
        "created_by": "2020123456",
        "created_at": "2024-01-10T15:30:00.000Z"
      },
      {
        "milestone_id": 8,
        "term_id": 1,
        "title": "前身社团成立",
        "description": "2022年3月，XX志愿社团成立（服务队前身）",
        "event_date": "2022-03-15",
        "event_type": "成立",
        "image_url": null,
        "image_key": null,
        "created_by": "2019123456",
        "created_at": "2023-01-20T14:00:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

#### 9.17.4 按时间范围筛选里程碑

| 项目         | 内容                                             |
| ------------ | ------------------------------------------------ |
| **接口地址** | `/api/public/team-milestones/date-range`         |
| **请求方法** | `GET`                                            |
| **是否鉴权** | 否（公开接口）                                   |
| **可用角色** | 所有人                                           |
| **功能描述** | 获取指定时间范围内的所有里程碑事件（供门户展示） |

**请求参数（Query）**

| 参数名 | 类型   | 必填 | 说明                         |
| ------ | ------ | ---- | ---------------------------- |
| start  | string | 是   | 开始日期（格式：YYYY-MM-DD） |
| end    | string | 是   | 结束日期（格式：YYYY-MM-DD） |

**业务逻辑说明**

- 按事件日期范围（BETWEEN start AND end）筛选里程碑
- 按事件日期正序排序（时间线顺序）
- 返回里程碑总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 2,
    "data": [
      {
        "milestone_id": 11,
        "term_id": 2,
        "title": "服务队正式成立",
        "description": "2023年9月，XX志愿者服务队正式注册成立",
        "event_date": "2023-09-01",
        "event_type": "成立",
        "image_url": "https://example.com/milestones/establish.jpg",
        "image_key": "milestones/establish.jpg",
        "created_by": "2020123456",
        "created_at": "2024-01-10T15:30:00.000Z"
      },
      {
        "milestone_id": 12,
        "term_id": 2,
        "title": "首次获得校级表彰",
        "description": "在2024年志愿服务评选中获得“优秀志愿团队”称号",
        "event_date": "2024-06-30",
        "event_type": "获奖",
        "image_url": "https://example.com/milestones/award.jpg",
        "image_key": "milestones/award.jpg",
        "created_by": "2020123456",
        "created_at": "2024-07-05T10:15:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message          | 说明                 |
| ------ | ---------------- | -------------------- |
| 400    | 事件日期格式错误 | start/end 格式不合法 |
| 500    | 内部服务器错误   | 数据库操作异常等     |

#### 9.17.5 获取所有里程碑（管理员）

| 项目         | 内容                                                 |
| ------------ | ---------------------------------------------------- |
| **接口地址** | `/api/team-milestones/list`                          |
| **请求方法** | `GET`                                                |
| **是否鉴权** | 是                                                   |
| **可用角色** | admin / superadmin                                   |
| **功能描述** | 获取系统中所有里程碑事件（关联届次信息，供后台管理） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**业务逻辑说明**

- 关联查询届次表（team_terms）获取届次名称
- 包含所有类型、所有届次的里程碑
- 按事件日期倒序排序（最新事件在前）
- 返回里程碑总条数和详细列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 3,
    "data": [
      {
        "milestone_id": 12,
        "term_id": 2,
        "term_name": "2023-2024届",
        "title": "首次获得校级表彰",
        "description": "在2024年志愿服务评选中获得“优秀志愿团队”称号",
        "event_date": "2024-06-30",
        "event_type": "获奖",
        "image_url": "https://example.com/milestones/award.jpg",
        "image_key": "milestones/award.jpg",
        "created_by": "2020123456",
        "created_at": "2024-07-05T10:15:00.000Z"
      },
      {
        "milestone_id": 11,
        "term_id": 2,
        "term_name": "2023-2024届",
        "title": "服务队正式成立",
        "description": "2023年9月，XX志愿者服务队正式注册成立",
        "event_date": "2023-09-01",
        "event_type": "成立",
        "image_url": "https://example.com/milestones/establish.jpg",
        "image_key": "milestones/establish.jpg",
        "created_by": "2020123456",
        "created_at": "2024-01-10T15:30:00.000Z"
      },
      {
        "milestone_id": 8,
        "term_id": 1,
        "term_name": "2022-2023届",
        "title": "前身社团成立",
        "description": "2022年3月，XX志愿社团成立（服务队前身）",
        "event_date": "2022-03-15",
        "event_type": "成立",
        "image_url": null,
        "image_key": null,
        "created_by": "2019123456",
        "created_at": "2023-01-20T14:00:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.17.6 更新里程碑事件（管理员）

| 项目         | 内容                                                  |
| ------------ | ----------------------------------------------------- |
| **接口地址** | `/api/team-milestones/update/:milestone_id`           |
| **请求方法** | `PUT`                                                 |
| **是否鉴权** | 是                                                    |
| **可用角色** | admin / superadmin                                    |
| **功能描述** | 更新里程碑事件信息（支持 OSS 图片替换，自动删除旧图） |

**请求头**

```makefile
Authorization: Bearer <token>
Content-Type: application/json
```

**参数说明**

| 参数名       | 位置 | 类型 | 必填 | 说明          |
| ------------ | ---- | ---- | ---- | ------------- |
| milestone_id | path | int  | 是   | 里程碑主键 ID |

**请求体说明**

所有字段均为 **可选**：

| 字段名      | 类型   | 说明                                  |
| ----------- | ------ | ------------------------------------- |
| title       | string | 里程碑标题                            |
| event_date  | date   | 事件日期（格式校验）                  |
| term_id     | number | 届次 ID                               |
| description | string | 事件描述                              |
| event_type  | string | 事件类型                              |
| image_url   | string | 新图片 URL（替换图片时必填）          |
| image_key   | string | 新图片 OSS 存储 key（替换图片时必填） |
| created_by  | string | 创建人（不可修改，自动填充）          |

**业务逻辑说明**

- 校验字段格式（`validateTeamMilestoneUpdate`）
- 检查里程碑是否存在
- 若替换图片（提供新的 image_key）：
  1. 校验必须同时提供新的 image_url
  2. 自动删除 OSS 中存储的旧图片文件
  3. 更新 image_url 和 image_key 字段
- 自动构建 SQL，更新请求体中出现的其他字段
- 返回更新成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "里程碑更新成功",
  "data": {
    "message": "里程碑更新成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message                                       | 说明                              |
| ------ | --------------------------------------------- | --------------------------------- |
| 400    | 没有可更新字段                                | 请求体为空                        |
| 400    | 替换图片时必须同时提供 image_url 和 image_key | 仅提供 image_key 未提供 image_url |
| 400    | 事件日期格式错误                              | event_date 格式不合法             |
| 401    | 未登录 / Token 失效                           | 未携带 Token 或 Token 无效        |
| 403    | 权限不足                                      | 非 admin/superadmin 角色访问      |
| 404    | 里程碑不存在                                  | milestone_id 无效                 |
| 500    | 内部服务器错误                                | 数据库操作或 OSS 文件删除异常等   |

#### 9.17.7 删除里程碑事件（管理员）

| 项目         | 内容                                            |
| ------------ | ----------------------------------------------- |
| **接口地址** | `/api/team-milestones/delete/:milestone_id`     |
| **请求方法** | `DELETE`                                        |
| **是否鉴权** | 是                                              |
| **可用角色** | admin / superadmin                              |
| **功能描述** | 删除指定里程碑事件（连带删除 OSS 中的图片文件） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名       | 位置 | 类型 | 必填 | 说明          |
| ------------ | ---- | ---- | ---- | ------------- |
| milestone_id | path | int  | 是   | 里程碑主键 ID |

**业务逻辑说明**

- 检查里程碑是否存在
- 从 OSS 中删除对应的图片文件（根据 image_key）
- 从数据库中删除里程碑记录
- 返回删除成功提示

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "里程碑删除成功",
  "data": {
    "message": "里程碑删除成功"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                            |
| ------ | ------------------- | ------------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效      |
| 403    | 权限不足            | 非 admin/superadmin 角色访问    |
| 404    | 里程碑不存在        | milestone_id 无效               |
| 500    | 内部服务器错误      | 数据库操作或 OSS 文件删除异常等 |

### 9.18 系统操作日志管理接口

系统操作日志管理接口用于记录和查询系统用户的操作行为，支持多条件筛选和分页查询，仅管理员和超级管理员可访问，用于系统审计和问题排查。

#### 9.18.1 分页查询操作日志（管理员）

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **接口地址** | `/api/operation-logs/list`                                   |
| **请求方法** | `GET`                                                        |
| **是否鉴权** | 是                                                           |
| **可用角色** | admin / superadmin                                           |
| **功能描述** | 分页查询系统操作日志（支持用户 ID、操作类型、时间范围多条件筛选） |

**请求头**

```makefile
Authorization: Bearer <token>
```

**请求参数（Query）**

| 字段名     | 类型   | 必填 | 说明                                                      |
| ---------- | ------ | ---- | --------------------------------------------------------- |
| page       | number | 否   | 页码（默认 1）                                            |
| pageSize   | number | 否   | 每页条数（默认 20）                                       |
| user_id    | string | 否   | 操作用户 ID（筛选指定用户的操作日志）                     |
| action     | string | 否   | 操作动作（筛选指定类型的操作，如：创建、更新、删除）      |
| start_date | string | 否   | 开始日期（格式：YYYY-MM-DD HH:MM:SS，筛选该时间后的日志） |
| end_date   | string | 否   | 结束日期（格式：YYYY-MM-DD HH:MM:SS，筛选该时间前的日志） |

**业务逻辑说明**

- 格式化分页参数（page 和 pageSize 自动转为数字，默认值分别为 1 和 20）
- 支持多条件组合筛选（用户 ID、操作动作、时间范围）
- 先查询符合条件的日志总数，再分页查询具体数据
- 按操作时间倒序排序（最新操作在前）
- 返回分页元数据和日志列表

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "total": 128,
    "page": 1,
    "pageSize": 20,
    "data": [
      {
        "log_id": 567,
        "user_id": "2020123456",
        "action": "创建",
        "target_table": "activities",
        "target_id": "5",
        "description": "创建志愿活动：社区环保志愿活动",
        "ip_address": "192.168.1.100",
        "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
        "created_at": "2024-06-18T14:30:00.000Z"
      },
      {
        "log_id": 566,
        "user_id": "2020123456",
        "action": "更新",
        "target_table": "backbone_members",
        "target_id": "10",
        "description": "更新骨干成员信息：职位改为部长",
        "ip_address": "192.168.1.100",
        "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
        "created_at": "2024-06-18T10:15:00.000Z"
      }
    ]
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 500    | 内部服务器错误      | 数据库操作异常等             |

#### 9.18.2 查看单条操作日志详情（管理员）

| 项目         | 内容                          |
| ------------ | ----------------------------- |
| **接口地址** | `/api/operation-logs/:log_id` |
| **请求方法** | `GET`                         |
| **是否鉴权** | 是                            |
| **可用角色** | admin / superadmin            |
| **功能描述** | 查询指定 ID 的操作日志详情    |

**请求头**

```makefile
Authorization: Bearer <token>
```

**参数说明**

| 参数名 | 位置 | 类型 | 必填 | 说明            |
| ------ | ---- | ---- | ---- | --------------- |
| log_id | path | int  | 是   | 操作日志主键 ID |

**业务逻辑说明**

- 校验 log_id 有效性（数字类型）
- 查询指定 ID 的操作日志
- 若日志不存在则返回 404
- 返回日志完整详情

**成功返回示例**

```json
{
  "code": 200,
  "success": true,
  "message": "Success",
  "data": {
    "log_id": 567,
    "user_id": "2020123456",
    "action": "创建",
    "target_table": "activities",
    "target_id": "5",
    "description": "创建志愿活动：社区环保志愿活动",
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
    "created_at": "2024-06-18T14:30:00.000Z"
  },
  "meta": {},
  "debug": {}
}
```

**失败响应示例**

| 状态码 | message             | 说明                         |
| ------ | ------------------- | ---------------------------- |
| 401    | 未登录 / Token 失效 | 未携带 Token 或 Token 无效   |
| 403    | 权限不足            | 非 admin/superadmin 角色访问 |
| 404    | 日志不存在          | log_id 无效                  |
| 500    | 内部服务器错误      | 数据库操作异常等             |

> 注：系统操作日志为只读数据，仅支持查询操作，不提供创建、更新、删除接口（日志由系统自动记录，无需手动操作）。



## 十、文档更新规范

| 操作           | 要求                           |
| -------------- | ------------------------------ |
| 修改数据库结构 | 必须同步更新 SQL 与文档字段表  |
| 新增接口       | 更新接口列表与参数说明         |
| 改动业务逻辑   | 在“更新记录”章节标明版本与日期 |
| 发布新版本     | 更新页眉版本号及时间           |



## 十一、更新记录

| 日期  | 版本 | 更新内容                                                     | 负责人 |
| ----- | ---- | ------------------------------------------------------------ | ------ |
| 11.22 | v1.0 | 完成后端第一版全量建设：包括数据库结构设计、全模块接口设计与实现、接口校验与权限控制、单元及接口测试完成、以及整体 API 文档初版编写。 | Eastyn |
|       |      |                                                              |        |



# 大改：

取消了原本的Policy直传，改为现在sts直传

添加报名加入服务队的功能接口

## 志愿服务队「终身制」纳新 + 换届竞选系统设计文档（简洁可落地版）

### 1. 核心理念  
**一张表、两种模式、终身复用**  
所有新生纳新、内部换届竞选、队长/部长竞选全部走同一张表 `team_recruitment`，只通过 3 个字段决定行为差异：

```text
year                → 2025 表示 2025-2026 学年
recruitment_type    → new_student（新生纳新） / internal_election（内部换届竞选）
interview_rounds    → 2（两轮面试） / 1（只一轮面试）
```

以后每年永远不用再建新表、不用改代码、不用写两套页面。

### 2. 完整数据库表结构（直接执行即可）

```sql
CREATE TABLE `team_recruitment` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `year` smallint NOT NULL COMMENT '届别，如 2025 表示 2025-2026 学年',

  -- 关键控制字段（决定这条记录是新生纳新还是换届竞选）
  `recruitment_type` enum('new_student','internal_election') NOT NULL COMMENT '报名类型：new_student=新生纳新，internal_election=内部换届竞选',
  `interview_rounds` tinyint(1) NOT NULL DEFAULT 2 COMMENT '需要几轮面试：2=新生走两轮，1=换届只走一轮',

  -- 基础信息
  `student_id` varchar(20) NOT NULL COMMENT '学号',
  `name` varchar(20) NOT NULL COMMENT '姓名',
  `gender` enum('男','女','其他') NOT NULL COMMENT '性别',
  `college` varchar(50) NOT NULL COMMENT '学院',
  `major` varchar(50) NOT NULL COMMENT '专业',
  `grade` varchar(20) NOT NULL COMMENT '年级，如：2024级',
  `phone` varchar(20) NOT NULL COMMENT '联系电话',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `qq` varchar(20) DEFAULT NULL COMMENT 'QQ（选填）',
  `dormitory` varchar(50) DEFAULT NULL COMMENT '宿舍（新生建议必填）',

  -- 志愿或竞选目标
  `intention_dept1` varchar(50) NOT NULL COMMENT '新生=第一志愿部门；换届=竞选部长/队长部门',
  `intention_dept2` varchar(50) DEFAULT NULL COMMENT '新生=第二志愿；换届一般为空',

  -- 换届竞选专属字段（新生报名时留空）
  `current_position` varchar(30) DEFAULT NULL COMMENT '换届专用：当前职务，如“外联部副部长”',
  `election_position` varchar(30) DEFAULT NULL COMMENT '换届专用：竞选目标职务，如“队长”“宣传部部长”',
  `work_plan` text DEFAULT NULL COMMENT '换届专用：未来一年工作计划（必填）',

  -- 通用文书
  `self_intro` text DEFAULT NULL COMMENT '自我介绍',
  `past_experience` text DEFAULT NULL COMMENT '过往经历/在队贡献',
  `reason_for_joining` text DEFAULT NULL COMMENT '新生=加入动机；换届=竞选理由与优势',
  `skill_tags` varchar(255) DEFAULT NULL COMMENT '技能标签 JSON 数组，如：["摄影","PS","主持"]',

  -- 统一状态机（新生与换届共用一套状态）
  `status` enum(
    'pending_review',
    'interview1_passed',
    'interview1_failed',
    'interview2_passed',
    'interview2_failed',
    'pending_assignment',
    'assigned',
    'rejected'
  ) DEFAULT 'pending_review' COMMENT '当前流程状态',

  -- 最终结果
  `final_department` varchar(50) DEFAULT NULL COMMENT '最终去向部门',
  `final_position` varchar(30) DEFAULT NULL COMMENT '最终职务：队长/部长/副部长/干事/队员',

  -- 操作记录
  `reviewed_by_stage1` int DEFAULT NULL COMMENT '一轮面试审核人 auth_id',
  `review_remark_stage1` varchar(255) DEFAULT NULL COMMENT '一轮备注/淘汰原因',
  `reviewed_by_stage2` int DEFAULT NULL COMMENT '二轮面试审核人 auth_id（仅新生使用）',
  `review_remark_stage2` varchar(255) DEFAULT NULL COMMENT '二轮备注/淘汰原因',
  `assigned_by` int DEFAULT NULL COMMENT '最终任命/分配操作人 auth_id',

  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '报名提交时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_year_student` (`year`, `student_id`),
  KEY `idx_year` (`year`),
  KEY `idx_year_type` (`year`, `recruitment_type`),
  KEY `idx_year_status` (`year`, `status`),
  KEY `idx_final_dept` (`final_department`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='志愿服务队报名表：新生纳新 + 内部换届竞选二合一';
```

**status 状态枚举值说明**（共用一套状态机）：

| 状态值             | 含义                          |
| ------------------ | ----------------------------- |
| pending_review     | 刚提交，待审核                |
| interview1_passed  | 一轮面试通过（换届到此结束）  |
| interview1_failed  | 一轮面试未通过                |
| interview2_passed  | 二轮面试通过（仅新生使用）    |
| interview2_failed  | 二轮面试未通过                |
| pending_assignment | 待任命部长/队长 或 待分配部门 |
| assigned           | 已任命/已录取，正式入队       |
| rejected           | 已拒绝                        |

### 3. 每年只需要做的两件事（管理员操作）

| 时间      | 操作                                  | 系统行为                                               |
| --------- | ------------------------------------- | ------------------------------------------------------ |
| 每学年6月 | 后台开启「2025 内部换届竞选」报名开关 | recruitment_type=internal_election，interview_rounds=1 |
| 每学年9月 | 后台开启「2025 新生纳新」报名开关     | recruitment_type=new_student，interview_rounds=2       |

之后所有审核、面试、任命流程全部共用同一套页面和接口。

### 4. 状态流转一览表（自动适配）

| 报名类型     | 实际走的流程                                                 | 管理员看到的操作按钮           |
| ------------ | ------------------------------------------------------------ | ------------------------------ |
| 新生纳新     | pending_review → interview1_passed → interview2_passed → pending_assignment → assigned | 初试通过 → 复试通过 → 分配部门 |
| 内部换届竞选 | pending_review → interview1_passed → pending_assignment → assigned | 面试通过（直接任命） → 拒绝    |

后端只需在审核接口里加一行判断 `interview_rounds` 即可自动跳过复试阶段。

至此，你已经拥有一个真正能用 10 年不坏的「志愿队人事系统」了  
后续要做的只剩下一个开关配置表（recruitment_seasons）和几个极简接口即可，随时要我继续补。





服务层

~~~ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import {
  TeamRecruitmentWritable,
  TeamRecruitmentWritableFields,
  TeamRecruitmentRecord,
} from '../types/dbTypes';
import { getCurrentSeason } from './recruitmentSeasonsService';

/** 用户提交报名 */
export const submitApply = async (
  studentId: string,
  // 使用更严格的创建负载类型：前端必须传入必填字段，后端自动填充 year/recruitment_type 等
  body: Omit<
    TeamRecruitmentWritable,
    | 'year'
    | 'interview_rounds'
    | 'student_id'
    | 'status'
    | 'final_department'
    | 'final_position'
    | 'reviewed_by_stage1'
    | 'review_remark_stage1'
    | 'reviewed_by_stage2'
    | 'review_remark_stage2'
    | 'assigned_by'
  >
) => {
  // 1. 校验当前报名通道
  const season = await getCurrentSeason();
  if (!season) {
    throw { status: HTTP_STATUS.FORBIDDEN, message: '当前无开放报名通道' };
  }
  if (body.recruitment_type && body.recruitment_type !== season.type) {
    throw {
      status: HTTP_STATUS.FORBIDDEN,
      message: `当前仅开放${season.type === 'new_student' ? '新生纳新' : '换届竞选'}`,
    };
  }

  // 2. 防止已是正式成员
  const [isMember] = await query<any[]>('SELECT 1 FROM backbone_members WHERE student_id = ? LIMIT 1', [studentId]);
  if (isMember) {
    throw { status: HTTP_STATUS.FORBIDDEN, message: '您已是志愿队成员，无需报名' };
  }

  // 3. 防止重复报名
  const [exist] = await query<any[]>(
    `SELECT 1 FROM team_recruitment WHERE year = ? AND student_id = ?`,
    [season.year, studentId]
  );
  if (exist) {
    throw { status: HTTP_STATUS.CONFLICT, message: '您已提交过本年度报名' };
  }

  // 4. 换届必填字段校验（前端已控，这里再保险）
  if (season.type === 'internal_election') {
    if (!body.current_position?.trim() || !body.election_position?.trim() || !body.work_plan?.trim()) {
      throw {
        status: HTTP_STATUS.BAD_REQUEST,
        message: '换届竞选需填写当前职务、竞选职务和工作计划',
      };
    }
  }

  // 公共必填字段校验（前端应当保证，但后端再次校验以避免数据库写入 null）
  const requiredFieldsForAll = [
    'name',
    'gender',
    'college',
    'major',
    'grade',
    'phone',
    'email',
    'intention_dept1',
  ];

  for (const f of requiredFieldsForAll) {
    const val = (body as any)[f];
    if (val === undefined || val === null || (typeof val === 'string' && val.trim() === '')) {
      throw { status: HTTP_STATUS.BAD_REQUEST, message: `${f} 为必填项` };
    }
  }

  // 5. 自动填充必要字段 + 构建可写数据
  const data: TeamRecruitmentWritable = {
    year: season.year,
    recruitment_type: season.type,
    interview_rounds: season.type === 'internal_election' ? 1 : 2,
    student_id: studentId,

    name: body.name,
    gender: body.gender,
    college: body.college,
    major: body.major,
    grade: body.grade,
    phone: body.phone,
    email: body.email,
    qq: body.qq ?? null,
    dormitory: body.dormitory ?? null,

    intention_dept1: body.intention_dept1,
    intention_dept2: body.intention_dept2 ?? null,
    current_position: body.current_position ?? null,
    election_position: body.election_position ?? null,
    work_plan: body.work_plan ?? null,

    self_intro: body.self_intro ?? null,
    past_experience: body.past_experience ?? null,
    reason_for_joining: body.reason_for_joining ?? null,
    skill_tags: body.skill_tags ? JSON.stringify(body.skill_tags) : null,

    // 初始状态
    status: 'pending_review',
    final_department: null,
    final_position: null,
    reviewed_by_stage1: null,
    review_remark_stage1: null,
    reviewed_by_stage2: null,
    review_remark_stage2: null,
    assigned_by: null,
  };

  // 自动构建 SQL
  const fields = TeamRecruitmentWritableFields;

  const values = fields.map(f => ((data as any)[f] ?? null));
  const placeholders = fields.map(() => '?').join(', ');

  const sql = `INSERT INTO team_recruitment (${fields.join(', ')}) VALUES (${placeholders})`;

  await query(sql, values);

  return { message: '报名提交成功，请耐心等待审核' };
};

/** 超级管理员获取所有的分页列表 */
export const getAdminList = async (query: any) => {
  const {
    year,
    type,
    status,
    page = 1,
    pageSize = 20,
    search,
  } = query;

  const currentSeason = await getCurrentSeason();
  const targetYear = year || currentSeason?.year;
  if (!targetYear) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '请指定年份或当前无开放报名' };
  }

  let sql = `SELECT 
               r.*,
               i.avatar_key,
               i.join_date
             FROM team_recruitment r
             LEFT JOIN auth_info i ON r.student_id = i.student_id
             WHERE r.year = ?`;
  const params: any[] = [targetYear];

  if (type) { sql += ' AND r.recruitment_type = ?'; params.push(type); }
  if (status) { sql += ' AND r.status = ?'; params.push(status); }
  if (search) {
    sql += ' AND (r.student_id LIKE ? OR r.name LIKE ?)';
    params.push(`%${search}%`, `%${search}%`);
  }

  // 总数
  const countSql = `SELECT COUNT(*) as total FROM team_recruitment WHERE year = ?`;
  const [{ total }] = await query(countSql, [targetYear]) as any[];

  // 数据 + 分页
  sql += ' ORDER BY r.created_at DESC LIMIT ? OFFSET ?';
  params.push(Number(pageSize), (Number(page) - 1) * Number(pageSize));

  const list = await query(sql, params) as TeamRecruitmentRecord[];

  return {
    list,
    pagination: {
      page: Number(page),
      pageSize: Number(pageSize),
      total,
    },
    year: targetYear,
  };
};

/** 审核面试结果（保持简洁） */
export const reviewStage = async (adminId: number, body: any) => {
  const { year, student_ids, stage, pass, remark } = body;

  const targetStatus = pass
    ? stage === '1' ? 'interview1_passed' : 'interview2_passed'
    : stage === '1' ? 'interview1_failed' : 'interview2_failed';

  const reviewerField = stage === '1' ? 'reviewed_by_stage1' : 'reviewed_by_stage2';
  const remarkField = stage === '1' ? 'review_remark_stage1' : 'review_remark_stage2';

  await query(
    `UPDATE team_recruitment
     SET status = ?, ${reviewerField} = ?, ${remarkField} = ?, updated_at = NOW()
     WHERE year = ? AND student_id IN (?)`,
    [targetStatus, adminId, remark || null, year, student_ids]
  );

  // 换届一轮通过直接待任命
  if (pass && stage === '1') {
    await query(
      `UPDATE team_recruitment SET status = 'pending_assignment'
       WHERE year = ? AND student_id IN (?) AND interview_rounds = 1`,
      [year, student_ids]
    );
  }

  // 新生复试通过 → 待分配
  if (pass && stage === '2') {
    await query(
      `UPDATE team_recruitment SET status = 'pending_assignment'
       WHERE year = ? AND student_id IN (?)`,
      [year, student_ids]
    );
  }

  return { message: `成功${pass ? '通过' : '淘汰'}${student_ids.length}人` };
};

/** 最终任命/分配部门 */
export const assignFinal = async (adminId: number, body: any) => {
  const { year, student_ids, department, position = '队员' } = body;

  await query('START TRANSACTION');
  try {
    await query(
      `UPDATE team_recruitment
       SET status = 'assigned',
           final_department = ?,
           final_position = ?,
           assigned_by = ?
       WHERE year = ? AND student_id IN (?) AND status = 'pending_assignment'`,
      [department, position, adminId, year, student_ids]
    );

    for (const sid of student_ids) {
      const [info] = await query<any[]>('SELECT name FROM auth_info WHERE student_id = ?', [sid]);
      if (!info) continue;

      await query(
        `INSERT IGNORE INTO backbone_members
         (student_id, name, department_id, position, term_start)
         VALUES (?, ?, (SELECT id FROM departments WHERE name = ?), ?, CURDATE())`,
        [sid, info.name, department, position]
      );

      await query(`UPDATE auth_info SET join_date = CURDATE() WHERE student_id = ?`, [sid]);
    }

    await query('COMMIT');
    return { message: `成功任命/录取 ${student_ids.length} 人至 ${department}` };
  } catch (err) {
    await query('ROLLBACK');
    throw { status: HTTP_STATUS.INTERNAL_ERROR, message: '操作失败' };
  }
};

/** 获取某部门管理员负责部门下的所有报名 */
export const getDepartmentApplicants = async (adminStudentId: string, year?: number) => {
  const currentSeason = await getCurrentSeason();
  const targetYear = year || currentSeason?.year;
  if (!targetYear) {
    throw { status: HTTP_STATUS.BAD_REQUEST, message: '请指定年份或当前无开放报名' };
  }

  // 找到该管理员负责的部门（manager_id 或 leader_id）
  const deps = await query(`SELECT dept_name FROM departments WHERE manager_id = ? OR leader_id = ?`, [adminStudentId, adminStudentId]) as { dept_name: string }[];
  if (!deps || deps.length === 0) {
    return { list: [], year: targetYear };
  }

  const deptNames = deps.map(d => d.dept_name);

  const sql = `SELECT r.*, i.avatar_key, i.join_date
               FROM team_recruitment r
               LEFT JOIN auth_info i ON r.student_id = i.student_id
               WHERE r.year = ? AND r.intention_dept1 IN (?)
               ORDER BY r.created_at DESC`;

  const rows = await query(sql, [targetYear, deptNames]) as TeamRecruitmentRecord[];
  return { list: rows, year: targetYear };
};
~~~



控制层

~~~ts
import { Request, Response } from 'express';
import { submitApply, getAdminList, reviewStage, assignFinal } from '../services/recruitmentService';
import { getDepartmentApplicants } from '../services/recruitmentService';
import { successResponse, errorResponse, HTTP_STATUS } from '../utils/response';
import { query } from '../db';

/** 学生提交报名 */
export const submitApplyController = async (req: Request, res: Response) => {
  try {
    const user = (req as any).user;
    if (!user || !user.student_id) {
      errorResponse(res, '未识别的用户身份', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    const result = await submitApply(user.student_id, req.body);
    successResponse(res, result, '报名提交成功', HTTP_STATUS.CREATED);
  } catch (error: any) {
    errorResponse(res, error.message || '提交失败', error.status || undefined, error);
  }
};

/** 分页查询报名列表 */
export const getAdminListController = async (req: Request, res: Response) => {
  try {
    const result = await getAdminList(req.query);
    successResponse(res, result, '查询成功');
  } catch (error: any) {
    errorResponse(res, error.message || '查询失败', error.status || undefined, error);
  }
};

/** 部门管理员查看本部门所有报名 */
export const getDepartmentApplicantsController = async (req: Request, res: Response) => {
  try {
    const user = (req as any).user;
    if (!user || !user.student_id) {
      errorResponse(res, '未识别的用户身份', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    const studentId = user.student_id as string;
    const result = await getDepartmentApplicants(studentId, req.query.year as any);
    successResponse(res, result, '查询成功');
  } catch (error: any) {
    errorResponse(res, error.message || '查询失败', error.status || undefined, error);
  }
};

/** 审核面试结果 */
export const reviewStageController = async (req: Request, res: Response) => {
  try {
    const studentId = (req as any).user?.student_id;
    if (!studentId) {
      errorResponse(res, '身份信息缺失', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    // 将 student_id 转换为 auth_id（数据库中的主键）
    const [row] = await query(`SELECT auth_id FROM auth_login WHERE student_id = ? LIMIT 1`, [studentId]) as any[];
    const adminId = row?.auth_id;
    if (!adminId) {
      errorResponse(res, '管理员账号不存在或未同步', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    const result = await reviewStage(adminId, req.body);
    successResponse(res, result, '审核完成');
  } catch (error: any) {
    errorResponse(res, error.message || '审核失败', error.status || undefined, error);
  }
};

/** 最终任命/分配部门 */
export const assignFinalController = async (req: Request, res: Response) => {
  try {
    const studentId = (req as any).user?.student_id;
    if (!studentId) {
      errorResponse(res, '身份信息缺失', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    // 将 student_id 转换为 auth_id（数据库中的主键）
    const [row] = await query(`SELECT auth_id FROM auth_login WHERE student_id = ? LIMIT 1`, [studentId]) as any[];
    const adminId = row?.auth_id;
    if (!adminId) {
      errorResponse(res, '管理员账号不存在或未同步', HTTP_STATUS.UNAUTHORIZED);
      return;
    }

    const result = await assignFinal(adminId, req.body);
    successResponse(res, result, '任命/分配完成');
  } catch (error: any) {
    errorResponse(res, error.message || '操作失败', error.status || undefined, error);
  }
};

export default {
  submitApplyController,
  getAdminListController,
  reviewStageController,
  assignFinalController,
};
~~~



路由层

~~~ts
import express from 'express';
import {
  submitApplyController,
  getAdminListController,
  reviewStageController,
  assignFinalController,
  getDepartmentApplicantsController,
} from '../controllers/teamRecruitmentController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateRecruitmentApply, validateReviewStage, validateAssignDept } from '../validators/validateRequest';

const router = express.Router();

// 学生提交报名
router.post('/create', validateRecruitmentApply, submitApplyController);

// 分页查询报名列表（超级管理员专用）
router.get('/list', authorizeRole('admin', 'superadmin'), getAdminListController);

// 部门管理员查看本部门所有报名
router.get('/department-applicants', authorizeRole('admin'), getDepartmentApplicantsController);

// 审核面试结果（批量）
router.post('/review', authorizeRole('admin', 'superadmin'), validateReviewStage, reviewStageController);

// 最终任命/分配
router.post('/assign', authorizeRole('admin', 'superadmin'), validateAssignDept, assignFinalController);

export default router;
~~~



校验层

~~~ts
// ---------------------------
// 用户提交报名校验（新生纳新 + 换届竞选通用）
// ---------------------------
export const RecruitmentApplySchema: Record<string, FieldRule> = {
  type: {
    required: true,
    type: "enum",
    enumValues: ["new_student", "internal_election"],
    message: "type 必须为 new_student 或 internal_election",
  },
  intention_dept1: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.trim().length > 0,
    message: "第一志愿/竞选部门不能为空且必须为字符串",
  },
  intention_dept2: {
    validator: (v: unknown) => v === null || v === undefined || (typeof v === "string" && v.trim().length >= 0),
    message: "第二志愿必须为字符串（可为空）",
  },
  self_intro: {
    required: true,
    validator: (v: unknown) => v === null || v === undefined || typeof v === "string",
    message: "自我介绍不能为空且必须为字符串",
  },
  past_experience: {
    validator: (v: unknown) => v === null || v === undefined || typeof v === "string",
    message: "过往经历必须为字符串",
  },
  reason_for_joining: {
    required: true,
    validator: (v: unknown) =>
      typeof v === "string" && v.trim().length >= 50 && v.trim().length <= 2000,
    message: "加入动机/竞选理由必须为字符串且50-2000字",
  },
  skill_tags: {
    required: false,
    validator: (v: unknown) =>
      !v ||
      (Array.isArray(v) &&
        v.every((tag) => typeof tag === "string" && tag.trim().length > 0)),
    message: "skill_tags 必须为字符串数组且每一项不能为空",
  },

  // 换届竞选专属字段（后端再加一层保险，前端已控制必填）
  current_position: {
    validator: (v: unknown) =>
      v === null || v === undefined || (typeof v === "string" && v.trim().length > 0),
    message: "当前职务必须为字符串",
  },
  election_position: {
    validator: (v: unknown) =>
      v === null || v === undefined || (typeof v === "string" && v.trim().length > 0),
    message: "竞选目标职务必须为字符串",
  },
  work_plan: {
    required: false,
    validator: (v: unknown) =>
      v === null || v === undefined || (typeof v === "string" && v.trim().length >= 100),
    message: "工作计划必须为字符串且不少于100字",
  },
};

// ---------------------------
// 管理员审核/操作通用校验
// ---------------------------
const AdminOperationSchema: Record<string, FieldRule> = {
  year: {
    required: true,
    validator: (v: unknown) => /^\d{4}$/.test(String(v)),
    message: "年份格式错误",
  },
  student_ids: {
    required: true,
    validator: (v: unknown) => Array.isArray(v) && v.length > 0 && v.every(id => typeof id === "string"),
    message: "student_ids 必须为非空字符串数组",
  },
};

export const ReviewStageSchema: Record<string, FieldRule> = {
  ...AdminOperationSchema,
  stage: {
    required: true,
    type: "enum",
    enumValues: ["1", "2"],
    message: "stage 必须为 1 或 2",
  },
  pass: {
    required: true,
    validator: (v: unknown) => typeof v === "boolean",
    message: "pass 必须为 true 或 false",
  },
  remark: {
    type: "string",
    message: "type 必须为字符串或 null"
  },
};

export const AssignDeptSchema: Record<string, FieldRule> = {
  ...AdminOperationSchema,
  department: {
    required: true,
    message: "必须选择最终部门"
  },
  position: {
    type: "string",
    message: "type 必须为字符串或 null"
  },
};
~~~



~~~ts
/* ---------------------------
 * Recruitment
 * --------------------------- */
export const validateRecruitmentApply = createValidator(RecruitmentApplySchema, "create");
export const validateReviewStage = createValidator(ReviewStageSchema, "create");
export const validateAssignDept = createValidator(AssignDeptSchema, "create");
~~~











太对了！  
**彻底工业级做法就是：两张表完美配合**，互不干扰，职责清晰：

| 表名                  | 职责                             | 是否每年新增数据 |
| --------------------- | -------------------------------- | ---------------- |
| `team_recruitment`    | 存储所有历史报名记录（终身不删） | 每年新增几百条   |
| `recruitment_seasons` | 控制“今年可以报什么名”（开关表） | 每年最多加 2 条  |

下面我一次性给你把 `recruitment_seasons` 的 **完整功能**（建表 + 类型 + 校验 + 服务层 + 控制层 + 路由）全部写完，直接粘进去就能用，完全延续你项目风格。

### 1. 建表语句（只需执行一次）

```sql
CREATE TABLE `recruitment_seasons` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `year` smallint NOT NULL COMMENT '届别，如 2025',
  `type` enum('new_student','internal_election') NOT NULL COMMENT '报名类型',
  `is_open` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否开启报名：1=开启，0=关闭',
  `title` varchar(100) NOT NULL COMMENT '前端显示标题，如“2025级新生纳新”',
  `start_time` datetime DEFAULT NULL COMMENT '报名开始时间（可选）',
  `end_time` datetime DEFAULT NULL COMMENT '报名结束时间（可选）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_year_type` (`year`,`type`),
  KEY `idx_is_open` (`is_open`),
  KEY `idx_year` (`year`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='纳新年度开关表（控制每年开启哪种报名）';
```

### 2. types/dbTypes.ts（追加）

```ts
// =============================================
// recruitment_seasons —— 纳新年度开关表
// =============================================

export interface RecruitmentSeasonRecord {
  id: number;
  year: number;
  type: RecruitmentType;
  is_open: 0 | 1;
  title: string;
  start_time: string | null;
  end_time: string | null;
  created_at: string;
  updated_at: string;
}

export type RecruitmentSeasonWritable = Omit<
  RecruitmentSeasonRecord,
  'id' | 'created_at' | 'updated_at'
>;

export const RecruitmentSeasonWritableFields: (keyof RecruitmentSeasonWritable)[] = [
  'year',
  'type',
  'is_open',
  'title',
  'start_time',
  'end_time',
];
```

### 3. validators/validateSchemas.ts（新增）

```ts
// ---------------------------
// 开启/关闭报名通道校验
// ---------------------------
export const SeasonControlSchema: Record<string, FieldRule> = {
  year: {
    required: true,
    validator: (v: unknown) => typeof v === "number" && v >= 2025,
    message: "年份必须为有效数字（如2025）",
  },
  type: {
    required: true,
    type: "enum",
    enumValues: ["new_student", "internal_election"],
    message: "type 必须为 new_student 或 internal_election",
  },
  title: {
    required: true,
    validator: (v: unknown) => typeof v === "string" && v.length >= 4 && v.length <= 100,
    message: "标题长度4-100字符",
  },
  start_time: {
    required: false,
    validator: (v: unknown) => !v || typeof v === "string",
    message: "开始时间格式错误",
  },
  end_time: {
    required: false,
    validator: (v: unknown) => !v || typeof v === "string",
    message: "结束时间格式错误",
  },
};
```



~~~TS
/* ---------------------------
 * SeasonControl
 * --------------------------- */
export const validateSeasonControl = createValidator(SeasonControlSchema, "create");
~~~





### 4. validators/validateRequest.ts

```ts
export const validateSeasonControl = createValidator(SeasonControlSchema, "create");
```

### 5. services/recruitmentSeasonService.ts（新建）

```ts
import { query } from '../db';
import { HTTP_STATUS } from '../utils/response';
import { RecruitmentSeasonRecord, RecruitmentType } from '../types/dbTypes';

/** 获取当前开启的报名通道（优先返回换届） */
export const getCurrentSeason = async (): Promise<RecruitmentSeasonRecord | null> => {
  const [row] = await query<RecruitmentSeasonRecord[]>(
    `SELECT * FROM recruitment_seasons 
     WHERE is_open = 1 
     ORDER BY FIELD(type, 'internal_election', 'new_student'), year DESC 
     LIMIT 1`
  );
  return row || null;
};

/** 获取所有通道列表（管理端用） */
export const getSeasonList = async () => {
  const list = await query<RecruitmentSeasonRecord[]>(
    'SELECT * FROM recruitment_seasons ORDER BY year DESC, type'
  );
  return { list };
};

/** 开启报名通道 */
export const openSeason = async (body: any) => {
  const { year, type, title, start_time, end_time } = body;

  await query(
    `INSERT INTO recruitment_seasons 
     (year, type, is_open, title, start_time, end_time)
     VALUES (?, ?, 1, ?, ?, ?)
     ON DUPLICATE KEY UPDATE 
       is_open = 1, title = VALUES(title), start_time = VALUES(start_time), end_time = VALUES(end_time)`,
    [year, type, title, start_time || null, end_time || null]
  );

  return { message: `已开启 ${title}` };
};

/** 关闭所有通道（一键关闭） */
export const closeAllSeasons = async () => {
  await query('UPDATE recruitment_seasons SET is_open = 0');
  return { message: '已关闭所有报名通道' };
};

/** 关闭指定通道 */
export const closeSeason = async (year: number, type: string) => {
  await query(
    'UPDATE recruitment_seasons SET is_open = 0 WHERE year = ? AND type = ?',
    [year, type]
  );
  return { message: '已关闭该报名通道' };
};

/** 删除某个报名通道（仅在关闭状态下可删，用于清理错误配置） */
export const deleteSeason = async (year: number, type: RecruitmentType) => {
  const [exist] = await query<any[]>(
    'SELECT id, is_open FROM recruitment_seasons WHERE year = ? AND type = ?',
    [year, type]
  );

  if (!exist) {
    throw {
      status: HTTP_STATUS.NOT_FOUND,
      message: '该报名通道不存在'
    };
  }

  if (exist.is_open === 1) {
    throw {
      status: HTTP_STATUS.BAD_REQUEST,
      message: '请先关闭该报名通道后再删除'
    };
  }

  await query(
    'DELETE FROM recruitment_seasons WHERE year = ? AND type = ?',
    [year, type]
  );

  return {
    message: `已删除 ${year} 年 ${type === 'new_student' ? '新生纳新' : '换届竞选'} 配置`
  };
};
```

### 6. controllers/recruitmentSeasonController.ts

```ts
import { Request, Response } from 'express';
import {
  getCurrentSeason,
  getSeasonList,
  openSeason,
  closeAllSeasons,
  closeSeason,
  deleteSeason,
} from '../services/recruitmentSeasonService';
import { RecruitmentType } from '../types/dbTypes';
import { successResponse, errorResponse } from '../utils/response';

/** 用户端：获取当前可报名的通道 */
export const getCurrentController = async (req: Request, res: Response) => {
  try {
    const season = await getCurrentSeason();
    successResponse(res, { season });
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 管理端：列表 + 开关操作 */
export const listController = async (req: Request, res: Response) => {
  try {
    const data = await getSeasonList();
    successResponse(res, data);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 管理端：开启新一季报名 */
export const openController = async (req: Request, res: Response) => {
  try {
    const result = await openSeason(req.body);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 管理端：关闭报名通道 */
export const closeAllController = async (req: Request, res: Response) => {
  try {
    const result = await closeAllSeasons();
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 管理端：关闭指定报名通道 */
export const closeOneController = async (req: Request, res: Response) => {
  try {
    const { year, type } = req.body;
    const result = await closeSeason(year, type);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message, err.status);
  }
};

/** 管理端：删除指定报名通道 */
export const deleteController = async (req: Request, res: Response) => {
  try {
    const { year, type } = req.body;
    if (!year || !type) {
      throw { status: 400, message: 'year 和 type 必填' };
    }
    const result = await deleteSeason(Number(year), type as RecruitmentType);
    successResponse(res, result);
  } catch (err: any) {
    errorResponse(res, err.message || '删除失败', err.status || 500);
  }
};
```

### 7. 路由层

```ts
import express from 'express';
import {
  getCurrentController,
  listController,
  openController,
  closeAllController,
  closeOneController,
  deleteController,
} from '../controllers/recruitmentSeasonsController';
import { authorizeRole } from '../middlewares/authMiddleware';
import { validateSeasonControl } from '../validators/validateRequest';

const router = express.Router();

// 用户端：获取当前可报名的通道
router.get('/current', getCurrentController);

// 管理端：获取所有列表
router.get('/list', authorizeRole('admin', 'superadmin'), listController);

// 开启新一季报名
router.post('/open', authorizeRole('admin', 'superadmin'), validateSeasonControl, openController);

// 关闭所有报名通道
router.post('/close-all', authorizeRole('admin', 'superadmin'), closeAllController);

// 关闭指定报名通道
router.post('/close', authorizeRole('admin', 'superadmin'), closeOneController);

// 删除报名通道（用于清理错误配置）
router.post('/delete', authorizeRole('admin', 'superadmin'), deleteController);

export default router;
```

至此，`recruitment_seasons` 功能全部完成！

接下来我马上把 `team_recruitment` 的服务层改造成 **完全依赖这张开关表** 的版本，再也不写死年份了。

要不要我现在就把改造后的 `recruitmentService.ts` 发给你？3 分钟搞定。













添加获取验证码列表

Service

~~~ts
/** 管理员：获取所有验证码列表（支持分页、按邮箱/类型/验证状态过滤） */
export const getAllVerificationCodesService = async (
  options: {
    page?: number;
    pageSize?: number;
    email?: string;
    type?: string;
    verified?: number | string;
  } = {}
): Promise<{ data: EmailVerificationCodeRecord[]; total: number; page: number; pageSize: number }> => {
  const page = Math.max(1, Number(options.page) || 1);
  const pageSize = Math.max(1, Number(options.pageSize) || 20);

  const whereClauses: string[] = [];
  const params: any[] = [];

  if (options.email) {
    whereClauses.push('email LIKE ?');
    params.push(`%${options.email}%`);
  }

  if (options.type) {
    whereClauses.push('type = ?');
    params.push(options.type);
  }

  if (options.verified !== undefined && options.verified !== null && options.verified !== '') {
    whereClauses.push('verified = ?');
    params.push(Number(options.verified));
  }

  const whereSql = whereClauses.length ? `WHERE ${whereClauses.join(' AND ')}` : '';

  // 总数查询（复制 params 用于计数查询）
  const countParams = [...params];
  const countSql = `SELECT COUNT(*) as total FROM email_verification_codes ${whereSql}`;
  const countRows: any = await query(countSql, countParams);
  const total = Number(countRows?.[0]?.total ?? 0);

  const offset = (page - 1) * pageSize;
  const listSql = `
    SELECT *
    FROM email_verification_codes
    ${whereSql}
    ORDER BY created_at DESC
    LIMIT ? OFFSET ?
  `;

  const listParams = [...params, pageSize, offset];
  const rows: EmailVerificationCodeRecord[] = await query(listSql, listParams);

  return { data: rows, total, page, pageSize };
};
~~~

Controller

~~~ts
/** 管理员：获取验证码列表 */
export const getAllVerificationCodesController = async (req: Request, res: Response): Promise<void> => {
  try {
    const page = req.query.page ? Number(req.query.page) : 1;
    const pageSize = req.query.pageSize ? Number(req.query.pageSize) : 20;
    const email = req.query.email ? String(req.query.email) : undefined;
    const type = req.query.type ? String(req.query.type) : undefined;
    const verifiedRaw = req.query.verified as string | string[] | undefined;
    const verified = typeof verifiedRaw === 'undefined' ? undefined : Array.isArray(verifiedRaw) ? verifiedRaw[0] : verifiedRaw;

    const result = await getAllVerificationCodesService({ page, pageSize, email, type, verified });

    successResponse(res, result, '查询成功');
  } catch (error: any) {
    console.error('❌ 获取验证码列表失败:', error.message);
    errorResponse(res, '获取失败，请稍后再试', HTTP_STATUS.INTERNAL_ERROR);
  }
};
~~~

Router（api/email/list)

~~~ts
// 获取验证码列表（分页/筛选）
router.get('/list', authorizeRole('admin', 'superadmin'), getAllVerificationCodesController);
~~~

